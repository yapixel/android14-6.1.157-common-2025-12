name: Build GKI Kernel 6.1.145

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
          - sukisu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        default: true
        type: boolean
      debug:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
      build_start_time: ${{ steps.timestamp.outputs.start_time }}
      create_release: ${{ steps.config.outputs.create_release }}
      workflow_timestamp: ${{ steps.timestamp.outputs.workflow_timestamp }}
    
    steps:
      - name: Record Build Start Time
        id: timestamp
        run: |
          START_TIME=$(date +%s)
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "workflow_timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "ðŸ• Build started at: $TIMESTAMP"

      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu","sukisu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸŽ¯ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=${{ github.event.inputs.disable_susfs == 'false' }}
          FORCE_CLEAN=${{ github.event.inputs.force_clean_build == 'true' }}
          CREATE_RELEASE=${{ github.event.inputs.create_release == 'true' }}
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT
          echo "create_release=$CREATE_RELEASE" >> $GITHUB_OUTPUT
          
          echo "âš™ï¸ Configuration:"
          echo "  - SuSFS: $ENABLE_SUSFS"
          echo "  - Force Clean: $FORCE_CLEAN"
          echo "  - Create Release: $CREATE_RELEASE"

  build:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}
    
    outputs:
      tiann_zip: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      tiann_size: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      tiann_md5: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      tiann_sha256: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      tiann_kernel_version: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      tiann_ksu_version: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      kowsu_zip: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      kowsu_size: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      kowsu_md5: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      kowsu_sha256: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      kowsu_kernel_version: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      kowsu_ksu_version: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      mksu_zip: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      mksu_size: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      mksu_md5: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      mksu_sha256: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      mksu_kernel_version: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      mksu_ksu_version: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      sukisu_zip: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      sukisu_size: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      sukisu_md5: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      sukisu_sha256: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      sukisu_kernel_version: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      sukisu_ksu_version: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      duration: ${{ steps.build-duration.outputs.duration }}
      ccache_hit_rate: ${{ steps.export-build-info.outputs.ccache_hit_rate }}
      ccache_hits: ${{ steps.export-build-info.outputs.ccache_hits }}
      ccache_misses: ${{ steps.export-build-info.outputs.ccache_misses }}
      ccache_size: ${{ steps.export-build-info.outputs.ccache_size }}
      workflow_commit_hash: ${{ steps.export-build-info.outputs.commit_hash }}
      workflow_commit_message: ${{ steps.export-build-info.outputs.commit_message }}

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Kernel Source
        run: |
          echo "ðŸ“¦ Cloning official Google kernel source (android14-6.1-2025-09)..."
          git clone \
            --depth=1 \
            --branch android14-6.1-2025-09 \
            --single-branch \
            https://android.googlesource.com/kernel/common kernel
          echo "âœ… Official Google Kernel source cloned successfully"

      - name: Clone SuSFS4KSU
        run: |
          echo "ðŸ“¦ Cloning SuSFS4KSU (gki-android14-6.1-dev)..."
          git clone \
            --depth=1 \
            --branch gki-android14-6.1-dev \
            --single-branch \
            https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
          echo "âœ… SuSFS4KSU cloned successfully"

      - name: Setup Build Environment
        run: |
          echo "ðŸ“¦ Installing build dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            lib32readline-dev lib32z1-dev libelf-dev \
            liblz4-tool libssl-dev libxml2 libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc \
            zip zlib1g-dev python3 libarchive-tools pahole
          echo "âœ… Build environment ready"

      - name: Setup Clang 22
        run: |
          CLANG_DIR="$HOME/clang"
          CLANG_URL="https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz"
          mkdir -p "$CLANG_DIR"
          curl -fsSL "$CLANG_URL" | tar -xz -C "$CLANG_DIR"
          echo "CLANG_PATH=$CLANG_DIR/bin" >> $GITHUB_ENV
          echo "$CLANG_DIR/bin" >> $GITHUB_PATH

      - name: Setup ARM64 Toolchain
        run: |
          TC_DIR="$HOME/toolchains"
          TC_URL="https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz"
          mkdir -p "$TC_DIR"
          curl -fsSL "$TC_URL" | tar -xJ -C "$TC_DIR"
          TC_PREFIX=$(find "$TC_DIR" -maxdepth 1 -name "arm-gnu-toolchain-*aarch64*" -type d | head -1)
          echo "ARM64_TOOLCHAIN=$TC_PREFIX/bin/aarch64-none-linux-gnu-" >> $GITHUB_ENV

      - name: Setup ARM32 Toolchain
        run: |
          TC_DIR="$HOME/toolchains"
          TC_URL="https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz"
          curl -fsSL "$TC_URL" | tar -xJ -C "$TC_DIR"
          TC_PREFIX=$(find "$TC_DIR" -maxdepth 1 -name "arm-gnu-toolchain-*arm-none-eabi*" -type d | head -1)
          echo "ARM32_TOOLCHAIN=$TC_PREFIX/bin/arm-none-eabi-" >> $GITHUB_ENV

      - name: Setup CCache
        run: |
          mkdir -p "$HOME/.ccache"
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 5G
          ccache -z

      - name: Setup KernelSU Variant
        run: |
          cd kernel
          case "${{ matrix.variant }}" in
            "tiann")   KSU_REPO="tiann/KernelSU"; KSU_BRANCH="main"; USE_SETUP_SH="true" ;;
            "kowsu")   KSU_REPO="KOWX712/KernelSU"; KSU_BRANCH="master"; USE_SETUP_SH="true" ;;
            "mksu")    KSU_REPO="5ec1cff/KernelSU"; KSU_BRANCH="main"; USE_SETUP_SH="true" ;;
            "sukisu")  KSU_REPO="SukiSU-Ultra/SukiSU-Ultra"; KSU_BRANCH="tmp-builtin"; USE_SETUP_SH="false" ;;
          esac
          git clone --depth=1 --branch="$KSU_BRANCH" "https://github.com/$KSU_REPO.git" KernelSU
          if [ "$USE_SETUP_SH" = "true" ]; then
            chmod +x KernelSU/kernel/setup.sh && ./KernelSU/kernel/setup.sh .
          else
            ln -sf "$(pwd)/KernelSU/kernel" drivers/kernelsu
            grep -q "kernelsu" drivers/Makefile || echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
            grep -q "kernelsu" drivers/Kconfig || sed -i '/endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
          fi
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV

      - name: Get KSU Version Info
        run: |
          cd kernel/KernelSU
          KSU_COUNT=$(git rev-list --count HEAD)
          if [ "${{ matrix.variant }}" = "sukisu" ]; then
            KSU_VERSION=$((40000 + KSU_COUNT - 2815))
          else
            KSU_VERSION=$((KSU_COUNT + 30000))
          fi
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true' || matrix.variant == 'sukisu'
        run: |
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          cd kernel
          patch -p1 --forward < "../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" || true
          if [ "${{ matrix.variant }}" != "sukisu" ]; then
            cd KernelSU
            patch -p1 --forward < "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || true
          fi

      - name: Configure and Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_PATH }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CC="ccache clang"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          cat >> out/.config << 'EOF'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_LOCALVERSION="-deepongi+"
          EOF
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig
          
          START_TIME=$SECONDS
          make -j$(nproc) ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out CC="$CC"
          echo "BUILD_TIME=$((SECONDS - START_TIME))s" >> $GITHUB_ENV

      - name: Package Kernel
        run: |
          cd kernel
          KERNEL_VERSION=$(make -s kernelversion)
          cd ..
          case "${{ matrix.variant }}" in
            "tiann")   AK3_BRANCH="KernelSU" ;;
            "kowsu")   AK3_BRANCH="KowSU" ;;
            "mksu")    AK3_BRANCH="MKSU" ;;
            "sukisu")  AK3_BRANCH="sukisu" ;;
          esac
          git clone --depth=1 --branch="$AK3_BRANCH" "https://github.com/deepongi-labs/AnyKernel3-p8a" AnyKernel3
          cp kernel/out/arch/arm64/boot/Image AnyKernel3/
          ZIP_NAME="AK3-${KERNEL_VERSION}-${{ matrix.variant }}-${{ env.KSU_VERSION }}.zip"
          cd AnyKernel3 && zip -r9 "../$ZIP_NAME" . && cd ..
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

      - name: Generate File Info for Release
        id: generate-file-info
        run: |
          echo "FILE_SIZE=$(du -h ${{ env.KERNEL_ZIP }} | cut -f1)" >> $GITHUB_OUTPUT
          echo "MD5_HASH=$(md5sum ${{ env.KERNEL_ZIP }} | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "SHA256_HASH=$(sha256sum ${{ env.KERNEL_ZIP }} | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${{ env.KERNEL_ZIP }}" >> $GITHUB_OUTPUT
          echo "KSU_VERSION=r${{ env.KSU_VERSION }}" >> $GITHUB_OUTPUT
          echo "KERNEL_VERSION=${{ env.KERNEL_VERSION }}" >> $GITHUB_OUTPUT

      - name: Export Build Information
        id: export-build-info
        run: |
          echo "ccache_hit_rate=$(ccache -s | grep 'Hits:' | awk '{print $4}' | head -1)" >> $GITHUB_OUTPUT
          echo "ccache_size=$(ccache -s | grep 'Cache size' | awk '{print $4}' | head -1)" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: ${{ env.KERNEL_ZIP }}*

  create_release:
    needs: [setup, build]
    runs-on: ubuntu-22.04
    if: needs.setup.outputs.create_release == 'true' && success()
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate Release Notes
        run: |
          cd release-assets
          cat > RELEASE_NOTES.md << EOF
          ## ðŸš€ Google Kernel Build #${{ github.run_number }}
          
          **Build Date:** ${{ needs.setup.outputs.workflow_timestamp }}  
          **CCache Performance:** ${{ needs.build.outputs.ccache_hit_rate }}  
          **Source:** [Official Google Kernel Source](https://android.googlesource.com/kernel/common)
          
          ---
          
          ### ðŸ“¦ Available Variants
          EOF
          
          # Simplified variant block logic
          for v in tiann kowsu mksu sukisu; do
            ZIP_VAR="${v}_zip"; VERSION_VAR="${v}_ksu_version"
            if [ -n "${{!ZIP_VAR}}" ]; then
              echo "#### ðŸ”¹ ${v^^} (${{!VERSION_VAR}})" >> RELEASE_NOTES.md
              echo "- **File:** \`${{!ZIP_VAR}}\`" >> RELEASE_NOTES.md
            fi
          done
          
          cat >> RELEASE_NOTES.md << 'EOF'
          
          ---
          ### ðŸ“š Resources
          - **Kernel Source:** [Google Android Kernel Common](https://android.googlesource.com/kernel/common)
          - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd release-assets
          RELEASE_TAG="build-${{ github.run_number }}"
          # Updated Title
          RELEASE_TITLE="Google Kernel Build #${{ github.run_number }}"
          
          gh release create "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --title "$RELEASE_TITLE" \
            --notes-file RELEASE_NOTES.md \
            ./*.zip
