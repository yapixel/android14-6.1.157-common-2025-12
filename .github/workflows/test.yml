name: Build GKI Kernel 6.1.145

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
          - sukisu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        default: true
        type: boolean
      debug:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
      build_start_time: ${{ steps.timestamp.outputs.start_time }}
      create_release: ${{ steps.config.outputs.create_release }}
      workflow_timestamp: ${{ steps.timestamp.outputs.workflow_timestamp }}
    
    steps:
      - name: Record Build Start Time
        id: timestamp
        run: |
          START_TIME=$(date +%s)
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "workflow_timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "üïê Build started at: $TIMESTAMP"
      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu","sukisu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "üéØ Building variant(s): $VARIANT"
      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=${{ github.event.inputs.disable_susfs == 'false' }}
          FORCE_CLEAN=${{ github.event.inputs.force_clean_build == 'true' }}
          CREATE_RELEASE=${{ github.event.inputs.create_release == 'true' }}
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT
          echo "create_release=$CREATE_RELEASE" >> $GITHUB_OUTPUT
          
          echo "‚öôÔ∏è Configuration:"
          echo "  - SuSFS: $ENABLE_SUSFS"
          echo "  - Force Clean: $FORCE_CLEAN"
          echo "  - Create Release: $CREATE_RELEASE"
  build:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}
    
    outputs:
      tiann_zip: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      tiann_size: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      tiann_md5: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      tiann_sha256: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      tiann_kernel_version: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      tiann_ksu_version: ${{ matrix.variant == 'tiann' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      kowsu_zip: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      kowsu_size: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      kowsu_md5: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      kowsu_sha256: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      kowsu_kernel_version: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      kowsu_ksu_version: ${{ matrix.variant == 'kowsu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      mksu_zip: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      mksu_size: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      mksu_md5: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      mksu_sha256: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      mksu_kernel_version: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      mksu_ksu_version: ${{ matrix.variant == 'mksu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      sukisu_zip: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      sukisu_size: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      sukisu_md5: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      sukisu_sha256: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      sukisu_kernel_version: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      sukisu_ksu_version: ${{ matrix.variant == 'sukisu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      duration: ${{ steps.build-duration.outputs.duration }}
      ccache_hit_rate: ${{ steps.export-build-info.outputs.ccache_hit_rate }}
      ccache_hits: ${{ steps.export-build-info.outputs.ccache_hits }}
      ccache_misses: ${{ steps.export-build-info.outputs.ccache_misses }}
      ccache_size: ${{ steps.export-build-info.outputs.ccache_size }}
      workflow_commit_hash: ${{ steps.export-build-info.outputs.commit_hash }}
      workflow_commit_message: ${{ steps.export-build-info.outputs.commit_message }}

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          build-mount-path: '/home/runner'
          root-reserve-mb: 2048
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Free Up Additional Space
        run: |
          echo "üìä Disk space BEFORE cleanup:"
          df -h /
          
          # Remove unnecessary packages
          sudo apt-get remove -y \
            '^aspnetcore-.*' '^dotnet-.*' 'php.*' \
            '^mongodb-.*' '^mysql-.*' \
            azure-cli google-chrome-stable firefox \
            powershell mono-devel 2>/dev/null || true
          
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # Remove large directories
          sudo rm -rf \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /usr/local/share/boost \
            /usr/lib/jvm \
            /usr/local/graalvm \
            /usr/local/.ghcup \
            /usr/local/share/powershell \
            /usr/share/swift 2>/dev/null || true
          
          echo "üìä Disk space AFTER cleanup:"
          df -h /
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Kernel Source
        run: |
          echo "üì¶ Cloning official Google kernel source (android14-6.1-2025-09)..."
          git clone \
            --depth=1 \
            --branch android14-6.1-2025-09 \
            --single-branch \
            https://android.googlesource.com/kernel/common kernel
          echo "‚úÖ Official Google Kernel source cloned successfully"
      - name: Clone SuSFS4KSU
        run: |
          echo "üì¶ Cloning SuSFS4KSU (gki-android14-6.1-dev)..."
          git clone \
            --depth=1 \
            --branch gki-android14-6.1-dev \
            --single-branch \
            https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
          echo "‚úÖ SuSFS4KSU cloned successfully"
      - name: Setup Build Environment
        run: |
          echo "üì¶ Installing build dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            lib32readline-dev lib32z1-dev libelf-dev \
            liblz4-tool libssl-dev libxml2 libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc \
            zip zlib1g-dev python3 libarchive-tools pahole
          echo "‚úÖ Build environment ready"
      - name: Setup Clang 22
        run: |
          CLANG_DIR="$HOME/clang"
          CLANG_URL="https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz"
          
          echo "üì• Downloading Clang 22..."
          mkdir -p "$CLANG_DIR"
          curl -fsSL "$CLANG_URL" | tar -xz -C "$CLANG_DIR"
          
          echo "CLANG_PATH=$CLANG_DIR/bin" >> $GITHUB_ENV
          echo "$CLANG_DIR/bin" >> $GITHUB_PATH
          
          echo "‚úÖ Clang 22 installed:"
          "$CLANG_DIR/bin/clang" --version | head -1
      - name: Setup ARM64 Toolchain (GNU 14.3.rel1)
        run: |
          TC_DIR="$HOME/toolchains"
          TC_URL="https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz"
          
          echo "üì• Downloading ARM64 toolchain..."
          mkdir -p "$TC_DIR"
          curl -fsSL "$TC_URL" | tar -xJ -C "$TC_DIR"
          
          TC_PREFIX=$(find "$TC_DIR" -maxdepth 1 -name "arm-gnu-toolchain-*aarch64*" -type d | head -1)
          echo "ARM64_TOOLCHAIN=$TC_PREFIX/bin/aarch64-none-linux-gnu-" >> $GITHUB_ENV
          echo "‚úÖ ARM64 toolchain installed"
      - name: Setup ARM32 Toolchain (GNU 14.3.rel1)
        run: |
          TC_DIR="$HOME/toolchains"
          TC_URL="https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz"
          
          echo "üì• Downloading ARM32 toolchain..."
          curl -fsSL "$TC_URL" | tar -xJ -C "$TC_DIR"
          
          TC_PREFIX=$(find "$TC_DIR" -maxdepth 1 -name "arm-gnu-toolchain-*arm-none-eabi*" -type d | head -1)
          echo "ARM32_TOOLCHAIN=$TC_PREFIX/bin/arm-none-eabi-" >> $GITHUB_ENV
          echo "‚úÖ ARM32 toolchain installed"
      - name: Setup CCache
        run: |
          CCACHE_DIR="$HOME/.ccache"
          mkdir -p "$CCACHE_DIR"
          
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          
          ccache -M 5G
          ccache -z
          ccache --show-config
          
          echo "‚úÖ CCache configured (max 5GB)"
      - name: Verify Disk Space
        run: |
          echo "üìä Disk space before build:"
          df -h /
          echo ""
          echo "üìä Home directory size:"
          du -sh "$HOME"/* 2>/dev/null | sort -hr | head -10 || true
      - name: Store Repository Commit Info
        run: |
          COMMIT_INFO=$(git log -1 --format="%H %h %cd %s" --date=format:'%Y-%m-%d %H:%M:%S')
          read -r HASH SHORT DATE MSG <<< "$COMMIT_INFO"
          
          echo "WORKFLOW_COMMIT=$HASH" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_SHORT=$SHORT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_MSG=$MSG" >> $GITHUB_ENV
          
          echo "üîñ Workflow: $SHORT - $MSG"
      - name: Verify and Store Kernel Info
        run: |
          cd kernel
          
          # Verify Makefile exists
          if [ ! -f "Makefile" ]; then
            echo "‚ùå Kernel Makefile not found!"
            exit 1
          fi
          
          # Extract version
          VERSION=$(grep "^VERSION" Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | awk '{print $3}')
          echo "‚úÖ Kernel version: $VERSION.$PATCHLEVEL"
          
          # Store commit info
          COMMIT_INFO=$(git log -1 --format="%H %h %cd %s" --date=format:'%Y-%m-%d %H:%M:%S')
          read -r HASH SHORT DATE MSG <<< "$COMMIT_INFO"
          
          echo "KERNEL_COMMIT=$HASH" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_SHORT=$SHORT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_MSG=$MSG" >> $GITHUB_ENV
          
          echo "üîñ Kernel: $SHORT - $MSG"
      - name: Verify and Store SuSFS Info
        run: |
          cd susfs4ksu
          
          if [ ! -d "kernel_patches" ]; then
            echo "‚ùå SuSFS kernel_patches directory not found!"
            exit 1
          fi
          echo "‚úÖ SuSFS verified"
          
          COMMIT_INFO=$(git log -1 --format="%H %h %cd %s" --date=format:'%Y-%m-%d %H:%M:%S')
          read -r HASH SHORT DATE MSG <<< "$COMMIT_INFO"
          
          echo "SUSFS_COMMIT=$HASH" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_SHORT=$SHORT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_MSG=$MSG" >> $GITHUB_ENV
          
          echo "üîñ SuSFS: $SHORT - $MSG"
      - name: Show Build Environment
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã BUILD ENVIRONMENT - ${{ matrix.variant }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîß Clang: $(clang --version | head -1)"
          echo "üîß ARM64: ${{ env.ARM64_TOOLCHAIN }}"
          echo "üîß ARM32: ${{ env.ARM32_TOOLCHAIN }}"
          echo "üíæ CCache: ${{ env.CCACHE_DIR }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - name: Clean Kernel Directory
        run: |
          echo "üßπ Cleaning kernel directory..."
          cd kernel
          rm -rf KernelSU drivers/kernelsu
          git reset --hard HEAD
          git clean -fdx
          echo "‚úÖ Kernel directory cleaned"
      - name: Setup KernelSU Variant
        run: |
          cd kernel
          
          # Define variant-specific configuration
          case "${{ matrix.variant }}" in
            "tiann")
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              USE_SETUP_SH="true"
              echo "üì¶ Setting up Official KernelSU (tiann)"
              ;;
            "kowsu")
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              USE_SETUP_SH="true"
              echo "üì¶ Setting up KowSU (KOWX712)"
              ;;
            "mksu")
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              USE_SETUP_SH="true"
              echo "üì¶ Setting up MKSU (5ec1cff)"
              ;;
            "sukisu")
              KSU_REPO="SukiSU-Ultra/SukiSU-Ultra"
              KSU_BRANCH="tmp-builtin"
              USE_SETUP_SH="false"
              echo "üì¶ Setting up SukiSU-Ultra"
              ;;
            *)
              echo "‚ùå Unknown variant: ${{ matrix.variant }}"
              exit 1
              ;;
          esac
          
          # Clone KernelSU
          echo "üì• Cloning $KSU_REPO (branch: $KSU_BRANCH)..."
          git clone \
            --depth=1 \
            --branch="$KSU_BRANCH" \
            --single-branch \
            "https://github.com/$KSU_REPO.git" KernelSU
          
          # Setup based on variant
          if [ "$USE_SETUP_SH" = "true" ]; then
            if [ -f "KernelSU/kernel/setup.sh" ]; then
              echo "üöÄ Running setup.sh..."
              chmod +x KernelSU/kernel/setup.sh
              ./KernelSU/kernel/setup.sh .
            else
              echo "‚ùå setup.sh not found at KernelSU/kernel/setup.sh"
              exit 1
            fi
          else
            # Manual setup for SukiSU-Ultra
            echo "üîß Manual setup for SukiSU-Ultra..."
            
            # Try symlink first
            ln -sf "$(pwd)/KernelSU/kernel" drivers/kernelsu
            
            # Verify or fallback to copy
            if [ ! -f "drivers/kernelsu/Kconfig" ]; then
              rm -rf drivers/kernelsu
              cp -r KernelSU/kernel drivers/kernelsu
            fi
            
            # Update Makefile
            if ! grep -q "kernelsu" drivers/Makefile; then
              echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
            fi
            
            # Update Kconfig
            if ! grep -q "kernelsu" drivers/Kconfig; then
              sed -i '/endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
            fi
          fi
          
          # Export variables
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          
          echo "‚úÖ KernelSU setup completed for ${{ matrix.variant }}"
      - name: Verify KernelSU Setup
        run: |
          if [ ! -d "kernel/drivers/kernelsu" ]; then
            echo "‚ùå KernelSU drivers directory not found"
            exit 1
          fi
          
          if [ ! -f "kernel/drivers/kernelsu/Kconfig" ]; then
            echo "‚ùå KernelSU Kconfig not found"
            exit 1
          fi
          
          echo "‚úÖ KernelSU setup verified"
      - name: Get KSU Version Info
        run: |
          cd kernel/KernelSU
          
          echo "üìä Fetching full git history..."
          git fetch --unshallow --quiet 2>/dev/null || \
            git fetch --depth=10000 --quiet 2>/dev/null || true
          
          echo "üî¢ Calculating KSU version..."
          if [ "${{ matrix.variant }}" = "sukisu" ]; then
            git fetch origin main:main --quiet 2>/dev/null || true
            KSU_COUNT=$(git rev-list --count main)
            KSU_VERSION=$((40000 + KSU_COUNT - 2815))
            echo "‚úÖ SukiSU version: r$KSU_VERSION (base: 40000)"
          else
            KSU_COUNT=$(git rev-list --count HEAD)
            KSU_VERSION=$((KSU_COUNT + 30000))
            echo "‚úÖ KernelSU version: r$KSU_VERSION (base: 30000)"
          fi
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_COUNT=$KSU_COUNT" >> $GITHUB_ENV
      - name: Store KernelSU Commit Info
        run: |
          cd kernel/KernelSU
          
          COMMIT_INFO=$(git log -1 --format="%H %h %cd %s %an" --date=format:'%Y-%m-%d %H:%M:%S')
          read -r HASH SHORT DATE MSG AUTHOR <<< "$COMMIT_INFO"
          
          echo "KSU_COMMIT=$HASH" >> $GITHUB_ENV
          echo "KSU_COMMIT_SHORT=$SHORT" >> $GITHUB_ENV
          echo "KSU_COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "KSU_COMMIT_MSG=$MSG" >> $GITHUB_ENV
          echo "KSU_COMMIT_AUTHOR=$AUTHOR" >> $GITHUB_ENV
          
          echo "üîñ KernelSU: $SHORT - $MSG (by $AUTHOR)"
      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true' || matrix.variant == 'sukisu'
        run: |
          echo "üì¶ Setting up SuSFS..."
          
          if [ "${{ matrix.variant }}" = "sukisu" ]; then
            echo "üîí SukiSU-Ultra: SuSFS is mandatory (pre-integrated)"
          fi
          
          # Copy SuSFS files
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch
          VARIANT_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_PATCH" ]; then
            echo "üìã Applying variant-specific SuSFS patch"
            patch -p1 --forward < "$VARIANT_PATCH" || true
          else
            echo "üìã Applying default SuSFS patch"
            patch -p1 --forward < "$DEFAULT_PATCH" || true
          fi
          
          # Apply KSU SuSFS patch (not for sukisu)
          if [ "${{ matrix.variant }}" != "sukisu" ]; then
            cd KernelSU
            VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
            DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
            
            if [ -f "$VARIANT_KSU_PATCH" ]; then
              echo "üìã Applying variant-specific KSU SuSFS patch"
              patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
            else
              echo "üìã Applying default KSU SuSFS patch"
              patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
            fi
            cd ..
          fi
          
          echo "‚úÖ SuSFS setup completed"
      - name: Apply Additional Patches
        run: |
          cd kernel
          
          # Apply LKM spoof patch (not for sukisu)
          if [ "${{ matrix.variant }}" != "sukisu" ]; then
            cd KernelSU
            LKM_PATCH="../../.github/patches/${{ matrix.variant }}/20-KernelSU-Spoof-LKM-mode-to-suppress-manager-warning.patch"
            if [ -f "$LKM_PATCH" ]; then
              echo "üìã Applying LKM spoof patch"
              patch -p1 --forward < "$LKM_PATCH" || true
            fi
            cd ..
          fi
          
          # Apply remote patches
          echo "üìã Applying fix-clidr-uninitialized.patch"
          curl -fsSL "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" | \
            patch -p1 --forward || true
          
          # Patch setlocalversion script
          sed -i '/# Check for uncommitted changes\./,/fi/d' scripts/setlocalversion
          
          echo "‚úÖ All patches applied"
      - name: Configure Kernel
        run: |
          cd kernel
          
          export ARCH=arm64
          export PATH="${{ env.CLANG_PATH }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          # Generate base config
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Apply variant-specific configuration
          cat >> out/.config << 'EOF'
          # CPU & Architecture - Tensor G3
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          # Scheduler & Performance
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          # CPU Frequency & Power
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          # Thermal Management
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          # Power & Performance
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          # Kernel Version
          CONFIG_LOCALVERSION_AUTO=n
          # Kprobes (required for KernelSU)
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          # Filesystem
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          # Network
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          # TCP Congestion Control
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          # Compilation Optimization
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          # IP Sets
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          # CAKE Queue Discipline
          CONFIG_NET_SCH_CAKE=y
          # KernelSU Base Config
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          EOF
          
          # Variant-specific config
          case "${{ matrix.variant }}" in
            "tiann"|"kowsu"|"mksu")
              cat >> out/.config << 'EOF'
          CONFIG_LOCALVERSION="-deepongi+"
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_ALLOWLIST_WORKAROUND=n
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          EOF
              ;;
            "sukisu")
              cat >> out/.config << 'EOF'
          CONFIG_LOCALVERSION="-deepongi+"
          CONFIG_KSU_SUSFS_SUS_KSTAT_USE_INLINE_HOOK=y
          EOF
              ;;
          esac
          
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ] || [ "${{ matrix.variant }}" = "sukisu" ]; then
            cat >> out/.config << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          fi
          
          # Regenerate config
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig
          
          echo "‚úÖ Kernel configured"
      - name: Prepare for Build
        run: |
          cd kernel
          
          echo "üßπ Removing ABI protected exports..."
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "üßπ Performing clean..."
            make -j$(nproc) LLVM=1 LLVM_IAS=1 LD=ld.lld O=out clean
          fi
          
          echo "‚úÖ Ready to build"
      - name: Build Kernel
        run: |
          cd kernel
          
          export ARCH=arm64
          export PATH="${{ env.CLANG_PATH }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          
          # CCache optimization
          export CCACHE_COMPRESS=true
          export CCACHE_COMPRESSLEVEL=6
          export CCACHE_MAXSIZE=5G
          export CCACHE_SLOPPINESS="include_file_ctime,include_file_mtime,time_macros"
          
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          # Calculate optimal job count
          CORES=$(nproc)
          MEMORY_GB=$(free -g | awk '/^Mem:/{print $2}')
          MAX_JOBS=$(( (MEMORY_GB - 2) / 2 ))
          
          if [ $MAX_JOBS -lt $CORES ]; then
            MAKE_JOBS=$MAX_JOBS
            echo "‚ö†Ô∏è Limited by RAM: Using $MAKE_JOBS jobs ($CORES cores, ${MEMORY_GB}GB RAM)"
          else
            MAKE_JOBS=$CORES
            echo "‚úÖ Using $MAKE_JOBS jobs ($CORES cores, ${MEMORY_GB}GB RAM)"
          fi
          
          [ $MAKE_JOBS -lt 1 ] && MAKE_JOBS=1
          
          # Build
          START_TIME=$SECONDS
          echo "üî® Building kernel for ${{ matrix.variant }}..."
          
          make -j$MAKE_JOBS \
            ARCH=arm64 \
            LLVM=1 \
            LLVM_IAS=1 \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            CC="$CC" \
            2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_MINS=$((BUILD_TIME / 60))
          BUILD_SECS=$((BUILD_TIME % 60))
          
          echo "BUILD_TIME=${BUILD_MINS}m ${BUILD_SECS}s" >> $GITHUB_ENV
          echo "MAKE_JOBS=$MAKE_JOBS" >> $GITHUB_ENV
          
          echo "‚úÖ Build completed in ${BUILD_MINS}m ${BUILD_SECS}s"
      - name: Record Build Duration
        id: build-duration
        run: |
          echo "duration=${{ env.BUILD_TIME }}" >> $GITHUB_OUTPUT
      - name: Check CCache Performance
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "üìà CCache statistics:"
          ccache -s
          
          CCACHE_OUTPUT=$(ccache -s 2>&1)
          
          # Extract metrics
          HIT_RATE=$(echo "$CCACHE_OUTPUT" | grep -oP 'Hits:.*?\K\d+\.\d+%' | head -1)
          CACHE_HITS=$(echo "$CCACHE_OUTPUT" | grep "Hits:" | awk '{print $2}' | head -1)
          CACHE_MISSES=$(echo "$CCACHE_OUTPUT" | grep "Misses:" | awk '{print $2}' | head -1)
          CACHE_SIZE=$(echo "$CCACHE_OUTPUT" | grep "Cache size" | awk '{print $4}' | head -1)
          
          echo "CCACHE_HIT_RATE=${HIT_RATE:-N/A}" >> $GITHUB_ENV
          echo "CCACHE_HITS=${CACHE_HITS:-0}" >> $GITHUB_ENV
          echo "CCACHE_MISSES=${CACHE_MISSES:-0}" >> $GITHUB_ENV
          echo "FINAL_CACHE_SIZE=${CACHE_SIZE:-N/A}" >> $GITHUB_ENV
      - name: Export Build Information
        id: export-build-info
        run: |
          echo "ccache_hit_rate=${{ env.CCACHE_HIT_RATE }}" >> $GITHUB_OUTPUT
          echo "ccache_hits=${{ env.CCACHE_HITS }}" >> $GITHUB_OUTPUT
          echo "ccache_misses=${{ env.CCACHE_MISSES }}" >> $GITHUB_OUTPUT
          echo "ccache_size=${{ env.FINAL_CACHE_SIZE }}" >> $GITHUB_OUTPUT
          echo "commit_hash=${{ env.WORKFLOW_COMMIT_SHORT }}" >> $GITHUB_OUTPUT
          echo "commit_message=${{ env.WORKFLOW_COMMIT_MSG }}" >> $GITHUB_OUTPUT
      - name: Verify Build Output
        run: |
          if [ ! -f "kernel/out/arch/arm64/boot/Image" ]; then
            echo "‚ùå Kernel Image not found!"
            exit 1
          fi
          
          IMAGE_SIZE=$(du -h kernel/out/arch/arm64/boot/Image | cut -f1)
          echo "‚úÖ Kernel Image built successfully ($IMAGE_SIZE)"
      - name: Package Kernel
        run: |
          cd kernel
          
          # Extract kernel version
          KERNEL_VERSION=$(make -s kernelversion)
          cd ..
          
          echo "‚úÖ Kernel version: $KERNEL_VERSION"
          
          # Determine AnyKernel3 configuration
          case "${{ matrix.variant }}" in
            "tiann")   AK3_BRANCH="KernelSU"; AK3_REPO="deepongi-labs/AnyKernel3-p8a" ;;
            "kowsu")   AK3_BRANCH="KowSU";    AK3_REPO="deepongi-labs/AnyKernel3-p8a" ;;
            "mksu")    AK3_BRANCH="MKSU";     AK3_REPO="deepongi-labs/AnyKernel3-p8a" ;;
            "sukisu")  AK3_BRANCH="sukisu";   AK3_REPO="deepongi-labs/AnyKernel3-p8a" ;;
          esac
          
          # Clone AnyKernel3
          echo "üì• Cloning AnyKernel3 ($AK3_BRANCH)..."
          git clone \
            --depth=1 \
            --branch="$AK3_BRANCH" \
            --single-branch \
            "https://github.com/$AK3_REPO" AnyKernel3
          
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          # Generate filename
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          SUSFS_SUFFIX=${{ (env.ENABLE_SUSFS == 'true' || matrix.variant == 'sukisu') && 'SUSFS' || 'NOSUSFS' }}
          
          ZIP_NAME="AK3-${KERNEL_VERSION}-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-${SUSFS_SUFFIX}.zip"
          
          # Create zip
          echo "üì¶ Creating package: $ZIP_NAME"
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          # Generate checksums
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          
          FILE_SIZE=$(du -h "$ZIP_NAME" | cut -f1)
          echo "‚úÖ Package created: $ZIP_NAME ($FILE_SIZE)"
          
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
      - name: Generate File Info for Release
        id: generate-file-info
        run: |
          FILE_SIZE=$(du -h "${{ env.KERNEL_ZIP }}" | cut -f1)
          MD5_HASH=$(md5sum "${{ env.KERNEL_ZIP }}" | awk '{print $1}')
          SHA256_HASH=$(sha256sum "${{ env.KERNEL_ZIP }}" | awk '{print $1}')
          
          echo "FILE_SIZE=${FILE_SIZE}" >> $GITHUB_OUTPUT
          echo "MD5_HASH=${MD5_HASH}" >> $GITHUB_OUTPUT
          echo "SHA256_HASH=${SHA256_HASH}" >> $GITHUB_OUTPUT
          echo "VARIANT=${{ matrix.variant }}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${{ env.KERNEL_ZIP }}" >> $GITHUB_OUTPUT
          echo "KSU_VERSION=r${{ env.KSU_VERSION }}" >> $GITHUB_OUTPUT
          echo "KERNEL_VERSION=${{ env.KERNEL_VERSION }}" >> $GITHUB_OUTPUT
      - name: Build Summary
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä BUILD SUMMARY - ${{ matrix.variant }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚è±Ô∏è  Build time:      ${{ env.BUILD_TIME }}"
          echo "üîß Parallel jobs:   ${{ env.MAKE_JOBS }}"
          echo "üíæ CCache hit rate: ${{ env.CCACHE_HIT_RATE }}"
          echo "üì¶ Package:         ${{ env.KERNEL_ZIP }}"
          echo "üìè Size:            ${{ steps.generate-file-info.outputs.FILE_SIZE }}"
          echo "üîê MD5:             ${{ steps.generate-file-info.outputs.MD5_HASH }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
          retention-days: 30
          compression-level: 0

  create_release:
    needs: [setup, build]
    runs-on: ubuntu-22.04
    if: needs.setup.outputs.create_release == 'true' && success()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Build Duration
        run: |
          START_TIME="${{ needs.setup.outputs.build_start_time }}"
          END_TIME=$(date +%s)
          
          if [ -n "$START_TIME" ] && [ "$START_TIME" != "null" ] && [ "$START_TIME" -gt 0 ]; then
            DURATION=$((END_TIME - START_TIME))
            DURATION_MINS=$((DURATION / 60))
            DURATION_SECS=$((DURATION % 60))
            BUILD_DURATION="${DURATION_MINS}m ${DURATION_SECS}s"
          else
            BUILD_DURATION="Unknown"
          fi
          
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Organize Release Assets
        run: |
          cd release-assets
          
          # Flatten directory structure
          find . -type f -exec mv {} . \; 2>/dev/null || true
          find . -type d -empty -delete
          
          echo "üì¶ Release assets:"
          ls -lh
      - name: Generate Release Notes
        run: |
          cd release-assets
          
          # Extract build info
          CCACHE_INFO="${{ needs.build.outputs.ccache_hit_rate }}"
          if [ -n "${{ needs.build.outputs.ccache_hits }}" ]; then
            CCACHE_INFO="$CCACHE_INFO (${{ needs.build.outputs.ccache_hits }} hits, ${{ needs.build.outputs.ccache_misses }} misses)"
          fi
          
          # Create release notes
          cat > RELEASE_NOTES.md << EOF
          ## üöÄ Android 16 Kernel Build #${{ github.run_number }}
          
          **Build Date:** ${{ needs.setup.outputs.workflow_timestamp }}  
          **Build Duration:** ${{ env.BUILD_DURATION }}  
          **CCache Performance:** ${CCACHE_INFO}  
          **Cache Size:** ${{ needs.build.outputs.ccache_size }} GB  
          **Kernel Version:** 6.1.x  
          **SuSFS:** ${{ github.event.inputs.disable_susfs == 'true' && '‚ùå Disabled' || '‚úÖ Enabled' }}  
          **Workflow Commit:** \`${{ needs.build.outputs.workflow_commit_hash }}\` - "${{ needs.build.outputs.workflow_commit_message }}"
          
          ---
          
          ### üì± Supported Devices
          - Google Pixel 8
          - Google Pixel 8a
          - Google Pixel 8 Pro
          
          ### üì¶ Available Variants
          EOF
          
          # Add variant information - tiann
          if [ -n "${{ needs.build.outputs.tiann_zip }}" ]; then
            cat >> RELEASE_NOTES.md << 'VARIANT_EOF'
          
          #### üîπ TIANN (${{ needs.build.outputs.tiann_ksu_version }})
          - **File:** `${{ needs.build.outputs.tiann_zip }}`
          - **Size:** ${{ needs.build.outputs.tiann_size }}
          - **MD5:** `${{ needs.build.outputs.tiann_md5 }}`
          - **SHA256:** `${{ needs.build.outputs.tiann_sha256 }}`
          VARIANT_EOF
          fi
          
          # Add variant information - kowsu
          if [ -n "${{ needs.build.outputs.kowsu_zip }}" ]; then
            cat >> RELEASE_NOTES.md << 'VARIANT_EOF'
          
          #### üîπ KOWSU (${{ needs.build.outputs.kowsu_ksu_version }})
          - **File:** `${{ needs.build.outputs.kowsu_zip }}`
          - **Size:** ${{ needs.build.outputs.kowsu_size }}
          - **MD5:** `${{ needs.build.outputs.kowsu_md5 }}`
          - **SHA256:** `${{ needs.build.outputs.kowsu_sha256 }}`
          VARIANT_EOF
          fi
          
          # Add variant information - mksu
          if [ -n "${{ needs.build.outputs.mksu_zip }}" ]; then
            cat >> RELEASE_NOTES.md << 'VARIANT_EOF'
          
          #### üîπ MKSU (${{ needs.build.outputs.mksu_ksu_version }})
          - **File:** `${{ needs.build.outputs.mksu_zip }}`
          - **Size:** ${{ needs.build.outputs.mksu_size }}
          - **MD5:** `${{ needs.build.outputs.mksu_md5 }}`
          - **SHA256:** `${{ needs.build.outputs.mksu_sha256 }}`
          VARIANT_EOF
          fi
          
          # Add variant information - sukisu
          if [ -n "${{ needs.build.outputs.sukisu_zip }}" ]; then
            cat >> RELEASE_NOTES.md << 'VARIANT_EOF'
          
          #### üîπ SUKISU (${{ needs.build.outputs.sukisu_ksu_version }})
          - **File:** `${{ needs.build.outputs.sukisu_zip }}`
          - **Size:** ${{ needs.build.outputs.sukisu_size }}
          - **MD5:** `${{ needs.build.outputs.sukisu_md5 }}`
          - **SHA256:** `${{ needs.build.outputs.sukisu_sha256 }}`
          VARIANT_EOF
          fi
          
          # Add installation instructions
          cat >> RELEASE_NOTES.md << 'EOF'
          
          ---
          
          ### üöÄ Installation
          
          #### Method 1: Kernel Flasher (Recommended)
          1. Download [Kernel Flasher v1.6.0](https://github.com/fatalcoder524/KernelFlasher/releases/tag/v1.6.0)
          2. Flash the AK3 zip file directly through the app
          
          #### Method 2: Manual Flash (Advanced)
          ```bash
          # Extract kernel image
          unzip AK3-*.zip Image
          
          # Unpack boot image
          magiskboot unpack boot.img
          
          # Replace kernel
          mv -v Image kernel
          
          # Repack boot image
          magiskboot repack boot.img
          
          # Flash to device
          fastboot flash boot new-boot.img
          ```
          
          ---
          
          ### üìö Resources
          - **Repository:** https://github.com/${{ github.repository }}
          - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - **Report Issues:** https://github.com/${{ github.repository }}/issues
          - **Telegram:** [@deepongi_labs](https://t.me/deepongi_labs)
          
          ---
          
          ### ‚ö†Ô∏è Important Notes
          - Always backup your data before flashing
          - Verify checksums before installation
          - Compatible with Android 14+ on supported Pixel devices
          
          *Built with ‚ù§Ô∏è using GitHub Actions*
          EOF
          
          echo "‚úÖ Release notes generated"
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd release-assets
          
          RELEASE_TAG="build-${{ github.run_number }}"
          RELEASE_TITLE="Android 16 Kernel Build #${{ github.run_number }}"
          
          echo "üì§ Creating release: $RELEASE_TAG"
          
          gh release create "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --title "$RELEASE_TITLE" \
            --notes-file RELEASE_NOTES.md \
            --draft=false \
            --prerelease=false \
            ./*.zip 
          
          echo "‚úÖ Release created successfully"
          echo "üîó https://github.com/${{ github.repository }}/releases/tag/$RELEASE_TAG"
      - name: Release Summary
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üéâ RELEASE SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ Build: #${{ github.run_number }}"
          echo "‚è±Ô∏è  Duration: ${{ env.BUILD_DURATION }}"
          echo "üîó URL: https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
