name: Build GKI Kernel with KernelSU Variants

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'tiann'
        type: choice
        options:
          - tiann
          - kowsu
          - mksu
          - all
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
      - ksu-tiann
      - ksu-kowsu
      - ksu-mksu
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  CCACHE_MAXSIZE: 50G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  # Determine which variants to build
  setup:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
    steps:
      - name: Set Build Matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VARIANT="${{ github.event.inputs.ksu_variant }}"
          elif [ "${{ github.ref }}" = "refs/heads/ksu-tiann" ]; then
            VARIANT="tiann"
          elif [ "${{ github.ref }}" = "refs/heads/ksu-kowsu" ]; then
            VARIANT="kowsu"
          elif [ "${{ github.ref }}" = "refs/heads/ksu-mksu" ]; then
            VARIANT="mksu"
          else
            # Default to tiann for main branch or PRs
            VARIANT="tiann"
          fi
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "üéØ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
              ENABLE_SUSFS=false
            fi
            if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
              FORCE_CLEAN=true
            fi
          fi
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # NOTE: Using local kernel cache - NO GitHub Actions cache
      - name: Clone/Update Kernel Source
        run: |
          KERNEL_BRANCH="android14-6.1-2025-09"
          KERNEL_CACHE_DIR="/mnt/cache/kernel-android14-6.1"
          
          # Use local persistent cache if available
          if [ -d "$KERNEL_CACHE_DIR/.git" ] && [ -f "$KERNEL_CACHE_DIR/Makefile" ]; then
            echo "üì¶ Using cached kernel from $KERNEL_CACHE_DIR"
            # Copy from cache instead of cloning
            cp -r "$KERNEL_CACHE_DIR" kernel
            cd kernel
            # Update to latest
            git fetch origin $KERNEL_BRANCH --depth=1
            git reset --hard FETCH_HEAD
            git clean -fdx
            echo "‚úÖ Kernel updated from cache"
            cd ..
          elif [ -d "kernel/.git" ] && [ -f "kernel/Makefile" ]; then
            echo "üì¶ Kernel exists in workspace, resetting to upstream..."
            cd kernel
            git fetch origin $KERNEL_BRANCH --depth=1
            git reset --hard FETCH_HEAD
            git clean -fdx
            echo "‚úÖ Kernel reset to upstream and cleaned"
            cd ..
          else
            echo "üì• Cloning kernel from scratch..."
            rm -rf kernel
            git clone --depth=1 --single-branch -b $KERNEL_BRANCH \
              https://github.com/aosp-mirror/kernel_common.git kernel
            
            # Save to cache for future builds
            if [ ! -d "$KERNEL_CACHE_DIR" ]; then
              echo "üíæ Saving kernel to cache..."
              mkdir -p "$(dirname "$KERNEL_CACHE_DIR")"
              cp -r kernel "$KERNEL_CACHE_DIR"
            fi
          fi
          
          # Verify kernel
          if [ -f "kernel/Makefile" ]; then
            cd kernel
            VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
            echo "‚úÖ Kernel version: $VERSION.$PATCHLEVEL"
            cd ..
          else
            echo "‚ùå Kernel not available"
            exit 1
          fi

      # NOTE: Using local SuSFS cache - NO GitHub Actions cache
      - name: Clone/Update SuSFS Source
        run: |
          SUSFS_BRANCH="gki-android14-6.1-dev"
          SUSFS_CACHE_DIR="/mnt/cache/susfs4ksu-gki-android14-6.1"
          
          # Use local persistent cache if available
          if [ -d "$SUSFS_CACHE_DIR/.git" ] && [ -d "$SUSFS_CACHE_DIR/kernel_patches" ]; then
            echo "üì¶ Using cached SuSFS from $SUSFS_CACHE_DIR"
            # Copy from cache
            cp -r "$SUSFS_CACHE_DIR" susfs4ksu
            cd susfs4ksu
            # Check for updates
            git fetch origin $SUSFS_BRANCH --depth=1
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse FETCH_HEAD)
            if [ "$LOCAL" = "$REMOTE" ]; then
              echo "‚úÖ SuSFS is up to date (cached)"
            else
              echo "üîÑ SuSFS has updates, resetting..."
              git reset --hard FETCH_HEAD
              git clean -fdx
              # Update cache
              rm -rf "$SUSFS_CACHE_DIR"
              cp -r "$(pwd)" "$SUSFS_CACHE_DIR"
            fi
            cd ..
          elif [ -d "susfs4ksu/.git" ] && [ -d "susfs4ksu/kernel_patches" ]; then
            echo "üì¶ SuSFS exists in workspace, checking for updates..."
            cd susfs4ksu
            git fetch origin $SUSFS_BRANCH --depth=1
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse FETCH_HEAD)
            if [ "$LOCAL" = "$REMOTE" ]; then
              echo "‚úÖ SuSFS is up to date"
            else
              echo "üîÑ SuSFS has updates, resetting..."
              git reset --hard FETCH_HEAD
              git clean -fdx
            fi
            cd ..
          else
            echo "üì• Cloning susfs4ksu from scratch..."
            rm -rf susfs4ksu
            git clone --depth=1 --single-branch -b $SUSFS_BRANCH \
              https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
            
            # Save to cache for future builds
            if [ ! -d "$SUSFS_CACHE_DIR" ]; then
              echo "üíæ Saving SuSFS to cache..."
              mkdir -p "$(dirname "$SUSFS_CACHE_DIR")"
              cp -r susfs4ksu "$SUSFS_CACHE_DIR"
            fi
          fi
          
          # Verify susfs4ksu
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "‚úÖ SuSFS verified"
          else
            echo "‚ùå SuSFS not available"
            exit 1
          fi

      # NOTE: CCACHE using ONLY local directory - NO GitHub Actions cache
      - name: Setup Local CCACHE
        run: |
          echo "üîß Setting up LOCAL CCACHE (no GitHub Actions cache)..."
          
          # Source local .zshrc to get ccache settings
          if [ -f "$HOME/.zshrc" ]; then
            echo "üìã Sourcing .zshrc for ccache configuration..."
            source "$HOME/.zshrc" || true
          fi
          
          # Ensure ccache is in PATH
          export PATH="/usr/lib/ccache:$PATH"
          
          # Create ccache directory if it doesn't exist
          if [ ! -d "${{ env.CCACHE_DIR }}" ]; then
            echo "üìÅ Creating ccache directory: ${{ env.CCACHE_DIR }}"
            sudo mkdir -p "${{ env.CCACHE_DIR }}"
            sudo chown -R $USER:$USER "${{ env.CCACHE_DIR }}"
          fi
          
          # Configure ccache to use local directory only
          # These will override .zshrc settings if needed, or use .zshrc defaults
          ccache --set-config=cache_dir=${{ env.CCACHE_DIR }}
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=hash_dir=false
          
          echo "üìä CCACHE configuration:"
          ccache --show-config | grep -E "(cache_dir|max_size|sloppiness|compression)"
          
          echo "üìà CCACHE stats BEFORE build:"
          ccache -s
          
          # Calculate and save initial hit rate
          HIT_RATE=$(ccache -s | grep -i "cache hit rate" | grep -Eo "[0-9]+\.[0-9]+" || echo "0.0")
          echo "INITIAL_HIT_RATE=${HIT_RATE}%" >> $GITHUB_ENV
          echo "üíæ Initial hit rate: ${HIT_RATE}%"
          
          # Show cache size
          CACHE_SIZE=$(du -sh ${{ env.CCACHE_DIR }} | cut -f1)
          echo "üì¶ Current cache size: $CACHE_SIZE"

      - name: Clean ABI Exports
        run: |
          cd kernel
          echo "üßπ Cleaning ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true

      - name: Setup KernelSU - ${{ matrix.variant }}
        run: |
          cd kernel
          
          # Remove any existing KernelSU
          rm -rf KernelSU drivers/kernelsu
          
          case "${{ matrix.variant }}" in
            "tiann")
              echo "üì¶ Setting up tiann/KernelSU (Official)..."
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              ;;
            "kowsu")
              echo "üì¶ Setting up KOWX712/KernelSU (KowSU)..."
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              ;;
            "mksu")
              echo "üì¶ Setting up 5ec1cff/KernelSU (MKSU)..."
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              ;;
          esac
          
          # Clone KernelSU (shallow for speed initially)
          git clone --depth=1 --branch=$KSU_BRANCH \
            "https://github.com/$KSU_REPO" KernelSU
          
          # Get accurate version by unshallowing
          cd KernelSU
          echo "üìä Getting accurate commit count..."
          git fetch --unshallow 2>/dev/null || git fetch --depth=10000 2>/dev/null || true
          KSU_COUNT=$(git rev-list --count HEAD)
          KSU_VERSION=$((KSU_COUNT + 20000))
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "‚úÖ KernelSU version: r$KSU_VERSION (commits: $KSU_COUNT) from $KSU_REPO"
          cd ..
          
          # Setup KernelSU in kernel tree - use absolute path for symlink
          ln -sf "$(pwd)/KernelSU/kernel" drivers/kernelsu
          
          # Verify symlink was created correctly
          if [ -d "drivers/kernelsu" ] && [ -f "drivers/kernelsu/Kconfig" ]; then
            echo "‚úÖ KernelSU symlink created successfully"
            ls -la drivers/kernelsu/
          else
            echo "‚ùå KernelSU symlink failed, trying copy instead..."
            rm -rf drivers/kernelsu
            cp -r KernelSU/kernel drivers/kernelsu
            if [ -f "drivers/kernelsu/Kconfig" ]; then
              echo "‚úÖ KernelSU copied successfully"
            else
              echo "‚ùå KernelSU setup failed"
              exit 1
            fi
          fi
          
          # Add to Makefile if not present
          if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
          fi
          
          # Add to Kconfig if not present
          if ! grep -q "kernelsu" drivers/Kconfig; then
            sed -i '/endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
          fi

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "üì¶ Setting up SuSFS from submodule..."
          
          # Copy SuSFS files from submodule
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch - check for variant-specific first
          VARIANT_SUSFS_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_SUSFS_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_SUSFS_PATCH" ]; then
            echo "üìã Applying variant-specific SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_SUSFS_PATCH" || true
          else
            echo "üìã Applying default SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_SUSFS_PATCH" || true
          fi
          
          # Apply KernelSU-specific SuSFS patch - check for variant-specific first
          cd KernelSU
          VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
          DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          if [ -f "$VARIANT_KSU_PATCH" ]; then
            echo "üìã Applying variant-specific KSU SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
          else
            echo "üìã Applying default KSU SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
          fi
          cd ..

      - name: Apply Additional Patches
        run: |
          cd kernel
          
          # Apply common patches (non-SuSFS)
          if [ -d "../.github/patches/common" ]; then
            for patch in ../.github/patches/common/*.patch; do
              if [ -f "$patch" ]; then
                PATCH_NAME=$(basename "$patch")
                # Skip SuSFS patches (already applied)
                [[ "$PATCH_NAME" == "50_add_susfs"* ]] && continue
                [[ "$PATCH_NAME" == "10_enable_susfs"* ]] && continue
                echo "üìã Applying common patch: $PATCH_NAME"
                patch -p1 --forward < "$patch" || true
              fi
            done
          fi
          
          # Apply variant-specific patches (non-SuSFS)
          PATCH_DIR="../.github/patches/${{ matrix.variant }}"
          if [ -d "$PATCH_DIR" ]; then
            for patch in $PATCH_DIR/*.patch; do
              if [ -f "$patch" ]; then
                PATCH_NAME=$(basename "$patch")
                # Skip SuSFS patches (already applied)
                [[ "$PATCH_NAME" == "50_add_susfs"* ]] && continue
                [[ "$PATCH_NAME" == "10_enable_susfs"* ]] && continue
                echo "üìã Applying ${{ matrix.variant }} patch: $PATCH_NAME"
                patch -p1 --forward < "$patch" || true
              fi
            done
          fi

      - name: Apply Remote Patches
        run: |
          cd kernel
          
          # CLIDR fix (essential for all variants)
          echo "üìã Applying fix-clidr-uninitialized.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" \
            -o /tmp/fix-clidr.patch
          patch -p1 --forward < /tmp/fix-clidr.patch || true
          
          # Note: fix_proc_base.patch is already integrated into the 50_add_susfs patch

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Base configuration
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_NET_SCH_CAKE=y
          EOF
          
          # Variant-specific config
          case "${{ matrix.variant }}" in
            "tiann")
              echo 'CONFIG_LOCALVERSION="-deepongi-ksu"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "kowsu")
              echo 'CONFIG_LOCALVERSION="-deepongi-kowsu"' >> out/.config
              # Add KowSU-specific configs here
              ;;
            "mksu")
              echo 'CONFIG_LOCALVERSION="-deepongi-mksu"' >> out/.config
              # Add MKSU-specific configs here
              ;;
          esac
          
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            cat >> out/.config << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          fi
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

      - name: Build Kernel
        run: |
          # Source local .zshrc for ccache settings
          if [ -f "$HOME/.zshrc" ]; then
            source "$HOME/.zshrc" || true
          fi
          
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          # Force ccache usage
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          # Ensure ccache is using our local directory
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          
          START_TIME=$SECONDS
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "üßπ Performing clean build (ccache will still be used)..."
            make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
          fi
          
          echo "üèóÔ∏è Building kernel for ${{ matrix.variant }}..."
          make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out 2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          echo "BUILD_TIME=${BUILD_TIME}s" >> $GITHUB_ENV
          echo "‚è±Ô∏è Build completed in ${BUILD_TIME}s"

      - name: Check CCACHE Performance
        run: |
          echo "üìà CCACHE stats AFTER build:"
          ccache -s
          
          # Get final hit rate
          FINAL_HIT_RATE=$(ccache -s | grep -i "cache hit rate" | grep -Eo "[0-9]+\.[0-9]+" || echo "0.0")
          echo "FINAL_HIT_RATE=${FINAL_HIT_RATE}%" >> $GITHUB_ENV
          echo "üíæ Final hit rate: ${FINAL_HIT_RATE}%"
          
          # Show final cache size
          CACHE_SIZE=$(du -sh ${{ env.CCACHE_DIR }} | cut -f1)
          echo "üì¶ Final cache size: $CACHE_SIZE"
          
          # Show cache stats
          echo "üìä Detailed cache statistics:"
          ccache -s | grep -E "(hits|misses|cache size|files in cache)"

      - name: Package Kernel
        run: |
          # Clone AnyKernel3
          git clone --depth=1 --branch=KernelSU \
            https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          # Copy SuSFS module if enabled
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ] && [ -d "../susfs4ksu/ksu_module_susfs" ]; then
            mkdir -p modules
            cp -r ../susfs4ksu/ksu_module_susfs/* modules/
          fi
          
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS.zip"
          else
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ matrix.variant }}-build-${{ github.run_number }}
          name: "${{ matrix.variant }} Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with ${{ matrix.variant == 'tiann' && 'KernelSU' || matrix.variant == 'kowsu' && 'KowSU' || 'MKSU' }}
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Info
            | Property | Value |
            |----------|-------|
            | **Variant** | ${{ matrix.variant }} |
            | **KernelSU Source** | ${{ env.KSU_REPO }} |
            | **KernelSU Version** | r${{ env.KSU_VERSION }} |
            | **SuSFS** | ${{ env.ENABLE_SUSFS == 'true' && '‚úÖ Enabled' || '‚ùå Disabled' }} |
            | **Build Time** | ${{ env.BUILD_TIME }} |
            | **CCACHE Hit Rate** | ${{ env.FINAL_HIT_RATE }} |
            | **Cache Type** | üñ•Ô∏è Local Only (No GitHub Actions Cache) |
            
            ### üì¶ Installation
            1. Flash `${{ env.KERNEL_ZIP }}` in custom recovery
            2. Reboot and enjoy!
            
            ### üîê Checksums
            See attached `.sha256` and `.md5` files
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}