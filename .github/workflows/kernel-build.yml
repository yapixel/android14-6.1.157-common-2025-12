name: Build GKI Kernel with KernelSU

on:
  workflow_dispatch:
    inputs:
      disable_susfs:
        description: 'Disable SuSFS features (default: enabled)'
        required: true
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: true
        default: false
        type: boolean
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  CCACHE_MAXSIZE: 50G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Build Config
        id: config
        run: |
          # Default: SuSFS enabled
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
              ENABLE_SUSFS=false
            fi
            if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
              FORCE_CLEAN=true
            fi
          fi
          
          echo "ENABLE_SUSFS=$ENABLE_SUSFS" >> $GITHUB_ENV
          echo "FORCE_CLEAN=$FORCE_CLEAN" >> $GITHUB_ENV
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "üîß Build configuration: SuSFS = $ENABLE_SUSFS, Clean Build = $FORCE_CLEAN"

      - name: Cache CCACHE Directory
        uses: actions/cache@v4
        with:
          path: /mnt/ccache/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('kernel/Makefile', 'kernel/arch/arm64/configs/gki_defconfig', 'susfs4ksu/**') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ hashFiles('kernel/Makefile', 'kernel/arch/arm64/configs/gki_defconfig', 'susfs4ksu/**') }}-
            ${{ runner.os }}-ccache-

      - name: Cache Kernel Source
        uses: actions/cache@v4
        with:
          path: kernel
          key: ${{ runner.os }}-kernel-${{ hashFiles('kernel/Makefile', 'kernel/Kconfig') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-kernel-${{ hashFiles('kernel/Makefile', 'kernel/Kconfig') }}-
            ${{ runner.os }}-kernel-

      - name: Cache SuSFS Source
        if: env.ENABLE_SUSFS == 'true'
        uses: actions/cache@v4
        with:
          path: susfs4ksu
          key: ${{ runner.os }}-susfs-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-susfs-

      - name: Cache Build Output
        uses: actions/cache@v4
        with:
          path: kernel/out
          key: ${{ runner.os }}-build-${{ hashFiles('kernel/Makefile', 'kernel/arch/arm64/configs/gki_defconfig', '**/.config', '**/*.patch') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('kernel/Makefile', 'kernel/arch/arm64/configs/gki_defconfig', '**/.config', '**/*.patch') }}-
            ${{ runner.os }}-build-

      - name: Check Kernel Source Updates
        id: kernel-check
        run: |
          echo "üîç Checking for kernel source updates..."
          
          if [ ! -d "kernel" ] || [ ! -f "kernel/Makefile" ]; then
            echo "üì• Kernel source not found, will clone"
            echo "needs_clone=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          cd kernel
          VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
          PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
          cd ..
          
          if [ "$VERSION" != "6" ] || [ "$PATCHLEVEL" != "1" ]; then
            echo "‚ö†Ô∏è Kernel source is wrong version ($VERSION.$PATCHLEVEL), will replace"
            echo "needs_clone=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if we can check for remote updates
          if [ -d "kernel/.git" ]; then
            cd kernel
            git fetch origin android14-6.1-2025-09
            LOCAL_COMMIT=$(git rev-parse HEAD)
            REMOTE_COMMIT=$(git rev-parse origin/android14-6.1-2025-09)
            
            if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
              echo "üîÑ New kernel commits available, will update"
              echo "needs_clone=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Kernel source is up to date"
              echo "needs_clone=false" >> $GITHUB_OUTPUT
            fi
            cd ..
          else
            echo "‚ö†Ô∏è Kernel source is not a git repo, will clone fresh"
            echo "needs_clone=true" >> $GITHUB_OUTPUT
          fi

      - name: Get Kernel Source
        if: steps.kernel-check.outputs.needs_clone == 'true'
        run: |
          echo "üì• Cloning fresh kernel source..."
          rm -rf kernel
          git clone --depth=1 --branch=android14-6.1-2025-09 \
            https://github.com/aosp-mirror/kernel_common kernel
          echo "‚úÖ Kernel source cloned successfully"

      - name: Check SuSFS Updates
        id: susfs-check
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "üîç Checking for SuSFS updates..."
          
          if [ ! -d "susfs4ksu" ]; then
            echo "üì• SuSFS source not found, will clone"
            echo "needs_susfs_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if susfs4ksu is a git repo and has updates
          if [ -d "susfs4ksu/.git" ]; then
            cd susfs4ksu
            git fetch origin
            LOCAL_COMMIT=$(git rev-parse HEAD)
            REMOTE_COMMIT=$(git rev-parse origin/gki-android14-6.1)
            
            if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
              echo "üîÑ New SuSFS commits available, will update"
              echo "needs_susfs_update=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ SuSFS source is up to date"
              echo "needs_susfs_update=false" >> $GITHUB_OUTPUT
            fi
            cd ..
          else
            echo "‚ö†Ô∏è SuSFS source is not a git repo, will use existing"
            echo "needs_susfs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update SuSFS Source
        if: env.ENABLE_SUSFS == 'true' && steps.susfs-check.outputs.needs_susfs_update == 'true'
        run: |
          echo "üì• Updating SuSFS source..."
          rm -rf susfs4ksu
          git clone --depth=1 --branch=gki-android14-6.1 \
            https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
          rm -rf susfs4ksu/.git
          echo "‚úÖ SuSFS source updated successfully"

      - name: Clean ABI Exports
        run: |
          cd kernel
          echo "üßπ Cleaning ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true
          echo "‚úÖ ABI exports cleaned"

      - name: Setup KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          cd KernelSU
          KSU_COUNT=$(git rev-list --count HEAD)
          echo "KSU_VERSION=$((KSU_COUNT + 20000))" >> $GITHUB_ENV

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          patch -p1 --forward < "../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" || true
          cd KernelSU
          patch -p1 --forward < "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || true
          cd ..
          
          # Apply proc base fix patch (SuSFS related)
          echo "üìã Applying fix_proc_base.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix_proc_base.patch" -o fix_proc_base.patch
          patch -p1 --forward < fix_proc_base.patch || true
          rm fix_proc_base.patch

      - name: Apply Essential Patches
        run: |
          cd kernel
          
          # Always apply CLIDR fix patch
          echo "üìã Applying fix-clidr-uninitialized.patch (essential)"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" -o fix-clidr-uninitialized.patch
          patch -p1 --forward < fix-clidr-uninitialized.patch || true
          rm fix-clidr-uninitialized.patch

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Setup and Verify CCACHE
        id: ccache
        run: |
          echo "üîß Setting up and verifying CCACHE..."
          
          # Setup CCACHE environment
          export PATH="/usr/lib/ccache:$PATH"
          echo "‚úÖ Added CCACHE to PATH"
          
          # Check if CCACHE directory exists and is accessible
          CCACHE_DIR="/mnt/ccache/.ccache"
          echo "üìÅ Checking CCACHE directory: $CCACHE_DIR"
          if [ ! -d "$CCACHE_DIR" ]; then
            echo "‚ö†Ô∏è Creating CCACHE directory..."
            sudo mkdir -p "$CCACHE_DIR"
            sudo chown -R $USER:$USER "$CCACHE_DIR"
            echo "‚úÖ Created CCACHE directory"
          fi
          
          echo "üìä CCACHE directory size: $(du -sh $CCACHE_DIR | cut -f1)"
          
          # Configure CCACHE (without resetting)
          echo "‚öôÔ∏è Configuring CCACHE..."
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          echo "‚úÖ CCACHE configured"
          
          # Check CCACHE binary and version
          echo "üîß Checking CCACHE binary..."
          if command -v ccache &> /dev/null; then
            echo "‚úÖ CCACHE found: $(which ccache)"
            echo "üìã CCACHE version: $(ccache --version | head -1)"
          else
            echo "‚ùå CCACHE not found in PATH"
            exit 1
          fi
          
          # Show current stats BEFORE build
          echo "üìà CCACHE stats BEFORE build:"
          ccache -s
          
          # Get initial hit rate for reporting
          HIT_RATE=$(ccache -s | grep -i "cache hit" | head -1 | grep -Eo "[0-9]+\.[0-9]+%" || echo "0%")
          CACHE_SIZE=$(ccache -s | grep -i "cache size" | head -1)
          echo "INITIAL_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV
          echo "INITIAL_CACHE_SIZE=$CACHE_SIZE" >> $GITHUB_ENV
          
          echo "‚úÖ CCACHE setup complete - cache preserved for incremental builds"

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"

          # Always start with fresh config for consistency
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          BASE_CONFIG="CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
          CONFIG_KSU_ALLOWLIST_WORKAROUND=n
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION=\"-deepongi+\"
          CONFIG_NET_SCH_CAKE=y"

          # Default: SuSFS enabled, only disable if explicitly requested
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            SUSFS_CONFIG="CONFIG_KSU_SUSFS=y
            CONFIG_KSU_SUSFS_SUS_PATH=y
            CONFIG_KSU_SUSFS_SUS_MOUNT=y
            CONFIG_KSU_SUSFS_SUS_KSTAT=y
            CONFIG_KSU_SUSFS_TRY_UMOUNT=y
            CONFIG_KSU_SUSFS_SPOOF_UNAME=y
            CONFIG_KSU_SUSFS_ENABLE_LOG=y
            CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
            CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
            CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
            CONFIG_KSU_SUSFS_SUS_MAP=y"
            echo "$BASE_CONFIG" >> out/.config
            echo "$SUSFS_CONFIG" >> out/.config
          else
            echo "$BASE_CONFIG" >> out/.config
          fi

          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

      - name: Analyze Build Dependencies
        id: build-analysis
        run: |
          cd kernel
          echo "üîç Analyzing build dependencies for incremental build..."
          
          # Check if we can safely do incremental build
          BUILD_TYPE="full"
          REASON=""
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            BUILD_TYPE="clean"
            REASON="manual clean build requested"
          elif [ ! -f "out/.config" ]; then
            BUILD_TYPE="full"
            REASON="missing kernel configuration"
          elif [ ! -f "out/include/generated/autoconf.h" ]; then
            BUILD_TYPE="full" 
            REASON="missing autoconf headers"
          else
            # Check for configuration changes
            CONFIG_CHANGED=$(find . -name "*.config" -newer out/.config 2>/dev/null | wc -l)
            PATCHES_CHANGED=$(find ../ -name "*.patch" -newer out/.config 2>/dev/null | wc -l)
            SOURCE_CHANGED=$(find . -name "*.[chS]" -newer out/.config 2>/dev/null | head -5 | wc -l)
            
            if [ "$CONFIG_CHANGED" -gt 0 ]; then
              BUILD_TYPE="full"
              REASON="kernel configuration changed"
            elif [ "$PATCHES_CHANGED" -gt 0 ]; then
              BUILD_TYPE="full" 
              REASON="patches were updated"
            elif [ "$SOURCE_CHANGED" -gt 0 ]; then
              BUILD_TYPE="incremental"
              REASON="source files modified, safe for incremental build"
            else
              BUILD_TYPE="incremental"
              REASON="no changes detected, using cached build objects"
            fi
          fi
          
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV
          echo "BUILD_REASON=$REASON" >> $GITHUB_ENV
          echo "üîß Build analysis: $BUILD_TYPE - $REASON"

      - name: Smart Kernel Build
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CC="ccache clang"

          START_TIME=$SECONDS
          
          case "${{ env.BUILD_TYPE }}" in
            "clean")
              echo "üßπ Performing clean build..."
              make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
              make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out 2>&1 | tee build.log
              ;;
            "full")
              echo "üèóÔ∏è Performing full build..."
              make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out 2>&1 | tee build.log
              ;;
            "incremental")
              echo "üîÑ Performing incremental build..."
              make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out 2>&1 | tee build.log
              ;;
          esac
          
          BUILD_TIME=$((SECONDS - START_TIME))
          echo "BUILD_TIME=${BUILD_TIME}s" >> $GITHUB_ENV
          echo "BUILD_STRATEGY=${{ env.BUILD_TYPE }}" >> $GITHUB_ENV

      - name: Check CCACHE Performance
        run: |
          echo "üìà CCACHE stats AFTER build:"
          ccache -s
          
          FINAL_HIT_RATE=$(ccache -s | grep -i "cache hit" | head -1 | grep -Eo "[0-9]+\.[0-9]+%" || echo "0%")
          FINAL_CACHE_SIZE=$(ccache -s | grep -i "cache size" | head -1)
          echo "FINAL_HIT_RATE=$FINAL_HIT_RATE" >> $GITHUB_ENV
          echo "FINAL_CACHE_SIZE=$FINAL_CACHE_SIZE" >> $GITHUB_ENV
          
          # Calculate cache efficiency
          echo "üéØ CCACHE Performance Summary:"
          echo "   Initial Hit Rate: ${{ env.INITIAL_HIT_RATE }}"
          echo "   Final Hit Rate: $FINAL_HIT_RATE"
          echo "   Cache Size: $FINAL_CACHE_SIZE"
          echo "   Build Strategy: ${{ env.BUILD_STRATEGY }}"
          echo "   Build Reason: ${{ env.BUILD_REASON }}"

      - name: Get Changes
        id: changes
        run: |
          CHANGES=$(git log --oneline --pretty=format:"‚Ä¢ %s" -n 5 2>/dev/null || echo "‚Ä¢ Initial build")
          CHANGES="${CHANGES//'%'/'%25'}"
          CHANGES="${CHANGES//$'\n'/'%0A'}"
          echo "CHANGES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package Kernel
        run: |
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github
          
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          if [ "${{ env.ENABLE_SUSFS }}" = "true" ] && [ -d "../susfs4ksu/ksu_module_susfs" ]; then
            mkdir -p modules
            cp -r ../susfs4ksu/ksu_module_susfs/* modules/
          fi

          TIMESTAMP=$(date +%Y%m%d-%H%M)
          
          # Different ZIP names based on SuSFS status
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-6.1.145-KSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS-${{ env.BUILD_STRATEGY }}.zip"
          else
            ZIP_NAME="AK3-6.1.145-KSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}-NOSUSFS-${{ env.BUILD_STRATEGY }}.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
          retention-days: 30

      - name: Create Release
        if: success() && (github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Info
            - **Build Time:** ${{ env.BUILD_TIME }}
            - **Build Strategy:** ${{ env.BUILD_STRATEGY }} (${{ env.BUILD_REASON }})
            - **CCACHE Hit Rate:** ${{ env.FINAL_HIT_RATE }} (Initial: ${{ env.INITIAL_HIT_RATE }})
            - **CCACHE Size:** ${{ env.FINAL_CACHE_SIZE }}
            - **SuSFS:** ${{ env.ENABLE_SUSFS == 'true' && '‚úÖ Enabled (default)' || '‚ùå Disabled (manual trigger)' }}
            - **KernelSU Version:** r${{ env.KSU_VERSION }}
            
            ### üìà Recent Changes
            ${{ steps.changes.outputs.CHANGES }}
            
            ### üì¶ Installation
            1. Flash `${{ env.KERNEL_ZIP }}` in custom recovery
            2. Reboot and enjoy!
            
            ### üîê Verification
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}