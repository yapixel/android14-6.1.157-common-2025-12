name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Weekly upstream sync

env:
  # Use your local self-hosted toolchain paths
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  CCACHE_MAXSIZE: 50G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  sync-upstream:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Sync Kernel with Upstream
        run: |
          cd kernel
          git remote add upstream https://android.googlesource.com/kernel/common 2>/dev/null || true
          git fetch upstream android14-6.1-2025-09
          
          # Check if we're behind upstream
          if ! git merge-base --is-ancestor HEAD upstream/android14-6.1-2025-09; then
            echo "üîÑ New upstream changes available, merging..."
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git merge upstream/android14-6.1-2025-09 --no-edit
            cd ..
            git add kernel
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git commit -m "chore: sync kernel with upstream changes" || echo "No changes to commit"
            git push origin main
          else
            echo "‚úÖ Kernel already up to date with upstream"
          fi

  build-previous:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      previous_build_time: ${{ steps.previous-time.outputs.previous_build_time }}
    steps:
      - name: Get Previous Build Time
        id: previous-time
        run: |
          echo "previous_build_time=N/A" >> $GITHUB_OUTPUT

  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90
    needs: build-previous

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Patch setlocalversion Script
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion
          echo "‚úÖ setlocalversion patched to prevent dirty flag"

      - name: Integrate KernelSU & Generate Version
        run: |
          cd kernel
          
          # Install KernelSU if not already present
          if [ ! -d "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          fi
          
          # Enter the KernelSU folder
          cd KernelSU
          
          # Unshallow only if it is actually shallow
          if [ "$(git rev-parse --is-shallow-repository)" = "true" ]; then
            echo "‚ö†Ô∏è KernelSU is shallow, unshallowing..."
            git fetch --unshallow
          else
            echo "‚úÖ KernelSU is already deep cloned."
          fi
          
          # Count commits and calculate version
          KSU_COUNT=$(git rev-list --count HEAD)
          echo "KernelSU Commit Count: $KSU_COUNT"
          
          # Add your offset (e.g., 20000 + commit count)
          KSU_VERSION=$((KSU_COUNT + 20000))
          
          # Export to ENV for the next steps
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "‚úÖ Calculated KernelSU Version: $KSU_VERSION"

      - name: Copy SuSFS Files from Local Folder
        run: |
          echo "üìÅ Copying SuSFS files from local susfs4ksu folder to kernel..."
          
          # Copy SuSFS source files to kernel from kernel_patches
          if [ -f "susfs4ksu/kernel_patches/fs/susfs.c" ]; then
            cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
            echo "‚úÖ Copied susfs.c to kernel/fs/"
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
            echo "‚úÖ Copied susfs.h to kernel/include/linux/"
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs_def.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
            echo "‚úÖ Copied susfs_def.h to kernel/include/linux/"
          fi
          
          echo "‚úÖ SuSFS files integrated from local folder"

      - name: Apply Local Patches
        id: patches
        run: |
          set +e
          echo "üîß Applying patches from local susfs4ksu/kernel_patches folder..."

          apply_patch() {
            patch_file=$1
            target_dir=$2
            if [ -f "$patch_file" ]; then
              echo "üìã Applying $(basename $patch_file) to $target_dir"
              cd "$target_dir"
              if patch -p1 --forward --no-backup-if-mismatch < "../$patch_file"; then
                echo "‚úÖ Applied $(basename $patch_file)"
                cd ..
                return 0
              else
                echo "‚ö†Ô∏è Patch $(basename $patch_file) may already be applied or partially applied"
                cd ..
                return 0
              fi
            else
              echo "‚ùå Patch file not found: $patch_file"
              return 1
            fi
          }

          # Apply main SuSFS integration patch to kernel
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" ]; then
            apply_patch "susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" "kernel"
          else
            echo "‚ùå Main SuSFS patch not found"
          fi

          # Apply CLIDR fix patch
          if [ -f "susfs4ksu/kernel_patches/fix-clidr-uninitialized.patch" ]; then
            apply_patch "susfs4ksu/kernel_patches/fix-clidr-uninitialized.patch" "kernel"
          fi

          # Apply KernelSU SuSFS enablement patch
          if [ -f "susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" ] && [ -d "kernel/KernelSU" ]; then
            apply_patch "susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" "kernel/KernelSU"
          else
            echo "‚ö†Ô∏è KernelSU SuSFS patch not found or KernelSU directory missing"
          fi

          set -e
          echo "üéâ Local patches applied!"

      - name: Setup CCACHE Environment
        run: |
          echo "üîß Setting up CCACHE environment..."
          
          # Ensure ccache is available in PATH
          export PATH="/usr/lib/ccache:$PATH"
          
          # Create ccache directory if it doesn't exist
          mkdir -p "${{ env.CCACHE_DIR }}"
          
          # Apply your local ccache configurations
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          
          # Verify ccache configuration
          echo "üìä CCACHE configuration:"
          ccache -p
          
          # Clear stats to start fresh measurement
          ccache -z
          
          echo "‚úÖ CCACHE environment configured"

      - name: Configure Kernel
        id: config
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"

          echo "‚öôÔ∏è Generating kernel config..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          echo "üîß Applying custom configurations..."
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION="-deepongi+"
          EOF

          rm -vf android/abi_gki_protected_exports_* || true
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "‚úÖ Kernel configured"
          grep -E "CONFIG_(KSU|SUSFS|LTO|LOCALVERSION)" out/.config | head -100

      - name: Build Kernel
        id: build
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export KBUILD_BUILD_TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          export KBUILD_BUILD_USER=github-actions
          export KBUILD_BUILD_HOST=github

          # Explicitly set CC to use ccache
          export CC="ccache clang"

          NPROC=$(nproc || echo 8)

          echo "üèóÔ∏è Building kernel using $NPROC cores..."
          echo "üìä CCACHE stats before build:"
          ccache -s

          START_TIME=$SECONDS

          make -j"$NPROC" \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}" \
            CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
            CC="$CC" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out 2>&1 | tee build.log

          BUILD_STATUS=${PIPESTATUS[0]}
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))

          echo "üìä CCACHE stats after build:"
          ccache -s

          if [ $BUILD_STATUS -eq 0 ] && [ -f out/arch/arm64/boot/Image ]; then
            echo "‚úÖ Built kernel in ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
          else
            echo "‚ùå Kernel build failed after ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ github.run_number }}
          path: |
            kernel/build.log
            kernel/out/.config
          retention-days: 30

      - name: Verify CCACHE Integration
        run: |
          echo "üîç Verifying CCACHE integration..."
          
          # Check if ccache is found and working
          if which ccache >/dev/null 2>&1; then
            echo "‚úÖ CCACHE found: $(which ccache)"
            echo "‚úÖ CCACHE version: $(ccache --version | head -1)"
          else
            echo "‚ùå CCACHE not in PATH"
            exit 1
          fi
          
          # Show comprehensive stats
          echo "üìä CCACHE configuration:"
          ccache -p | grep -E "(max_size|sloppiness|compression|cache_dir)" | head -10
          
          echo "üìà CCACHE statistics:"
          ccache -s
          
          echo "‚úÖ CCACHE is properly integrated and working"

      - name: Extract Build Metadata
        if: success()
        run: |
          # Get CCACHE hit rate
          CCACHE_HIT_RATE=$(ccache -s | grep -E "hit rate|Hit rate" | head -1 | sed 's/.*://' | tr -d ' ' || echo "N/A")
          echo "CCACHE_HIT_RATE=$CCACHE_HIT_RATE" >> $GITHUB_ENV
          
          # Determine build speed status
          if [ $BUILD_TIME -lt 300 ]; then
            BUILD_SPEED="üöÄ Very Fast"
          elif [ $BUILD_TIME -lt 600 ]; then
            BUILD_SPEED="‚ö° Fast"
          elif [ $BUILD_TIME -lt 900 ]; then
            BUILD_SPEED="‚úÖ Normal"
          else
            BUILD_SPEED="üê¢ Slow"
          fi
          echo "BUILD_SPEED_STATUS=$BUILD_SPEED" >> $GITHUB_ENV
          
          # Try to get SuSFS version/commit
          if [ -d "susfs4ksu" ]; then
            cd susfs4ksu
            SUSFS_VERSION=$(git log -1 --format="%h (%s)" 2>/dev/null || echo "local-gki-android14-6.1")
            echo "SUSFS_VERSION=$SUSFS_VERSION" >> $GITHUB_ENV
            cd ..
          fi
          
          echo "‚úÖ Build metadata extracted"

      - name: Get Changes Since Last Build
        if: success()
        id: changes
        run: |
          echo "üìù Fetching changes from upstream repositories..."
          
          # Initialize changes variable
          ALL_CHANGES=""
          
          # Get KernelSU changes from tiann/KernelSU
          echo "üîß Fetching KernelSU changes from tiann/KernelSU main branch..."
          KSU_CHANGES=""
          if [ -d "kernel/KernelSU" ]; then
            cd kernel/KernelSU
            # Add upstream if not exists
            git remote add upstream https://github.com/tiann/KernelSU.git 2>/dev/null || true
            if git fetch upstream main 2>/dev/null; then
              KSU_COMMITS=$(git log --oneline --pretty=format:"‚Ä¢ KSU: %s" upstream/main..HEAD 2>/dev/null | head -8)
              if [ -n "$KSU_COMMITS" ]; then
                KSU_CHANGES="$KSU_COMMITS"
              else
                KSU_CHANGES="‚Ä¢ KSU: Up to date with upstream"
              fi
            else
              KSU_CHANGES="‚Ä¢ KSU: Unable to fetch upstream changes"
            fi
            KSU_COUNT=$(echo "$KSU_CHANGES" | grep -c "‚Ä¢ KSU:" || true)
            KSU_CHANGES="### üîß KernelSU Changes ($KSU_COUNT commits)\n$KSU_CHANGES"
            cd ../..
          else
            KSU_CHANGES="### üîß KernelSU Changes\n‚Ä¢ KSU: Repository not available"
          fi
          
          # Get Android kernel changes from common repo
          echo "üêß Fetching Android kernel changes from common android14-6.1-2025-09..."
          KERNEL_CHANGES=""
          if [ -d "kernel" ]; then
            cd kernel
            git remote add upstream https://android.googlesource.com/kernel/common 2>/dev/null || true
            if git fetch upstream android14-6.1-2025-09 2>/dev/null; then
              KERNEL_COMMITS=$(git log --oneline --pretty=format:"‚Ä¢ Kernel: %s" upstream/android14-6.1-2025-09..HEAD 2>/dev/null | head -8)
              if [ -n "$KERNEL_COMMITS" ]; then
                KERNEL_CHANGES="$KERNEL_COMMITS"
              else
                KERNEL_CHANGES="‚Ä¢ Kernel: Up to date with upstream"
              fi
            else
              KERNEL_CHANGES="‚Ä¢ Kernel: Unable to fetch upstream changes"
            fi
            KERNEL_COUNT=$(echo "$KERNEL_CHANGES" | grep -c "‚Ä¢ Kernel:" || true)
            KERNEL_CHANGES="### üêß Android Kernel Changes ($KERNEL_COUNT commits)\n$KERNEL_CHANGES"
            cd ..
          else
            KERNEL_CHANGES="### üêß Android Kernel Changes\n‚Ä¢ Kernel: Repository not available"
          fi
          
          # Get local repository changes
          echo "üìÅ Checking local repository changes..."
          LOCAL_CHANGES=$(git log --oneline --pretty=format:"‚Ä¢ Local: %s" -n 5 2>/dev/null || echo "‚Ä¢ Local: Changes not available")
          LOCAL_COUNT=$(echo "$LOCAL_CHANGES" | grep -c "‚Ä¢ Local:" || true)
          LOCAL_CHANGES="### üìù Local Repository Changes ($LOCAL_COUNT commits)\n$LOCAL_CHANGES"
          
          # Combine all changes
          ALL_CHANGES=$(echo -e "$KSU_CHANGES\n\n$KERNEL_CHANGES\n\n$LOCAL_CHANGES")
          
          # Format for GitHub output
          ALL_CHANGES="${ALL_CHANGES//'%'/'%25'}"
          ALL_CHANGES="${ALL_CHANGES//$'\n'/'%0A'}"
          echo "CHANGES_SINCE_LAST_BUILD<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üìù Changes summary generated:"
          echo "KSU: $KSU_COUNT commits | Kernel: $KERNEL_COUNT commits | Local: $LOCAL_COUNT commits"

      - name: Prepare AnyKernel3
        if: success()
        run: |
          for i in {1..3}; do
            if git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3; then
              break
            fi
            echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
            rm -rf AnyKernel3
            sleep 5
          done
          cd AnyKernel3
          rm -rf .git .github

          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          # Copy KSU SuSFS module if available
          if [ -d "../susfs4ksu/ksu_module_susfs" ]; then
            echo "üì¶ Adding KSU SuSFS module to AnyKernel3..."
            mkdir -p modules
            cp -r ../susfs4ksu/ksu_module_susfs/* modules/
            echo "‚úÖ KSU SuSFS module added"
          fi

          cat > build.info << EOF
          build.date=$(date -u +%Y-%m-%d)
          build.time=$(date -u +%H:%M:%S)
          build.commit=${{ github.sha }}
          build.run=${{ github.run_number }}
          build.duration=${{ env.BUILD_TIME }}s
          EOF

          echo "‚úÖ AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          KERNEL_VERSION="6.1.145"
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          ZIP_NAME="GKI-KernelSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}.zip"

          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"

          cd ..
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"

          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "üì¶ Package created: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"

      - name: Upload Kernel Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU & SuSFS
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Performance
            - **Compilation Time:** ${{ env.BUILD_TIME_MIN }}m ${{ env.BUILD_TIME_SEC }}s (${{ env.BUILD_SPEED_STATUS }})
            - **Previous Build Time:** ${{ needs.build-previous.outputs.previous_build_time }}
            - **CCACHE Hit Rate:** ${{ env.CCACHE_HIT_RATE }}
            
            ### üîß Components Versions
            - **KernelSU Version:** r${{ env.KSU_VERSION }}
            - **SuSFS Version:** ${{ env.SUSFS_VERSION }}
            - **Kernel Base:** 6.1.145-deepongi+
            - **Toolchain:** Clang 22.0.0 + ARM GNU Toolchain 14.3
            
            ### üìà Changes Since Last Build
            **Sources:**
            - üîß [KernelSU](https://github.com/tiann/KernelSU) (main branch)
            - üêß [Android Common Kernel](https://android.googlesource.com/kernel/common/) (android14-6.1-2025-09)
            - üìù Local repository changes
            
            ${{ steps.changes.outputs.CHANGES_SINCE_LAST_BUILD }}
            
            ### üõ†Ô∏è Build Configuration
            - **LTO:** ThinLTO enabled
            - **Optimization:** -O2 with performance tuning
            - **Architecture:** ARM64 with Cortex-X3/A715/A510 optimization
            - **Security:** KernelSU LSM hooks + SuSFS hiding
            - **Includes:** KSU SuSFS module for root hiding
            
            ### üì¶ Installation
            1. Download the ZIP file below
            2. Verify checksums (SHA256/MD5)
            3. Boot to custom recovery (TWRP/OrangeFox)
            4. Flash the ZIP file
            5. Reboot and enjoy!
            
            ### üîê File Verification
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```
            
            ### üìã Technical Details
            - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - **Commit:** ${{ github.sha }}
            - **Runner:** Self-hosted (${{ runner.os }})
            - **Workflow Run:** ${{ github.run_id }}
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}