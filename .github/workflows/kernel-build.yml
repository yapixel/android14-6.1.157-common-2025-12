name: Build GKI Kernel with KernelSU Variants (by deepongi@deepongi-labs)

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
      enable_telegram:
        description: 'Enable Telegram notifications'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  MAKE_JOBS: 8

jobs:
  setup:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
      build_start_time: ${{ steps.timestamp.outputs.start_time }}
      create_release: ${{ steps.config.outputs.create_release }}
    steps:
      - name: Set Workflow Start Time
        run: |
          echo "WORKFLOW_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "::notice::Workflow started at $(date)"
      - name: Record Build Start Time
        id: timestamp
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "ðŸ• Build started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸŽ¯ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          CREATE_RELEASE=true
          
          if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
            ENABLE_SUSFS=false
          fi
          if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
            FORCE_CLEAN=true
          fi
          if [ "${{ github.event.inputs.create_release }}" = "false" ]; then
            CREATE_RELEASE=false
          fi
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT
          echo "create_release=$CREATE_RELEASE" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}
    
    outputs:
      tiann_zip: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      tiann_size: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      tiann_md5: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      tiann_sha256: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      tiann_kernel_version: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      tiann_ksu_version: ${{ contains(matrix.variant, 'tiann') && steps.generate-file-info.outputs.VARIANT == 'tiann' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      kowsu_zip: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      kowsu_size: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      kowsu_md5: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      kowsu_sha256: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      kowsu_kernel_version: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      kowsu_ksu_version: ${{ contains(matrix.variant, 'kowsu') && steps.generate-file-info.outputs.VARIANT == 'kowsu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      mksu_zip: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.ZIP_NAME || '' }}
      mksu_size: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.FILE_SIZE || '' }}
      mksu_md5: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.MD5_HASH || '' }}
      mksu_sha256: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.SHA256_HASH || '' }}
      mksu_kernel_version: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.KERNEL_VERSION || '' }}
      mksu_ksu_version: ${{ contains(matrix.variant, 'mksu') && steps.generate-file-info.outputs.VARIANT == 'mksu' && steps.generate-file-info.outputs.KSU_VERSION || '' }}
      
      duration: ${{ steps.build-duration.outputs.duration || env.BUILD_TIME || 'Unknown' }}

    steps:
      - name: Checkout with Submodules
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          clean: false

      - name: Initialize and Update Submodules with Correct Branches
        run: |
          echo "ðŸ“¦ Initializing submodules..."
          git submodule init
          
          echo "ðŸ“¥ Updating kernel submodule..."
          # Use --remote to fetch the branch specified in .gitmodules
          git submodule update --init --recursive --remote kernel
          
          echo "ðŸ“¥ Updating susfs4ksu submodule..."
          # Use --remote to fetch the branch specified in .gitmodules
          git submodule update --init --recursive --remote susfs4ksu
          
          echo "âœ… All submodules initialized with correct branches"

      - name: Verify Submodules
        run: |
          echo "ðŸ“‹ Submodule status:"
          git submodule status
          echo "ðŸŽ¯ Kernel branch:"
          cd kernel && git branch -v && cd ..

      - name: Clean Kernel Directory Properly
        run: |
          echo "ðŸ§¹ Properly cleaning kernel directory..."
          if [ -d "kernel" ]; then
            cd kernel
            # Remove any KernelSU and patches
            rm -rf KernelSU drivers/kernelsu
            # Hard reset to remove all changes
            git reset --hard HEAD
            git clean -fdx
            cd ..
          fi
          echo "âœ… Kernel directory fully reset"

      - name: Store Workflow Commit Info
        run: |
          WORKFLOW_COMMIT=$(git rev-parse HEAD)
          WORKFLOW_COMMIT_SHORT=$(git rev-parse --short HEAD)
          WORKFLOW_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          WORKFLOW_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "WORKFLOW_COMMIT=$WORKFLOW_COMMIT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_SHORT=$WORKFLOW_COMMIT_SHORT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_DATE=$WORKFLOW_COMMIT_DATE" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_MSG=$WORKFLOW_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ”– Workflow commit: $WORKFLOW_COMMIT_SHORT - $WORKFLOW_COMMIT_MSG"

      - name: Verify Kernel Source
        run: |
          if [ -f "kernel/Makefile" ]; then
            VERSION=$(grep "^VERSION" kernel/Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" kernel/Makefile | cut -d' ' -f3)
            echo "âœ… Kernel version: $VERSION.$PATCHLEVEL"
          else
            echo "âŒ Kernel not available"
            exit 1
          fi

      - name: Store Kernel Commit Info
        run: |
          cd kernel
          KERNEL_COMMIT=$(git rev-parse HEAD)
          KERNEL_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KERNEL_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KERNEL_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_SHORT=$KERNEL_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_DATE=$KERNEL_COMMIT_DATE" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_MSG=$KERNEL_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ”– Kernel commit: $KERNEL_COMMIT_SHORT - $KERNEL_COMMIT_MSG"

      - name: Verify SuSFS Source
        run: |
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "âœ… SuSFS verified"
          else
            echo "âŒ SuSFS not available"
            exit 1
          fi

      - name: Store SuSFS Commit Info
        run: |
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse HEAD)
          SUSFS_COMMIT_SHORT=$(git rev-parse --short HEAD)
          SUSFS_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          SUSFS_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_SHORT=$SUSFS_COMMIT_SHORT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_DATE=$SUSFS_COMMIT_DATE" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_MSG=$SUSFS_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ”– SuSFS commit: $SUSFS_COMMIT_SHORT - $SUSFS_COMMIT_MSG"

      - name: Show CCACHE Status
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "ðŸ“‚ CCACHE directory: $CCACHE_DIR"
          echo "ðŸ“ˆ CCACHE stats BEFORE build:"
          ccache -s | grep -E "(Cacheable calls|Hits|Misses|Hit rate|cache size)" || true

      - name: Setup KernelSU Variant
        run: |
          cd kernel

          # Remove any existing KernelSU
          rm -rf KernelSU drivers/kernelsu
          
          # Set variant-specific information
          case "${{ matrix.variant }}" in
            "tiann")
              echo "ðŸ“¦ Setting up Official KernelSU (tiann)..."
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              PATCH_DIR="KSU"
              ;;
            "kowsu")
              echo "ðŸ“¦ Setting up KowSU (KOWX712)..."
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              PATCH_DIR="KowSU"
              ;;
            "mksu")
              echo "ðŸ“¦ Setting up MKSU (5ec1cff)..."
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              PATCH_DIR="5ec1cff"
              ;;
          esac
          
          # Clone the KernelSU repository
          echo "ðŸ“¥ Cloning $KSU_REPO on branch $KSU_BRANCH..."
          git clone --depth=1 --branch=$KSU_BRANCH \
            https://github.com/$KSU_REPO.git KernelSU
          
          # Execute setup.sh from kernel source directory, passing current directory (.)
          echo "ðŸš€ Running setup.sh from kernel source..."
          if [ -f "KernelSU/kernel/setup.sh" ]; then
            chmod +x KernelSU/kernel/setup.sh
            ./KernelSU/kernel/setup.sh .
          else
            echo "âŒ KernelSU/kernel/setup.sh not found!"
            echo "ðŸ“ Available files in KernelSU:"
            find KernelSU -name "*.sh" -type f
            exit 1
          fi
          
          echo "PATCH_DIR=$PATCH_DIR" >> $GITHUB_ENV
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          
          echo "âœ… KernelSU setup completed for ${{ matrix.variant }}"

      - name: Get KSU Version Info
        run: |
          cd kernel/KernelSU
          
          echo "ðŸ“Š Unshallowing repository for accurate commit count..."
          # Unshallow the repository to get full history
          git fetch --unshallow --quiet || git fetch --depth=10000 --quiet || true
          
          echo "ðŸ”¢ Counting commits..."
          KSU_COUNT=$(git rev-list --count HEAD)
          KSU_VERSION=$((KSU_COUNT + 30000))
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_COUNT=$KSU_COUNT" >> $GITHUB_ENV
          echo "âœ… KernelSU version: r$KSU_VERSION (commits: $KSU_COUNT)"

      - name: Verify KernelSU Setup
        run: |
          cd kernel
          echo "ðŸ” Verifying KernelSU setup..."
          
          # Check if KernelSU files were created
          if [ -d "drivers/kernelsu" ]; then
            echo "âœ… KernelSU drivers directory created"
          else
            echo "âŒ KernelSU drivers directory not found"
            exit 1
          fi
          
          if [ -f ".config" ]; then
            echo "âœ… Kernel configuration exists"
            # Check if KSU is enabled in config
            if grep -q "CONFIG_KSU=y" .config || grep -q "CONFIG_KSU=m" .config; then
              echo "âœ… KernelSU configuration detected"
            else
              echo "âš ï¸ KernelSU not in config, may need manual enabling"
            fi
          fi

      - name: Store KernelSU Commit Info
        run: |
          cd kernel/KernelSU
          KSU_COMMIT=$(git rev-parse HEAD)
          KSU_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KSU_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KSU_COMMIT_MSG=$(git log -1 --format=%s)
          KSU_COMMIT_AUTHOR=$(git log -1 --format='%an')
          
          echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
          echo "KSU_COMMIT_SHORT=$KSU_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KSU_COMMIT_DATE=$KSU_COMMIT_DATE" >> $GITHUB_ENV
          echo "KSU_COMMIT_MSG=$KSU_COMMIT_MSG" >> $GITHUB_ENV
          echo "KSU_COMMIT_AUTHOR=$KSU_COMMIT_AUTHOR" >> $GITHUB_ENV
          
          echo "ðŸ”– KernelSU commit: $KSU_COMMIT_SHORT - $KSU_COMMIT_MSG"

      - name: Generate Comprehensive Changelog - ${{ matrix.variant }}
        run: |
          mkdir -p changelogs
          CHANGELOG_FILE="changelogs/CHANGELOG-${{ matrix.variant }}.md"
          
          echo "ðŸ“‹ Generating comprehensive changelog for ${{ matrix.variant }}..."
          
          # ============================================
          # HEADER SECTION
          # ============================================
          cat > "$CHANGELOG_FILE" << 'HEADER_EOF'
          # ðŸ“‹ Comprehensive Build Changelog
          
          HEADER_EOF
          
          # Add variant info
          case "${{ matrix.variant }}" in
            "tiann")
              echo "**Variant:** Official KernelSU (tiann)" >> "$CHANGELOG_FILE"
              ;;
            "kowsu")
              echo "**Variant:** KowSU Fork (KOWX712)" >> "$CHANGELOG_FILE"
              ;;
            "mksu")
              echo "**Variant:** MKSU Fork (5ec1cff)" >> "$CHANGELOG_FILE"
              ;;
          esac
          
          cat >> "$CHANGELOG_FILE" << HEADER_INFO
          **Build Number:** #${{ github.run_number }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **KernelSU Version:** r${{ env.KSU_VERSION }}
          **SuSFS:** ${{ env.ENABLE_SUSFS == 'true' && 'Enabled' || 'Disabled' }}
          
          ---
          
          HEADER_INFO
          
          # ============================================
          # COMPONENT VERSIONS TABLE
          # ============================================
          cat >> "$CHANGELOG_FILE" << 'TABLE_HEADER'
          ## ðŸ“– Component Versions
          
          | Component | Current Commit | Date | Summary |
          |-----------|---------------|------|---------|
          TABLE_HEADER
          
          echo "| **KernelSU (${{ matrix.variant }})** | \`${{ env.KSU_COMMIT_SHORT }}\` | ${{ env.KSU_COMMIT_DATE }} | ${{ env.KSU_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Kernel (android14-6.1-2025-12)** | \`${{ env.KERNEL_COMMIT_SHORT }}\` | ${{ env.KERNEL_COMMIT_DATE }} | ${{ env.KERNEL_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **SuSFS4KSU** | \`${{ env.SUSFS_COMMIT_SHORT }}\` | ${{ env.SUSFS_COMMIT_DATE }} | ${{ env.SUSFS_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Build Workflow** | \`${{ env.WORKFLOW_COMMIT_SHORT }}\` | ${{ env.WORKFLOW_COMMIT_DATE }} | ${{ env.WORKFLOW_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          # ============================================
          # CHECK FOR PREVIOUS BUILD
          # ============================================
          cd kernel/KernelSU
          PREVIOUS_TAG=$(git tag --list "${{ matrix.variant }}-build-*" --sort=-version:refname 2>/dev/null | head -n 1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # ============================================
            # INITIAL BUILD - Show recent commits
            # ============================================
            echo "## ðŸŽ‰ Initial Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "This is the first tracked build for the **${{ matrix.variant }}** variant. Below are the recent changes in each component:" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # KernelSU Recent Changes
            echo "### ðŸ”§ KernelSU - ${{ matrix.variant }} (Last 10 commits)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/${{ env.KSU_REPO }}" >> "../../$CHANGELOG_FILE"
            echo "**Branch:** ${{ env.KSU_BRANCH }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Kernel Recent Changes
            cd ../../kernel
            echo "### ðŸ§¬ Kernel - android14-6.1-2025-12 (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/aosp-mirror/kernel_common" >> "../$CHANGELOG_FILE"
            echo "**Branch:** android14-6.1-2025-12" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # SuSFS Recent Changes
            cd ../susfs4ksu
            echo "### ðŸ›¡ï¸ SuSFS4KSU (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "../$CHANGELOG_FILE"
            echo "**Branch:** gki-android14-6.1-dev" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # Workflow Recent Changes
            cd ..
            echo "### âš™ï¸ Build Workflow (Last 5 commits)" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Repository:** ${{ github.repository }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            git log -5 --pretty=format:"- **%h** - %s (%an, %ar)" -- .github/workflows/ >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            
            echo "---" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_This is the initial tracked build. Future builds will show detailed changes since the last build._" >> "$CHANGELOG_FILE"
            
          else
            # ============================================
            # SUBSEQUENT BUILD - Show changes since last build
            # ============================================
            echo "## ðŸ”„ Changes Since Last Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Previous Build:** \`$PREVIOUS_TAG\`" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Get previous commit from last build metadata
            PREV_KSU_COMMIT=$(git rev-parse "$PREVIOUS_TAG" 2>/dev/null || echo "")
            
            if [ -n "$PREV_KSU_COMMIT" ]; then
              COMMIT_RANGE="${PREV_KSU_COMMIT}..HEAD"
              KSU_CHANGE_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
            else
              KSU_CHANGE_COUNT="unknown"
              COMMIT_RANGE=""
            fi
            
            # KernelSU Changes
            echo "### ðŸ”§ KernelSU - ${{ matrix.variant }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            if [ -n "$COMMIT_RANGE" ] && [ "$KSU_CHANGE_COUNT" != "0" ]; then
              echo "**Changes:** $KSU_CHANGE_COUNT commit(s)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              git log $COMMIT_RANGE --pretty=format:"#### %h - %s%n%n**Author:** %an <%ae>  %n**Date:** %ad%n%n%b%n----%n" --date=format:'%Y-%m-%d %H:%M:%S' >> "../../$CHANGELOG_FILE"
            else
              echo "**Status:** No changes detected (or first build after tag migration)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              echo "_Current commit:_ \`${{ env.KSU_COMMIT_SHORT }}\` - ${{ env.KSU_COMMIT_MSG }}" >> "../../$CHANGELOG_FILE"
            fi
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Note: For kernel, SuSFS, and workflow - we'll show current state since we don't have previous tracking
            
            cd ../../kernel
            echo "### ðŸ§¬ Kernel - android14-6.1-2025-12" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.KERNEL_COMMIT_SHORT }}\` - ${{ env.KERNEL_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: Kernel tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ../susfs4ksu
            echo "### ðŸ›¡ï¸ SuSFS4KSU" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.SUSFS_COMMIT_SHORT }}\` - ${{ env.SUSFS_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: SuSFS tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ..
            echo "### âš™ï¸ Build Workflow" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.WORKFLOW_COMMIT_SHORT }}\` - ${{ env.WORKFLOW_COMMIT_MSG }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_Note: Workflow tracking will be enhanced in future builds. Showing current commit._" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
          fi
          
          # ============================================
          # FOOTER SECTION - Links and References
          # ============================================
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "## ðŸ”— Component Links" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### KernelSU (${{ matrix.variant }})" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ env.KSU_REPO }}" >> "$CHANGELOG_FILE"
          echo "- **Branch:** ${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ env.KSU_REPO }}/commit/${{ env.KSU_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Full History:** https://github.com/${{ env.KSU_REPO }}/commits/${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Kernel" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/aosp-mirror/kernel_common" >> "$CHANGELOG_FILE"
          echo "- **Branch:** android14-6.1-2025-12" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/aosp-mirror/kernel_common/commit/${{ env.KERNEL_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### SuSFS4KSU" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "$CHANGELOG_FILE"
          echo "- **Branch:** gki-android14-6.1-dev" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Build Workflow" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ github.repository }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ github.repository }}/commit/${{ env.WORKFLOW_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "_Generated automatically by GitHub Actions on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> "$CHANGELOG_FILE"
          
          # Tag this build for future reference
          cd kernel/KernelSU
          git tag "${{ matrix.variant }}-build-${{ github.run_number }}" 2>/dev/null || true
          
          cd ../..
          
          # Display preview
          echo "ðŸ“‹ Changelog preview (first 50 lines):"
          head -n 50 "$CHANGELOG_FILE" || cat "$CHANGELOG_FILE"
          
          echo "CHANGELOG_FILE=$CHANGELOG_FILE" >> $GITHUB_ENV
          
          echo "âœ… Comprehensive changelog generated successfully!"

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "ðŸ“¦ Setting up SuSFS..."
          
          # Copy SuSFS files
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch - check for variant-specific first
          VARIANT_SUSFS_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_SUSFS_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_SUSFS_PATCH" ]; then
            echo "ðŸ“‹ Applying variant-specific SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_SUSFS_PATCH" || true
          else
            echo "ðŸ“‹ Applying default SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_SUSFS_PATCH" || true
          fi
          
          # Apply KernelSU-specific SuSFS patch
          cd KernelSU
          VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
          DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          if [ -f "$VARIANT_KSU_PATCH" ]; then
            echo "ðŸ“‹ Applying variant-specific KSU SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
          else
            echo "ðŸ“‹ Applying default KSU SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
          fi
          
          # Apply LKM spoof patch after SuSFS patch
          LKM_SPOOF_PATCH="../../.github/patches/${{ matrix.variant }}/20-KernelSU-Spoof-LKM-mode-to-suppress-manager-warning.patch"
          if [ -f "$LKM_SPOOF_PATCH" ]; then
            echo "ðŸ“‹ Applying LKM spoof patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$LKM_SPOOF_PATCH" || true
          else
            echo "âš ï¸ LKM spoof patch not found: $LKM_SPOOF_PATCH"
          fi
          cd ..

      - name: Apply Remote Patches
        run: |
          cd kernel
          
          # CLIDR fix (essential for all variants)
          echo "ðŸ“‹ Applying fix-clidr-uninitialized.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" \
            -o /tmp/fix-clidr.patch
          patch -p1 --forward < /tmp/fix-clidr.patch || true

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Base configuration
          cat >> out/.config << 'EOF'
          # CPU & Architecture
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y

          # Performance & Debug
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y

          # Filesystem
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y

          # Compilation
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_LOCALVERSION_AUTO=n

          # Kprobes (important for KernelSU)
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          EOF
          
          # Variant-specific config
          case "${{ matrix.variant }}" in
            "tiann")
              echo 'CONFIG_LOCALVERSION="-deepongi"' >> out/.config
              echo 'CONFIG_KSU=y' >> out/.config
              echo 'CONFIG_KSU_DEBUG=y' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "kowsu")
              echo 'CONFIG_LOCALVERSION="-deepongi"' >> out/.config
              echo 'CONFIG_KSU=y' >> out/.config
              echo 'CONFIG_KSU_DEBUG=y' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config              ;;
            "mksu")
              echo 'CONFIG_LOCALVERSION="-deepongi"' >> out/.config
              echo 'CONFIG_KSU=y' >> out/.config
              echo 'CONFIG_KSU_DEBUG=y' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
          esac
          
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            cat >> out/.config << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=n
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          fi
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

      - name: Handle ABI File Changes
        run: |
          cd kernel
          
          # Remove ABI files as per KernelSU guide
          echo "ðŸ§¹ Removing ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true
          
          # Clean kernel build to ensure everything rebuilds
          echo "ðŸ§¹ Cleaning kernel build..."
          make -j$(nproc) LLVM=1 LLVM_IAS=1 LD=ld.lld HOSTLD=ld.lld O=out clean  # â¬…ï¸ Update this line
          
          echo "âœ… Ready for fresh build with modified ABI files"

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          START_TIME=$SECONDS
          
          # â¬‡ï¸ THIS IS WHERE YOU ADD THE CLEAN COMMAND â¬‡ï¸
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "ðŸ§¹ Performing clean build..."
            make -j$(nproc) LLVM=1 LLVM_IAS=1 LD=ld.lld O=out clean
          fi
          
          echo "ðŸ—¿ï¸ Building kernel for ${{ matrix.variant }}..."
          echo "ðŸ“‚ Using CCACHE at: $CCACHE_DIR"
          echo "ðŸ”§ Build configuration:"
          echo "  - ARCH: $ARCH"
          echo "  - CC: $CC"
          echo "  - LLVM: 1 (full LLVM toolchain for LTO)"
          echo "  - LLVM_IAS: 1 (LLVM integrated assembler)"
          echo "  - LD: ld.lld (LLVM linker)"
          
          # Build with full LLVM toolchain for LTO support
          make -j$(nproc) LLVM=1 LLVM_IAS=1 LD=ld.lld HOSTLD=ld.lld O=out CC="$CC" 2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_MINS=$((BUILD_TIME / 60))
          BUILD_SECS=$((BUILD_TIME % 60))
          echo "BUILD_TIME=${BUILD_MINS}m ${BUILD_SECS}s" >> $GITHUB_ENV

      - name: Record Build Duration
        id: build-duration
        run: |
          echo "duration=${{ env.BUILD_MINS || 'Unknown' }}m ${{ env.BUILD_SECS || 'Unknown' }}s" >> $GITHUB_OUTPUT

      - name: Check CCACHE Performance
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "ðŸ“ˆ CCACHE stats AFTER build:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Get full ccache stats
          ccache -s
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Extracting Performance Metrics..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Save ccache output to variable
          CCACHE_OUTPUT=$(ccache -s 2>&1)
          
          # Extract cache size - CCache 4.12.1 format - get ONLY first match
          FINAL_CACHE_SIZE=$(echo "$CCACHE_OUTPUT" | grep -m1 "^  Cache size" | sed 's/  Cache size (GB):[[:space:]]*//')
          
          # Extract hit rate from FIRST "Hits:" line only (skip Local storage section)
          # Use -m1 to get only the first match
          HIT_RATE=$(echo "$CCACHE_OUTPUT" | grep -m1 "^  Hits:" | sed -n 's/.*(\([0-9]\+\.[0-9]\+%\)).*/\1/p')
          
          # If not found, try alternative extraction
          if [ -z "$HIT_RATE" ] || [ "$HIT_RATE" = "" ]; then
            HIT_RATE=$(echo "$CCACHE_OUTPUT" | grep -m1 "^  Hits:" | awk -F'(' '{print $2}' | cut -d')' -f1)
          fi
          
          # Get cache hits and misses for detailed info - FIRST match only
          CACHE_HITS=$(echo "$CCACHE_OUTPUT" | grep -m1 "^  Hits:" | awk '{print $2}' | cut -d'/' -f1 | tr -d ' ')
          CACHE_MISSES=$(echo "$CCACHE_OUTPUT" | grep -m1 "^  Misses:" | awk '{print $2}' | cut -d'/' -f1 | tr -d ' ')
          
          # Calculate total calls
          CACHE_TOTAL=$((CACHE_HITS + CACHE_MISSES))
          
          echo "âœ… CCache v4.12.1 detected"
          echo "âœ… Cache hits: ${CACHE_HITS:-0}"
          echo "âœ… Cache misses: ${CACHE_MISSES:-0}"
          echo "âœ… Total calls: ${CACHE_TOTAL:-0}"
          
          if [ -n "$HIT_RATE" ] && [ "$HIT_RATE" != "" ]; then
            echo "âœ… Hit rate extracted: $HIT_RATE"
          else
            echo "âš ï¸  Could not extract hit rate, trying calculation method..."
            
            # Calculate manually if needed
            if [ -n "$CACHE_HITS" ] && [ -n "$CACHE_MISSES" ]; then
              if [ "$CACHE_TOTAL" -gt 0 ]; then
                HIT_RATE=$(awk "BEGIN {printf \"%.1f%%\", ($CACHE_HITS / $CACHE_TOTAL) * 100}")
                echo "âœ… Calculated hit rate: $HIT_RATE"
              else
                HIT_RATE="0%"
                echo "âš ï¸  No cacheable calls made"
              fi
            else
              HIT_RATE="N/A"
              echo "âŒ Could not extract hit/miss counts"
            fi
          fi
          
          # Clean up the HIT_RATE - remove any newlines or extra whitespace
          HIT_RATE=$(echo "$HIT_RATE" | tr -d '\n' | xargs)
          FINAL_CACHE_SIZE=$(echo "$FINAL_CACHE_SIZE" | tr -d '\n' | xargs)
          CACHE_HITS=$(echo "$CACHE_HITS" | tr -d '\n' | xargs)
          CACHE_MISSES=$(echo "$CACHE_MISSES" | tr -d '\n' | xargs)
          CACHE_TOTAL=$(echo "$CACHE_TOTAL" | tr -d '\n' | xargs)
          
          # Format for display in your desired format
          CCACHE_FORMATTED="${HIT_RATE} (Hits: ${CACHE_HITS}/Misses: ${CACHE_MISSES})"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Final Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¾ Cache Size: ${FINAL_CACHE_SIZE:-N/A}"
          echo "ðŸŽ¯ Total Hits: ${CCACHE_FORMATTED}"
          echo "ðŸ“Š Hit/Miss: ${CACHE_HITS:-0}/${CACHE_MISSES:-0}"
          echo "ðŸ“ˆ Total Calls: ${CACHE_TOTAL:-0}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Export to environment - ensure clean values
          echo "FINAL_CACHE_SIZE=${FINAL_CACHE_SIZE:-N/A}" >> $GITHUB_ENV
          echo "CCACHE_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV
          echo "CCACHE_HITS=${CACHE_HITS:-0}" >> $GITHUB_ENV
          echo "CCACHE_MISSES=${CACHE_MISSES:-0}" >> $GITHUB_ENV
          echo "CCACHE_TOTAL=${CACHE_TOTAL:-0}" >> $GITHUB_ENV
          echo "CCACHE_FORMATTED=${CCACHE_FORMATTED}" >> $GITHUB_ENV

      - name: Package Kernel
        run: |

          # Clean up any previous AnyKernel3 directory
          rm -rfv AnyKernel3 || true

          # Get kernel version from Makefile
          echo "ðŸ“‹ Extracting kernel version..."
          cd kernel
          KERNEL_VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3).$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3).$(grep "^SUBLEVEL" Makefile | cut -d' ' -f3)
          cd ..
          echo "âœ… Kernel version: $KERNEL_VERSION"
          
          # Determine which AnyKernel3 branch to use based on variant
          case "${{ matrix.variant }}" in
            "tiann")
              AK3_BRANCH="KernelSU"
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "ðŸ“¦ Using AnyKernel3 branch: KernelSU (for tiann variant)"
              ;;
            "kowsu")
              AK3_BRANCH="KowSU" 
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "ðŸ“¦ Using AnyKernel3 branch: KowSU (for kowsu variant)"
              ;;
            "mksu")
              AK3_BRANCH="MKSU"
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "ðŸ“¦ Using AnyKernel3 branch: MKSU (for mksu variant)"
              ;;
          esac
          
          # Clone the appropriate AnyKernel3 branch for this variant
          echo "ðŸ“¥ Cloning AnyKernel3 from $AK3_REPO on branch $AK3_BRANCH..."
          git clone --depth=1 --branch=$AK3_BRANCH \
            https://github.com/$AK3_REPO AnyKernel3
          
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          
          # Use both kernel version and KSU version in ZIP name
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-${KERNEL_VERSION}-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS.zip"
          else
            ZIP_NAME="AK3-${KERNEL_VERSION}-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-NOSUSFS.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          # Get file size
          FILE_SIZE=$(du -h "$ZIP_NAME" | cut -f1)
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          
          echo "âœ… Packaged kernel: $ZIP_NAME ($FILE_SIZE)"
          echo "ðŸ“‹ Using AnyKernel3 branch: $AK3_BRANCH from $AK3_REPO"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

      - name: Generate File Info for Release
        id: generate-file-info
        run: |
          # Get actual file size and MD5
          ACTUAL_SIZE=$(du -h "${{ env.KERNEL_ZIP }}" | cut -f1)
          MD5_HASH=$(md5sum "${{ env.KERNEL_ZIP }}" | awk '{print $1}')
          SHA256_HASH=$(sha256sum "${{ env.KERNEL_ZIP }}" | awk '{print $1}')
          
          # Set outputs
          echo "FILE_SIZE=${ACTUAL_SIZE}" >> $GITHUB_OUTPUT
          echo "MD5_HASH=${MD5_HASH}" >> $GITHUB_OUTPUT
          echo "SHA256_HASH=${SHA256_HASH}" >> $GITHUB_OUTPUT
          echo "VARIANT=${{ matrix.variant }}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${{ env.KERNEL_ZIP }}" >> $GITHUB_OUTPUT
          echo "KSU_VERSION=r${{ env.KSU_VERSION }}" >> $GITHUB_OUTPUT
          echo "KERNEL_VERSION=${{ env.KERNEL_VERSION }}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š File info for ${{ matrix.variant }}:"
          echo "   Size: ${ACTUAL_SIZE}"
          echo "   MD5: ${MD5_HASH}"
          echo "   SHA256: ${SHA256_HASH}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
            ${{ env.CHANGELOG_FILE }}
          retention-days: 30

  create_release:
    needs: [setup, build]
    runs-on: [self-hosted, Linux, X64]
    if: needs.setup.outputs.create_release == 'true' && success()
    outputs:
      duration: ${{ env.BUILD_DURATION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Build Duration
        run: |
          echo "ðŸ• Calculating build duration..."
          
          # Get start time from setup job output
          START_TIME="${{ needs.setup.outputs.build_start_time }}"
          echo "Start time from setup: $START_TIME"
          
          # Get current time
          END_TIME=$(date +%s)
          echo "End time: $END_TIME"
          
          if [ -n "$START_TIME" ] && [ "$START_TIME" != "null" ] && [ "$START_TIME" -gt 0 ]; then
            DURATION=$((END_TIME - START_TIME))
            DURATION_MINS=$((DURATION / 60))
            DURATION_SECS=$((DURATION % 60))
            
            if [ $DURATION_MINS -eq 0 ]; then
              BUILD_DURATION="${DURATION_SECS}s"
            else
              BUILD_DURATION="${DURATION_MINS}m ${DURATION_SECS}s"
            fi
            
            echo "âœ… Build duration: $BUILD_DURATION"
          else
            BUILD_DURATION="Unknown"
            echo "âš ï¸ Could not calculate duration (start time: $START_TIME)"
          fi
          
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          cd release-assets
          
          # Flatten directory structure
          find . -type f -exec mv {} . \; 2>/dev/null || true
          find . -type d -empty -delete
          
          echo "ðŸ“¦ Release assets:"
          ls -lh
          
          # Remove any old RELEASE_NOTES.md file (we'll generate fresh in the release step)
          rm -f RELEASE_NOTES.md 2>/dev/null || true
          
          # Count variants built
          VARIANT_COUNT=$(ls -1 CHANGELOG-*.md 2>/dev/null | wc -l)
          echo "VARIANT_COUNT=$VARIANT_COUNT" >> $GITHUB_ENV
          
          # Get build date
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          
          # Determine which variants were built
          VARIANTS_BUILT=""
          [ -f "CHANGELOG-tiann.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}tiann "
          [ -f "CHANGELOG-kowsu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}kowsu "
          [ -f "CHANGELOG-mksu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}mksu "
          VARIANTS_BUILT=$(echo "$VARIANTS_BUILT" | xargs)
          echo "VARIANTS_BUILT=$VARIANTS_BUILT" >> $GITHUB_ENV

      - name: Create Release with Enhanced Notes
        id: create_release
        run: |
          cd release-assets
          
          echo "ðŸ“ Generating enhanced release notes for GitHub Releases page..."
          
          # Get actual file data from job outputs
          TIANN_SIZE="${{ needs.build.outputs.tiann_size || 'Unknown' }}"
          TIANN_MD5="${{ needs.build.outputs.tiann_md5 || 'Unknown' }}"
          TIANN_SHA256="${{ needs.build.outputs.tiann_sha256 || 'Unknown' }}"
          TIANN_KSU_VERSION="${{ needs.build.outputs.tiann_ksu_version || 'Unknown' }}"
          TIANN_KERNEL_VERSION="${{ needs.build.outputs.tiann_kernel_version || '6.1.x' }}"
          TIANN_ZIP="${{ needs.build.outputs.tiann_zip || '' }}"
          
          KOWSU_SIZE="${{ needs.build.outputs.kowsu_size || 'Unknown' }}"
          KOWSU_MD5="${{ needs.build.outputs.kowsu_md5 || 'Unknown' }}"
          KOWSU_SHA256="${{ needs.build.outputs.kowsu_sha256 || 'Unknown' }}"
          KOWSU_KSU_VERSION="${{ needs.build.outputs.kowsu_ksu_version || 'Unknown' }}"
          KOWSU_KERNEL_VERSION="${{ needs.build.outputs.kowsu_kernel_version || '6.1.x' }}"
          KOWSU_ZIP="${{ needs.build.outputs.kowsu_zip || '' }}"
          
          MKSU_SIZE="${{ needs.build.outputs.mksu_size || 'Unknown' }}"
          MKSU_MD5="${{ needs.build.outputs.mksu_md5 || 'Unknown' }}"
          MKSU_SHA256="${{ needs.build.outputs.mksu_sha256 || 'Unknown' }}"
          MKSU_KSU_VERSION="${{ needs.build.outputs.mksu_ksu_version || 'Unknown' }}"
          MKSU_KERNEL_VERSION="${{ needs.build.outputs.mksu_kernel_version || '6.1.x' }}"
          MKSU_ZIP="${{ needs.build.outputs.mksu_zip || '' }}"
          
          # Find actual ZIP files
          [ -z "$TIANN_ZIP" ] && TIANN_ZIP=$(ls AK3-*-TIANN-*.zip 2>/dev/null | head -1 || echo "")
          [ -z "$KOWSU_ZIP" ] && KOWSU_ZIP=$(ls AK3-*-KowSU-*.zip 2>/dev/null | head -1 || echo "")
          [ -z "$MKSU_ZIP" ] && MKSU_ZIP=$(ls AK3-*-MKSU-*.zip 2>/dev/null | head -1 || echo "")
          
          # Use common kernel version
          COMMON_KERNEL_VERSION="$TIANN_KERNEL_VERSION"
          [ -z "$COMMON_KERNEL_VERSION" ] && COMMON_KERNEL_VERSION="6.1.x"
          
          # Extract CCache stats from build logs - using same method as Telegram
          CCACHE_HIT_RATE="N/A"
          CCACHE_HITS="0"
          CCACHE_MISSES="0"
          CCACHE_SIZE="N/A"
          
          for log in build-*.log; do
            if [ -f "$log" ]; then
              # Extract individual components like Telegram does
              CCACHE_HIT_RATE=$(grep "ðŸŽ¯ Hit Rate:" "$log" | tail -1 | cut -d':' -f2 | xargs || echo "N/A")
              CCACHE_HITS=$(grep "âœ… Cache hits:" "$log" | tail -1 | awk '{print $4}' | xargs || echo "0")
              CCACHE_MISSES=$(grep "âœ… Cache misses:" "$log" | tail -1 | awk '{print $4}' | xargs || echo "0")
              CCACHE_SIZE=$(grep "ðŸ’¾ Cache Size:" "$log" | tail -1 | cut -d':' -f2 | xargs || echo "N/A")
              
              # Break if we found data
              if [ "$CCACHE_HIT_RATE" != "N/A" ] || [ "$CCACHE_HITS" != "0" ]; then
                break
              fi
            fi
          done
          
          # Format CCache details like Telegram does
          if [ "$CCACHE_HITS" != "0" ] || [ "$CCACHE_MISSES" != "0" ]; then
            CCACHE_FORMATTED="${CCACHE_HIT_RATE} (${CCACHE_HITS} hits, ${CCACHE_MISSES} misses)"
          else
            CCACHE_FORMATTED="${CCACHE_HIT_RATE}"
          fi
          
          # Get last commit information
          LAST_COMMIT_HASH="${{ env.WORKFLOW_COMMIT_SHORT || 'unknown' }}"
          LAST_COMMIT_MESSAGE="${{ env.WORKFLOW_COMMIT_MSG || 'No commit message' }}"
          
          # Extract variant commit information from changelogs
          echo "ðŸ“‹ Extracting variant commit history from changelogs..."
          
          VARIANT_COMMITS=""
          
          # Function to extract commits from changelog
          extract_variant_commits() {
            local variant=$1
            local changelog="CHANGELOG-${variant}.md"
            
            if [ ! -f "$changelog" ]; then
              return
            fi
            
            # Check if this is an initial build or has changes
            if grep -q "## ðŸŽ‰ Initial Build" "$changelog"; then
              # Initial build - show last 5 commits
              COMMITS=$(grep -A 50 "### ðŸ”§ KernelSU - ${variant}" "$changelog" | grep "^- \*\*" | head -5)
              if [ -n "$COMMITS" ]; then
                VARIANT_COMMITS="${VARIANT_COMMITS}
          
          ### ${variant} (tiann/KernelSU)
          *Initial build - showing last 5 commits:*
          ${COMMITS}"
              fi
            elif grep -q "## ðŸ“„ Changes Since Last Build" "$changelog"; then
              # Has changes - extract the commit details
              CHANGE_COUNT=$(grep "**Changes:**" "$changelog" | grep -oE '[0-9]+ commit' | grep -oE '[0-9]+')
              
              if [ -n "$CHANGE_COUNT" ] && [ "$CHANGE_COUNT" != "0" ]; then
                # Extract commits between the KernelSU section and next ###
                COMMITS=$(sed -n '/### ðŸ”§ KernelSU/,/^### /p' "$changelog" | grep -A 200 "#### " | grep -B 1 "^----$" | grep -v "^----$" | head -20)
                
                if [ -n "$COMMITS" ]; then
                  # Format variant name properly
                  VARIANT_NAME=""
                  case "$variant" in
                    "tiann") VARIANT_NAME="tiann (Official KernelSU)" ;;
                    "kowsu") VARIANT_NAME="kowsu (KOWX712/KernelSU)" ;;
                    "mksu") VARIANT_NAME="mksu (5ec1cff/KernelSU)" ;;
                  esac
                  
                  VARIANT_COMMITS="${VARIANT_COMMITS}
          
          ### ${VARIANT_NAME}
          *${CHANGE_COUNT} commit(s) since last build:*
          
          ${COMMITS}"
                fi
              else
                # No changes
                VARIANT_NAME=""
                case "$variant" in
                  "tiann") VARIANT_NAME="tiann (Official KernelSU)" ;;
                  "kowsu") VARIANT_NAME="kowsu (KOWX712/KernelSU)" ;;
                  "mksu") VARIANT_NAME="mksu (5ec1cff/KernelSU)" ;;
                esac
                
                VARIANT_COMMITS="${VARIANT_COMMITS}
          
          ### ${VARIANT_NAME}
          *No changes since last build*"
              fi
            fi
          }
          
          # Extract commits for each built variant
          [ -f "CHANGELOG-tiann.md" ] && extract_variant_commits "tiann"
          [ -f "CHANGELOG-kowsu.md" ] && extract_variant_commits "kowsu"
          [ -f "CHANGELOG-mksu.md" ] && extract_variant_commits "mksu"
          
          # Build the release notes (no duplicate title, no build table)
          RELEASE_NOTES="**Build Date:** ${{ env.BUILD_DATE }}  
          **Build Time:** ${{ env.BUILD_DURATION }}  
          **CCache:** $CCACHE_FORMATTED  
          **Cache Size:** $CCACHE_SIZE GB  
          **Kernel Version:** $COMMON_KERNEL_VERSION  
          **SuSFS:** ${{ github.event.inputs.disable_susfs == 'true' && 'âŒ Disabled' || 'âœ… Enabled' }}  
          **Last Commit:** \`$LAST_COMMIT_HASH\` - \"$LAST_COMMIT_MESSAGE\"
          
          ---
          
          ## ðŸ“ Variant Updates${VARIANT_COMMITS}
          
          ---
          
          ## ðŸ“± Supported Devices
          - Pixel 8
          - Pixel 8a  
          - Pixel 8 Pro
          
          ## ðŸš€ Installation Methods
          
          ### **Method 1: Kernel Flasher (Recommended)**
          Download [Kernel Flasher v1.6.0](https://github.com/fatalcoder524/KernelFlasher/releases/tag/v1.6.0) and flash the AK3 zip directly.
          
          ### **Method 2: Manual Flash (Magiskboot)**
          \`\`\`bash
          # Extract kernel from AK3 zip
          unzip AK3-*.zip Image
          
          # Unpack stock boot image
          magiskboot unpack boot.img
          
          # Replace kernel
          mv -v Image kernel
          
          # Repack boot image
          magiskboot repack boot.img
          
          # Flash to device
          fastboot flash boot new-boot.img
          \`\`\`
          
          ---
          
          **ðŸ“– Changelogs:** [View detailed changelogs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **ðŸ› Report Issues:** [GitHub Issues](${{ github.server_url }}/${{ github.repository }}/issues)
          **ðŸ“¢ Telegram:** [@deepongi_labs](https://t.me/deepongi_labs)
          
          *Built with â¤ï¸ by GitHub Actions*"
          
          echo "âœ… Generated release notes with CCache: $CCACHE_FORMATTED"
          
          # Prepare files for release (exclude changelogs and build logs)
          echo "ðŸ“¦ Preparing release assets..."
          
          # Remove files we don't want in the release
          rm -f CHANGELOG-*.md build-*.log
          
          echo "ðŸ“‹ Files to be uploaded:"
          ls -lh
          
          # Create the release using GitHub CLI
          gh release create "build-${{ github.run_number }}" \
            --title "Android 16 Kernel Build #${{ github.run_number }}" \
            --notes "$RELEASE_NOTES" \
            --repo "${{ github.repository }}" \
            --draft=false \
            --prerelease=false \
            ./*
          
          echo "âœ… Release created: build-${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [setup, create_release, build]
    runs-on: [self-hosted, Linux, X64]
    if: always()
    steps:
      - name: Extract and Prepare Build Information
        if: always()
        id: extract-info
        run: |
          # Get variant info from setup output
          VARIANTS_BUILT="${{ needs.setup.outputs.matrix || '' }}"
          echo "VARIANTS_BUILT=${VARIANTS_BUILT}" >> $GITHUB_ENV
          
          # Get release creation status
          CREATE_RELEASE="${{ needs.setup.outputs.create_release || 'false' }}"
          echo "CREATE_RELEASE=${CREATE_RELEASE}" >> $GITHUB_ENV
          
          # Get duration from create_release job
          BUILD_DURATION="${{ needs.create_release.outputs.duration || 'Unknown' }}"
          echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
          
          # Determine which variants were actually built
          BUILT_VARIANTS=""
          [[ "${VARIANTS_BUILT}" == *"tiann"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}tiann "
          [[ "${VARIANTS_BUILT}" == *"kowsu"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}kowsu "
          [[ "${VARIANTS_BUILT}" == *"mksu"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}mksu "
          
          # Clean up and format variants
          BUILT_VARIANTS=$(echo "${BUILT_VARIANTS}" | xargs)
          echo "BUILT_VARIANTS_LIST=${BUILT_VARIANTS}" >> $GITHUB_ENV
          
          # Format variants with pipe separators for display
          if [ -n "${BUILT_VARIANTS}" ]; then
            VARIANTS_FORMATTED=$(echo "${BUILT_VARIANTS}" | sed 's/ / \| /g')
            VARIANT_COUNT=$(echo "${BUILT_VARIANTS}" | wc -w)
          else
            VARIANTS_FORMATTED="none"
            VARIANT_COUNT=0
          fi
          echo "VARIANTS_FORMATTED=${VARIANTS_FORMATTED}" >> $GITHUB_ENV
          echo "VARIANT_COUNT=${VARIANT_COUNT}" >> $GITHUB_ENV
          
          # Determine SUSFS status
          if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
            SUSFS_STATUS="âŒ Disabled"
          else
            SUSFS_STATUS="âœ… Enabled"
          fi
          echo "SUSFS_STATUS=${SUSFS_STATUS}" >> $GITHUB_ENV

      - name: Calculate Build Duration
        if: always()
        id: calculate-duration
        run: |
          # Try multiple methods to get build duration
          DURATION="Unknown"
          
          # Method 1: Use GitHub API to get run duration
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              DURATION_MS=$(echo "$RESPONSE_BODY" | grep -o '"run_duration_ms":[0-9]*' | cut -d':' -f2)
              
              if [ -n "$DURATION_MS" ] && [ "$DURATION_MS" != "null" ] && [ "$DURATION_MS" -gt 0 ]; then
                TOTAL_SECONDS=$((DURATION_MS / 1000))
                
                if [ $TOTAL_SECONDS -lt 60 ]; then
                  DURATION="${TOTAL_SECONDS}s"
                elif [ $TOTAL_SECONDS -lt 3600 ]; then
                  MINUTES=$((TOTAL_SECONDS / 60))
                  SECONDS=$((TOTAL_SECONDS % 60))
                  DURATION="${MINUTES}m ${SECONDS}s"
                else
                  HOURS=$((TOTAL_SECONDS / 3600))
                  MINUTES=$(( (TOTAL_SECONDS % 3600) / 60 ))
                  SECONDS=$((TOTAL_SECONDS % 60))
                  DURATION="${HOURS}h ${MINUTES}m ${SECONDS}s"
                fi
              fi
            fi
          fi
          
          echo "BUILD_DURATION=${DURATION}" >> $GITHUB_ENV

      - name: Get Kernel and KSU Versions
        if: always()
        id: get-versions
        run: |
          # Initialize version variables
          KERNEL_VERSION="${{ needs.build.outputs.tiann_kernel_version || '6.1.x' }}"
          
          # Get KSU versions from build outputs
          TIANN_KSU="${{ needs.build.outputs.tiann_ksu_version || 'Unknown' }}"
          KOWSU_KSU="${{ needs.build.outputs.kowsu_ksu_version || 'Unknown' }}"
          MKSU_KSU="${{ needs.build.outputs.mksu_ksu_version || 'Unknown' }}"
          
          # Set environment variables
          echo "KERNEL_VERSION=${KERNEL_VERSION}" >> $GITHUB_ENV
          echo "TIANN_KSU_VERSION=${TIANN_KSU}" >> $GITHUB_ENV
          echo "KOWSU_KSU_VERSION=${KOWSU_KSU}" >> $GITHUB_ENV
          echo "MKSU_KSU_VERSION=${MKSU_KSU}" >> $GITHUB_ENV

      - name: Get CCache Statistics
        if: always()
        id: get-ccache-stats
        run: |
          echo "ðŸ” Starting CCache statistics extraction..."
          
          # Initialize default values
          CCACHE_HIT_RATE="N/A"
          CCACHE_HITS="0"
          CCACHE_MISSES="0"
          CCACHE_SIZE="N/A"
          
          # Try to get ccache stats if ccache command exists
          if command -v ccache &> /dev/null; then
            CCACHE_STATS=$(ccache -s 2>&1 || true)
            
            if [ -n "$CCACHE_STATS" ]; then
              echo "âœ… CCache output received"
              
              # CCache 4.12.1 format - get only first match with -m1
              HIT_RATE=$(echo "$CCACHE_STATS" | grep -m1 "^  Hits:" | sed -n 's/.*(\([0-9]\+\.[0-9]\+%\)).*/\1/p' | head -1)
              
              # If not found, try alternative extraction
              if [ -z "$HIT_RATE" ] || [ "$HIT_RATE" = "" ]; then
                HIT_RATE=$(echo "$CCACHE_STATS" | grep -m1 "^  Hits:" | awk -F'(' '{print $2}' | cut -d')' -f1 | head -1)
              fi
              
              # Clean up the value - ensure it's a single line
              HIT_RATE=$(echo "$HIT_RATE" | tr -d '\n\r' | xargs)
              CCACHE_HIT_RATE="${HIT_RATE:-N/A}"
              echo "Extracted HIT_RATE: '$CCACHE_HIT_RATE'"
              
              # Get hits and misses - first match only
              HITS=$(echo "$CCACHE_STATS" | grep -m1 "^  Hits:" | awk '{print $2}' | cut -d'/' -f1 | tr -d ' ' | head -1 || echo "0")
              MISSES=$(echo "$CCACHE_STATS" | grep -m1 "^  Misses:" | awk '{print $2}' | cut -d'/' -f1 | tr -d ' ' | head -1 || echo "0")
              
              # Clean up values
              CCACHE_HITS=$(echo "${HITS:-0}" | tr -d '\n\r' | xargs)
              CCACHE_MISSES=$(echo "${MISSES:-0}" | tr -d '\n\r' | xargs)
              echo "Extracted HITS: '$CCACHE_HITS', MISSES: '$CCACHE_MISSES'"
              
              # Get cache size (CCache 4.12.1 format) - first match only
              SIZE_LINE=$(echo "$CCACHE_STATS" | grep -m1 "^  Cache size" || echo "")
              if [ -n "$SIZE_LINE" ]; then
                # Extract size: "Cache size (GB):   26.2 /   50.0 (52.36%)"
                SIZE=$(echo "$SIZE_LINE" | sed 's/  Cache size (GB):[[:space:]]*//' | awk '{print $1}' | head -1)
                CCACHE_SIZE=$(echo "${SIZE:-N/A}" | tr -d '\n\r' | xargs)
                echo "Extracted SIZE: '$CCACHE_SIZE'"
              fi
            else
              echo "âš ï¸ No CCache stats available"
            fi
          else
            echo "âš ï¸ CCache command not found"
          fi
          
          # Export to environment with clean values
          echo "CCACHE_HIT_RATE=$CCACHE_HIT_RATE" >> $GITHUB_ENV
          echo "CCACHE_HITS=$CCACHE_HITS" >> $GITHUB_ENV
          echo "CCACHE_MISSES=$CCACHE_MISSES" >> $GITHUB_ENV
          echo "CCACHE_SIZE=$CCACHE_SIZE" >> $GITHUB_ENV
          
          # Calculate emoji for hit rate
          # Remove % sign and convert to integer
          RATE_NUM=$(echo "$CCACHE_HIT_RATE" | sed 's/%//g' | awk '{print int($1+0.5)}' 2>/dev/null)
          echo "Parsed RATE_NUM: $RATE_NUM from '$CCACHE_HIT_RATE'"
          
          if [ -n "$RATE_NUM" ] && [ "$RATE_NUM" -eq "$RATE_NUM" ] 2>/dev/null; then
            if [ "$RATE_NUM" -ge 90 ]; then
              CCACHE_EMOJI="ðŸš€"
            elif [ "$RATE_NUM" -ge 70 ]; then
              CCACHE_EMOJI="âš¡"
            elif [ "$RATE_NUM" -ge 50 ]; then
              CCACHE_EMOJI="ðŸ“ˆ"
            elif [ "$RATE_NUM" -ge 20 ]; then
              CCACHE_EMOJI="ðŸ¢"
            else
              CCACHE_EMOJI="ðŸŒ"
            fi
          else
            CCACHE_EMOJI="â“"
          fi
          
          echo "CCACHE_EMOJI=$CCACHE_EMOJI" >> $GITHUB_ENV
          echo "Selected emoji: $CCACHE_EMOJI"

      - name: Debug CCache Output
        run: |
          echo "ðŸ” Raw CCache output:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ccache -s
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” CCache version:"
          ccache --version

      - name: Get Commit Information
        if: always()
        id: get-commit-info
        run: |
          # Try to get commit information
          COMMIT_HASH=""
          COMMIT_AUTHOR=""
          COMMIT_MESSAGE=""
          
          if command -v git &> /dev/null; then
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" 2>/dev/null || echo "unknown")
            COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" 2>/dev/null || echo "No commit message")
            
            if [ ${#COMMIT_MESSAGE} -gt 80 ]; then
              COMMIT_MESSAGE="${COMMIT_MESSAGE:0:77}..."
            fi
            
            COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/\\/\\\\/g; s/"/\\"/g; s/[_*`[]/\\&/g')
          fi
          
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=${COMMIT_AUTHOR}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=${COMMIT_MESSAGE}" >> $GITHUB_ENV

      - name: Send Success Notification
        if: ${{ needs.create_release.result == 'success' && needs.build.result == 'success' && github.event.inputs.enable_telegram == 'true' }}
        id: notify-success
        run: |
          CURRENT_TIME=$(date +"%H:%M")
          
          # Build KSU info from actual versions - CORRECTED with proper newlines
          KSU_INFO=""
          if [ -n "${{ env.TIANN_KSU_VERSION }}" ] && [ "${{ env.TIANN_KSU_VERSION }}" != "Unknown" ]; then
              KSU_INFO="âœ… *tiann:* ${{ env.TIANN_KSU_VERSION }}"
          fi
          if [ -n "${{ env.KOWSU_KSU_VERSION }}" ] && [ "${{ env.KOWSU_KSU_VERSION }}" != "Unknown" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
              âœ… *kowsu:* ${{ env.KOWSU_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *kowsu:* ${{ env.KOWSU_KSU_VERSION }}"
            fi
          fi
          if [ -n "${{ env.MKSU_KSU_VERSION }}" ] && [ "${{ env.MKSU_KSU_VERSION }}" != "Unknown" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
              âœ… *mksu:* ${{ env.MKSU_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *mksu:* ${{ env.MKSU_KSU_VERSION }}"
            fi
          fi
          
          # Get CCache hits and misses for more detailed info
          CCACHE_HITS="${{ env.CCACHE_HITS || '0' }}"
          CCACHE_MISSES="${{ env.CCACHE_MISSES || '0' }}"
          CCACHE_SIZE="${{ env.CCACHE_SIZE || 'N/A' }}"
          
          # Calculate total calls and format with descriptive text
          if [ "$CCACHE_HITS" -gt 0 ] || [ "$CCACHE_MISSES" -gt 0 ]; then
            TOTAL_CALLS=$((CCACHE_HITS + CCACHE_MISSES))
            CCACHE_DETAILS="${{ env.CCACHE_HIT_RATE || 'N/A' }} (${CCACHE_HITS} hits, ${CCACHE_MISSES} misses)"
          else
            CCACHE_DETAILS="${{ env.CCACHE_HIT_RATE || 'N/A' }}"
          fi
          
          BUILD_DURATION="${{ needs.create_release.outputs.duration || env.BUILD_DURATION || 'Unknown' }}"
          
          MESSAGE="ðŸš€ *Build #${{ github.run_number }} | SUCCESS*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          ðŸ“¦ *Variants:* ${{ env.VARIANT_COUNT }}/3 (${{ env.VARIANTS_FORMATTED }})
          â±ï¸ *Duration:* ${BUILD_DURATION}
          ðŸ›¡ï¸ *SuSFS:* ${{ env.SUSFS_STATUS }}
          ðŸ“± *Target:* Pixel 8a/8/8 Pro | Android 16 GKI

          ðŸ§¬ *Kernel Version:* ${{ env.KERNEL_VERSION }}
          ðŸŽ¯ *CCache Hit-Rate:* ${CCACHE_DETAILS} ${{ env.CCACHE_EMOJI }}
          ðŸ’¾ *Cache Size:* ${CCACHE_SIZE} GB

          ðŸ”§ *KSU Versions:*
          ${KSU_INFO}

          â¬‡ï¸ *Downloads:*
          [View Release](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})

          ðŸ“ *Commit:* \`${{ env.COMMIT_HASH }}\` by ${{ env.COMMIT_AUTHOR }}
          ðŸ’¬ *Message:* \"${{ env.COMMIT_MESSAGE }}\"

          ðŸ”— *Links:*
          â”œâ”€ [Release Page](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})
          â”œâ”€ [Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          â””â”€ [Download All](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})

          ðŸ•°ï¸ ${CURRENT_TIME} | GitHub Actions"
          
          echo "Generated message preview:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$MESSAGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Send with retry
          for ATTEMPT in 1 2 3; do
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true && break
            [ $ATTEMPT -lt 3 ] && sleep $((ATTEMPT * 2))
          done

      - name: Send Failure Notification
        if: ${{ (needs.create_release.result == 'failure' || needs.build.result == 'failure') && github.event.inputs.enable_telegram == 'true' }}
        id: notify-failure
        run: |
          CURRENT_TIME=$(date +"%H:%M")
          
          # Determine failure stage
          if [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_STAGE="Build Process"
            EMOJI="ðŸ”¨"
          elif [ "${{ needs.create_release.result }}" = "failure" ]; then
            FAILED_STAGE="Release Creation"
            EMOJI="ðŸ“¦"
          else
            FAILED_STAGE="Unknown Stage"
            EMOJI="â“"
          fi
          
          # Add duration context if failed early
          DURATION_CONTEXT="${{ env.BUILD_DURATION }}"
          if [ "$DURATION_CONTEXT" != "Unknown" ] && [[ "$DURATION_CONTEXT" == *"s" ]] && ! [[ "$DURATION_CONTEXT" == *"m"* ]]; then
            DURATION_CONTEXT="${DURATION_CONTEXT} (failed early)"
          fi
          
          MESSAGE="âŒ *Build #${{ github.run_number }} | FAILED*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          $EMOJI *Failed Stage:* ${FAILED_STAGE}
          â±ï¸ *Duration:* ${DURATION_CONTEXT}
          ðŸ“¦ *Target Variants:* ${{ env.VARIANTS_FORMATTED }}
          ðŸ›¡ï¸ *SuSFS:* ${{ env.SUSFS_STATUS }}

          ðŸ§¬ *Kernel Version:* ${{ env.KERNEL_VERSION }}
          ${{ env.CCACHE_EMOJI }} *CCache:* ${{ env.CCACHE_HIT_RATE }}

          ðŸš¨ *Error Details:*
          â€¢ Build process encountered an error
          â€¢ Check specific variant logs below
          â€¢ Last successful build: #$(({{ github.run_number }} - 1))

          ðŸ”— *Quick Actions:*
          â”œâ”€ [View Error Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          â”œâ”€ [Retry This Build](https://github.com/${{ github.repository }}/actions/workflows/build.yml)
          â””â”€ [Compare with #$(({{ github.run_number }} - 1))](https://github.com/${{ github.repository }}/compare/build-$(({{ github.run_number }} - 1))...build-${{ github.run_number }})

          ðŸ“ *Commit:* \`${{ env.COMMIT_HASH }}\` by ${{ env.COMMIT_AUTHOR }}

          ðŸ•°ï¸ ${CURRENT_TIME} | GitHub Actions"
          
          # Send with retry
          for ATTEMPT in 1 2 3; do
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true && break
            [ $ATTEMPT -lt 3 ] && sleep $((ATTEMPT * 2))
          done