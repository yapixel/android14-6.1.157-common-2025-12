name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  # Use your local self-hosted toolchain paths
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 5G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Cache CCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ github.ref }}-${{ hashFiles('.github/workflows/*.yml') }}-v1
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.ref }}-
            ${{ runner.os }}-ccache-
            ${{ runner.os }}-

      - name: Setup ccache
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "$(dirname $(which ccache))" >> $GITHUB_PATH
          ccache --zero-stats
          echo "üìä Initial CCACHE stats:"
          ccache --show-stats

      - name: Clone Kernel Source
        run: |
          rm -rf kernel
          git clone --depth=1 --branch=android14-6.1-2025-09 https://android.googlesource.com/kernel/common kernel
          cd ..

      - name: Patch setlocalversion Script
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion
          echo "‚úÖ setlocalversion patched to prevent dirty flag"

      - name: Integrate KernelSU
        run: |
          cd kernel
          for i in {1..3}; do
            if curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main; then
              echo "‚úÖ KernelSU integrated successfully"
              break
            fi
            echo "‚ö†Ô∏è KernelSU integration attempt $i failed, retrying..."
            sleep 10
          done

      - name: Clone and Integrate SuSFS
        run: |
          if [ ! -d "susfs" ]; then
            git clone --depth=1 --branch=gki-android14-6.1 https://gitlab.com/simonpunk/susfs4ksu.git susfs
          fi
          cd kernel
          cp ../susfs/kernel_patches/fs/susfs.c fs/
          cp ../susfs/kernel_patches/include/linux/susfs.h include/linux/
          cp ../susfs/kernel_patches/include/linux/susfs_def.h include/linux/
          echo "‚úÖ SuSFS files integrated"

            - name: Apply All Patches
        id: patches
        run: |
          set +e
          cd kernel

          PATCH_BASE="https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main"

          apply_patch_url() {
            url=$1
            dir=$2
            cd "$dir"
            for i in {1..3}; do
              if curl -fsSL "$url" | patch -p1 --forward --no-backup-if-mismatch; then
                echo "‚úÖ Applied $(basename $url) from URL"
                cd "${{ github.workspace }}/kernel"
                return 0
              fi
              echo "‚ö†Ô∏è Patch $(basename $url) attempt $i failed, retrying..."
              sleep 3
            done
            echo "‚ö†Ô∏è Patch $(basename $url) may already be applied or failed"
            cd "${{ github.workspace }}/kernel"
            return 0
          }

          apply_patch_file() {
            file=$1
            dir=$2
            cd "$dir"
            for i in {1..3}; do
              if patch -p1 --forward --no-backup-if-mismatch < "$file"; then
                echo "‚úÖ Applied $(basename $file) from file"
                cd "${{ github.workspace }}/kernel"
                return 0
              fi
              echo "‚ö†Ô∏è Patch $(basename $file) attempt $i failed, retrying..."
              sleep 3
            done
            echo "‚ö†Ô∏è Patch $(basename $file) may already be applied or failed"
            cd "${{ github.workspace }}/kernel"
            return 0
          }

          echo "üîß Applying 50_add_susfs_in_gki-android14-6.1.patch from infectedmushi..."
          apply_patch_url "$PATCH_BASE/50_add_susfs_in_gki-android14-6.1.patch" "."

          echo "üîß Applying KernelSU patch from susfs4ksu..."
          # Check if KernelSU directory exists and apply patch
          if [ -d "KernelSU" ]; then
            echo "üìÅ Found KernelSU directory, applying patch..."
            apply_patch_file "../susfs/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" "KernelSU"
          else
            echo "‚ùå KernelSU directory not found at kernel/KernelSU/"
            echo "üìÇ Current directory contents:"
            ls -la
            echo "üìÇ Looking for KernelSU..."
            find . -name "KernelSU" -type d 2>/dev/null
          fi

          set -e
          echo "üéâ All patches applied!"


      - name: Configure Kernel
        id: config
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"

          echo "‚öôÔ∏è Generating kernel config..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          echo "üîß Applying custom configurations..."
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION="-deepongi"
          EOF

          rm -vf android/abi_gki_protected_exports_* || true
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "‚úÖ Kernel configured"
          grep -E "CONFIG_(KSU|SUSFS|LTO|LOCALVERSION)" out/.config | head -20

      - name: Build Kernel
        id: build
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export KBUILD_BUILD_TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          export KBUILD_BUILD_USER=github-actions
          export KBUILD_BUILD_HOST=github

          NPROC=$(nproc || echo 8)

          echo "üèóÔ∏è Building kernel using $NPROC cores..."
          echo "üìä CCACHE stats before build:"
          ccache -s

          START_TIME=$SECONDS

          make -j"$NPROC" \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}" \
            CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
            CC="ccache clang" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out | tee build.log

          BUILD_STATUS=${PIPESTATUS[0]}
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))

          echo "üìä CCACHE stats after build:"
          ccache -s

          if [ $BUILD_STATUS -eq 0 ] && [ -f out/arch/arm64/boot/Image ]; then
            echo "‚úÖ Built kernel in ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
          else
            echo "‚ùå Kernel build failed after ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ github.run_number }}
          path: |
            kernel/build.log
            kernel/out/.config
          retention-days: 30

      - name: Prepare AnyKernel3
        if: success()
        run: |
          for i in {1..3}; do
            if git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3; then
              break
            fi
            echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
            rm -rf AnyKernel3
            sleep 5
          done
          cd AnyKernel3
          rm -rf .git .github

          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          cat > build.info << EOF
          build.date=$(date -u +%Y-%m-%d)
          build.time=$(date -u +%H:%M:%S)
          build.commit=${{ github.sha }}
          build.run=${{ github.run_number }}
          build.duration=${{ env.BUILD_TIME }}s
          EOF

          echo "‚úÖ AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          KERNEL_VERSION="6.1.145"
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          ZIP_NAME="GKI-KernelSU-SuSFS-${KERNEL_VERSION}-${TIMESTAMP}.zip"

          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"

          cd ..
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"

          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "üì¶ Package created: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"

      - name: Upload Kernel Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU & SuSFS
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Info
            - **Duration:** ${{ env.BUILD_TIME_MIN }}m ${{ env.BUILD_TIME_SEC }}s
            - **Kernel:** 6.1.145-deepongi
            - **Branch:** android14-6.1-2025-09
            - **Commit:** ${{ github.sha }}
            
            ### üîß Components
            - ‚úÖ **KernelSU** (main branch)
            - ‚úÖ **SuSFS** (gki-android14-6.1)
            - ‚úÖ **Clang 22.0.0** (ZyCromerZ)
            - ‚úÖ **LTO:** ThinLTO
            
            ### üì• Installation
            1. Download the ZIP file
            2. Verify checksums (SHA256/MD5)
            3. Boot to recovery (TWRP/OrangeFox)
            4. Flash the ZIP
            5. Reboot
            
            ### üîê Checksums
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
