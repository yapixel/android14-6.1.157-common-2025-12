name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
    inputs:
      susfs_version:
        description: 'SuSFS Version'
        required: true
        default: '2.0.0'
        type: string
      enable_susfs:
        description: 'Enable SuSFS features'
        required: true
        default: true
        type: boolean
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Weekly builds on Sunday

env:
  # Use your local self-hosted toolchain paths
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  CCACHE_MAXSIZE: 50G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  build-previous:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      previous_build_time: ${{ steps.previous-time.outputs.previous_build_time }}
    steps:
      - name: Get Previous Build Time
        id: previous-time
        run: |
          # Try to get the last successful build time from workflow artifacts or API
          PREVIOUS_TIME="N/A"
          
          # Method 1: Check if we can access previous workflow data
          if [ -f "/mnt/ccache/last_build_time" ]; then
            PREVIOUS_TIME=$(cat /mnt/ccache/last_build_time 2>/dev/null || echo "N/A")
            echo "ğŸ“Š Found previous build time: $PREVIOUS_TIME"
          else
            echo "â„¹ï¸ No previous build time recorded, first build?"
          fi
          
          # Store current build start time for next run
          echo "$(date +%s)" > /mnt/ccache/current_build_start || true
          
          echo "previous_build_time=$PREVIOUS_TIME" >> $GITHUB_OUTPUT

  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90
    needs: build-previous

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Set Build Configuration
        id: build-config
        run: |
          echo "ğŸ”§ Setting build configuration..."
          
          # Set SuSFS version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SUSFS_VERSION="${{ github.event.inputs.susfs_version }}"
            ENABLE_SUSFS="${{ github.event.inputs.enable_susfs }}"
            echo "âœ… Using manual configuration: SuSFS=$SUSFS_VERSION, Enabled=$ENABLE_SUSFS"
          else
            # For automatic builds, use defaults
            SUSFS_VERSION="2.0.0"
            ENABLE_SUSFS=true
            echo "âœ… Using default configuration: SuSFS=$SUSFS_VERSION, Enabled=$ENABLE_SUSFS"
          fi
          
          # Clean version string
          SUSFS_VERSION=$(echo "$SUSFS_VERSION" | sed 's/^v//')
          echo "ğŸ¯ Build Configuration:"
          echo "  SuSFS Version: $SUSFS_VERSION"
          echo "  SuSFS Enabled: $ENABLE_SUSFS"
          
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> $GITHUB_ENV
          echo "ENABLE_SUSFS=$ENABLE_SUSFS" >> $GITHUB_ENV
          echo "susfs_version=$SUSFS_VERSION" >> $GITHUB_OUTPUT
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT

      - name: Clean Submodule Configuration
        run: |
          echo "ğŸ§¹ Cleaning submodule configuration..."
          # Remove .gitmodules if it exists
          rm -f .gitmodules 2>/dev/null || true
          # Remove any submodule configs
          git config --remove-section submodule.kernel 2>/dev/null || true
          git config --remove-section submodule.susfs4ksu 2>/dev/null || true
          # Remove module directories
          rm -rf .git/modules/kernel 2>/dev/null || true
          rm -rf .git/modules/susfs4ksu 2>/dev/null || true
          echo "âœ… Submodule configuration cleaned"

      - name: Ensure Correct Kernel Source
        run: |
          echo "ğŸ”„ Ensuring correct Android 14 6.1 2025-09 kernel source..."
          
          # Check if local kernel exists and is correct version
          if [ -d "kernel" ] && [ -f "kernel/Makefile" ]; then
            echo "ğŸ” Checking existing kernel version..."
            cd kernel
            VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
            cd ..
            
            if [ "$VERSION" = "6" ] && [ "$PATCHLEVEL" = "1" ]; then
              echo "âœ… Local kernel is already correct version (6.1.x), skipping clone"
              exit 0
            else
              echo "âš ï¸ Local kernel is wrong version ($VERSION.$PATCHLEVEL), will replace"
            fi
          else
            echo "ğŸ“¥ No local kernel found or invalid, will clone"
          fi
          
          # Remove existing kernel directory if wrong version
          rm -rf kernel
          
          # Clone from AOSP mirror with the exact branch
          echo "ğŸ” Cloning from AOSP mirror - android14-6.1-2025-09 branch..."
          if git clone --depth=1 --branch=android14-6.1-2025-09 https://github.com/aosp-mirror/kernel_common kernel; then
            echo "âœ… Successfully cloned android14-6.1-2025-09 branch from AOSP mirror"
          else
            echo "âŒ CRITICAL: Failed to clone android14-6.1-2025-09 branch from AOSP mirror"
            echo "ğŸ’¡ Check if the branch exists: https://github.com/aosp-mirror/kernel_common/tree/android14-6.1-2025-09"
            exit 1
          fi
          
          # Remove .git to make it a regular directory
          rm -rf kernel/.git
          
          # Verify kernel version
          echo "ğŸ” Verifying kernel version..."
          cd kernel
          if [ -f "Makefile" ]; then
            VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
            SUBLEVEL=$(grep "^SUBLEVEL" Makefile | cut -d' ' -f3)
            echo "âœ… Kernel Version: $VERSION.$PATCHLEVEL.$SUBLEVEL"
            
            # Verify it's actually 6.1.x
            if [ "$VERSION" != "6" ] || [ "$PATCHLEVEL" != "1" ]; then
              echo "âŒ WRONG KERNEL VERSION! Expected 6.1.x, got $VERSION.$PATCHLEVEL.$SUBLEVEL"
              exit 1
            else
              echo "ğŸ¯ Correct kernel version: Android 14 6.1.xxx"
            fi
          else
            echo "âŒ Makefile not found - invalid kernel source"
            exit 1
          fi
          cd ..
          
          echo "ğŸ“Š Kernel source verified and ready"

      - name: Verify susfs4ksu Directory
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "ğŸ” Verifying susfs4ksu directory..."
          if [ ! -d "susfs4ksu" ]; then
            echo "âŒ susfs4ksu directory missing"
            exit 1
          fi
          # Remove any embedded git
          if [ -d "susfs4ksu/.git" ]; then
            rm -rf susfs4ksu/.git
            echo "âœ… Removed embedded git from susfs4ksu"
          fi
          echo "ğŸ“Š susfs4ksu contents:"
          ls -la susfs4ksu/ | head -5
          echo "âœ… susfs4ksu directory ready"

      - name: Patch setlocalversion Script
        run: |
          cd kernel
          if [ ! -f "scripts/setlocalversion" ]; then
            echo "âŒ scripts/setlocalversion not found"
            ls -la scripts/ | head -10
            exit 1
          fi
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion
          echo "âœ… setlocalversion patched to prevent dirty flag"

      - name: Integrate KernelSU & Generate Version
        run: |
          cd kernel
          
          echo "ğŸ”§ Installing KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          
          cd KernelSU
          
          # Ensure we have full history for version calculation
          if [ "$(git rev-parse --is-shallow-repository)" = "true" ]; then
            echo "ğŸ“¦ Unshallowing KernelSU repository..."
            git fetch --unshallow
          fi
          
          # Count commits and calculate version
          KSU_COUNT=$(git rev-list --count HEAD)
          echo "KernelSU Commit Count: $KSU_COUNT"
          KSU_VERSION=$((KSU_COUNT + 20000))
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "âœ… Calculated KernelSU Version: r$KSU_VERSION"

      - name: Copy SuSFS Files to Kernel
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "ğŸ“ Copying SuSFS files to kernel..."
          
          # Copy SuSFS source files
          if [ -f "susfs4ksu/kernel_patches/fs/susfs.c" ]; then
            cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
            echo "âœ… Copied susfs.c to kernel/fs/"
          else
            echo "âŒ susfs.c not found"
            ls -la susfs4ksu/kernel_patches/fs/ 2>/dev/null || echo "fs directory not found"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
            echo "âœ… Copied susfs.h to kernel/include/linux/"
          else
            echo "âŒ susfs.h not found"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs_def.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
            echo "âœ… Copied susfs_def.h to kernel/include/linux/"
          else
            echo "âŒ susfs_def.h not found"
            exit 1
          fi
          
          echo "âœ… All SuSFS files copied successfully"

      - name: Apply SuSFS Patches
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "ğŸ”§ Applying SuSFS patches..."
          
          # Apply main SuSFS integration patch
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" ]; then
            echo "ğŸ“‹ Applying 50_add_susfs_in_gki-android14-6.1.patch"
            cd kernel
            if patch -p1 --forward --no-backup-if-mismatch < "../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"; then
              echo "âœ… Main SuSFS patch applied"
            else
              echo "âš ï¸ Main SuSFS patch may already be applied"
            fi
            cd ..
          else
            echo "âŒ Main SuSFS patch not found"
            exit 1
          fi
          
          # Apply KernelSU SuSFS enablement patch
          if [ -f "susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" ] && [ -d "kernel/KernelSU" ]; then
            echo "ğŸ“‹ Applying 10_enable_susfs_for_ksu.patch to KernelSU"
            cd kernel/KernelSU
            patch -p1 --forward --no-backup-if-mismatch < "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || echo "âš ï¸ KernelSU patch may already be applied"
            cd ../..
          fi
          
          # Download and apply the CLIDR fix patch from external source
          echo "ğŸ“‹ Downloading and applying fix-clidr-uninitialized.patch"
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" -o fix-clidr-uninitialized.patch
          if [ -f "fix-clidr-uninitialized.patch" ]; then
            if patch -p1 --forward --no-backup-if-mismatch < "fix-clidr-uninitialized.patch"; then
              echo "âœ… CLIDR fix patch applied successfully"
              rm fix-clidr-uninitialized.patch
            else
              echo "âš ï¸ CLIDR fix patch may already be applied"
              rm fix-clidr-uninitialized.patch
            fi
          else
            echo "âŒ Failed to download CLIDR fix patch"
            exit 1
          fi
          
          # Download and apply the proc base fix patch (fourth patch)
          echo "ğŸ“‹ Downloading and applying fix_proc_base.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix_proc_base.patch" -o fix_proc_base.patch
          if [ -f "fix_proc_base.patch" ]; then
            if patch -p1 --forward --no-backup-if-mismatch < "fix_proc_base.patch"; then
              echo "âœ… proc base fix patch applied successfully"
              rm fix_proc_base.patch
            else
              echo "âš ï¸ proc base fix patch may already be applied"
              rm fix_proc_base.patch
            fi
          else
            echo "âŒ Failed to download proc base fix patch"
            exit 1
          fi
          cd ..
          
          echo "ğŸ‰ All 4 patches applied in correct order"

      - name: Setup CCACHE Environment
        run: |
          echo "ğŸ”§ Setting up CCACHE environment..."
          export PATH="/usr/lib/ccache:$PATH"
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache -z
          echo "ğŸ“Š CCACHE configuration:"
          ccache -p
          echo "âœ… CCACHE environment configured"

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"

          echo "âš™ï¸ Generating kernel configuration..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          echo "ğŸ”§ Applying custom configurations..."
          
          # Base configuration (common to both with and without SuSFS)
          BASE_CONFIG="CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
          CONFIG_KSU_ALLOWLIST_WORKAROUND=n
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION=\"-deepongi+\"
          CONFIG_NET_SCH_CAKE=y"
          
          # Add SuSFS config only if enabled
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            echo "âœ… Enabling SuSFS features in kernel config"
            SUSFS_CONFIG="CONFIG_KSU_SUSFS=y
            CONFIG_KSU_SUSFS_SUS_PATH=y
            CONFIG_KSU_SUSFS_SUS_MOUNT=y
            CONFIG_KSU_SUSFS_SUS_KSTAT=y
            CONFIG_KSU_SUSFS_TRY_UMOUNT=y
            CONFIG_KSU_SUSFS_SPOOF_UNAME=y
            CONFIG_KSU_SUSFS_ENABLE_LOG=y
            CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
            CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
            CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
            CONFIG_KSU_SUSFS_SUS_MAP=y"
            
            echo "$BASE_CONFIG" >> out/.config
            echo "$SUSFS_CONFIG" >> out/.config
          else
            echo "â„¹ï¸ Building without SuSFS features"
            echo "$BASE_CONFIG" >> out/.config
          fi

          rm -vf android/abi_gki_protected_exports_* || true
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "âœ… Kernel configured successfully"
          echo "ğŸ“‹ Key configurations:"
          grep -E "CONFIG_(KSU|SUSFS|LTO|LOCALVERSION)" out/.config
          
      - name: Prepare AnyKernel3
        if: success()
        run: |
          echo "ğŸ“¦ Preparing AnyKernel3..."
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github

          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          # Only include SuSFS module if enabled
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ] && [ -d "../susfs4ksu/ksu_module_susfs" ]; then
            echo "ğŸ“¦ Adding KSU SuSFS module..."
            mkdir -p modules
            cp -r ../susfs4ksu/ksu_module_susfs/* modules/
          fi

          cat > build.info << EOF
          build.date=$(date -u +%Y-%m-%d)
          build.time=$(date -u +%H:%M:%S)
          build.commit=${{ github.sha }}
          build.run=${{ github.run_number }}
          build.duration=${{ env.BUILD_TIME }}s
          build.ccache_hit_rate=${{ env.CCACHE_HIT_RATE }}
          build.susfs_version=${{ env.SUSFS_VERSION }}
          build.susfs_enabled=${{ env.ENABLE_SUSFS }}
          EOF

          echo "âœ… AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          # Include SuSFS status in filename
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-6.1.145-KSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}-susfs.zip"
          else
            ZIP_NAME="AK3-6.1.145-KSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}-nosusfs.zip"
          fi
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ Package created: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"