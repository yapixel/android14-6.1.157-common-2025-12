name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev \
            libncurses5-dev git wget curl lz4 zstd python3 python3-pip cpio kmod pahole pigz

      - name: Cache Toolchains
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/toolchain
          key: toolchains-v2-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            toolchains-v2-

      - name: Setup Custom Toolchain
        run: |
          set -e
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain

          # Download all toolchains in parallel if not cached
          (
            if [ ! -f "clang-toolchain.tar.gz" ]; then
              wget -q -O clang-toolchain.tar.gz "https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz" &
            fi
            if [ ! -f "gcc-arm64.tar.xz" ]; then
              wget -q -O gcc-arm64.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz" &
            fi
            if [ ! -f "gcc-arm32.tar.xz" ]; then
              wget -q -O gcc-arm32.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz" &
            fi
            wait
          )

          echo "Extracting toolchains..."
          rm -rf clang
          mkdir -p clang
          tar -xzf clang-toolchain.tar.gz -C clang &

          if [ ! -d "arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu" ]; then
            tar -xf gcc-arm64.tar.xz &
          fi

          if [ ! -d "arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi" ]; then
            tar -xf gcc-arm32.tar.xz &
          fi
          wait

          # Verify Clang
          if [ ! -d "clang/bin" ]; then
            echo "::error::Expected clang/bin directory, but it does not exist"
            find clang -maxdepth 3 -type d -print
            exit 1
          fi

          CLANG_BIN_DIR="$PWD/clang/bin"
          echo "CLANG_BIN=$CLANG_BIN_DIR" >> $GITHUB_ENV

          if [ ! -f "$CLANG_BIN_DIR/ld.lld" ]; then
            echo "::error::ld.lld not found in $CLANG_BIN_DIR"
            ls -la "$CLANG_BIN_DIR"
            exit 1
          fi

          echo "âœ“ Clang version:"
          "$CLANG_BIN_DIR/clang" --version | head -3

          # Set GCC toolchain paths
          ARM64_DIR=$(find . -maxdepth 1 -type d -name "*aarch64*" | head -1)
          if [ -z "$ARM64_DIR" ]; then
            echo "::error::ARM64 toolchain directory not found"
            exit 1
          fi
          echo "ARM64_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM64_DIR}/bin/aarch64-none-linux-gnu-" >> $GITHUB_ENV

          ARM32_DIR=$(find . -maxdepth 1 -type d -name "*arm-none*" | head -1)
          if [ -z "$ARM32_DIR" ]; then
            echo "::error::ARM32 toolchain directory not found"
            exit 1
          fi
          echo "ARM32_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM32_DIR}/bin/arm-none-eabi-" >> $GITHUB_ENV

          echo "âœ“ ARM64 GCC: $("${{ github.workspace }}/toolchain/${ARM64_DIR}/bin/aarch64-none-linux-gnu-gcc" --version | head -1)"
          echo "âœ“ Toolchain setup complete"

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: kernel-build-${{ github.ref }}-${{ github.run_number }}
          restore-keys: |
            kernel-build-${{ github.ref }}-
            kernel-build-
          max-size: 2G

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 --branch=android14-6.1-2025-09 https://android.googlesource.com/kernel/common kernel
          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Integrate KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          echo "âœ“ KernelSU integrated successfully"

      - name: Clone and Integrate SuSFS
        run: |
          git clone --depth=1 --branch=gki-android14-6.1 https://gitlab.com/simonpunk/susfs4ksu.git susfs
          cd kernel
          cp ${{ github.workspace }}/susfs/kernel_patches/fs/susfs.c fs/
          cp ${{ github.workspace }}/susfs/kernel_patches/include/linux/susfs.h include/linux/
          cp ${{ github.workspace }}/susfs/kernel_patches/include/linux/susfs_def.h include/linux/
          echo "âœ“ SuSFS files copied successfully"

      - name: Apply All Patches
        run: |
          set +e  # Disable exit on error for patch application
          cd kernel
          
          # Download all patches first
          echo "ðŸ“¥ Downloading patches..."
          curl -fsSL "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/fix-clidr-uninitialized.patch" -o /tmp/fix-clidr-uninitialized.patch
          curl -fsSL "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/10_enable_susfs_for_ksu.patch" -o /tmp/10_enable_susfs_for_ksu.patch
          curl -fsSL "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/50_add_susfs_in_gki-android14-6.1.patch" -o /tmp/50_add_susfs_in_gki-android14-6.1.patch
          curl -fsSL "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/fix_proc_base.patch" -o /tmp/fix_proc_base.patch
          
          # Apply patches (continue even if some fail)
          echo "ðŸ”§ Applying patches..."
          patch -p1 --forward --no-backup-if-mismatch < /tmp/fix-clidr-uninitialized.patch
          echo "fix-clidr-uninitialized.patch exit code: $?"
          
          if [ -d "KernelSU" ]; then
            cd KernelSU
            patch -p1 --forward --no-backup-if-mismatch < /tmp/10_enable_susfs_for_ksu.patch
            echo "10_enable_susfs_for_ksu.patch exit code: $?"
            cd ..
          fi
          
          patch -p1 --forward --no-backup-if-mismatch < /tmp/50_add_susfs_in_gki-android14-6.1.patch
          echo "50_add_susfs_in_gki-android14-6.1.patch exit code: $?"
          
          patch -p1 --forward --no-backup-if-mismatch < /tmp/fix_proc_base.patch
          echo "fix_proc_base.patch exit code: $?"
          
          # Clean up
          rm -f /tmp/*.patch
          set -e  # Re-enable exit on error
          echo "ðŸŽ‰ Patch application completed"

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64

          CLANG_BIN="${{ env.CLANG_BIN }}"
          if [ -z "$CLANG_BIN" ] || [ ! -d "$CLANG_BIN" ]; then
            echo "::error::CLANG_BIN env var not set or directory missing"
            exit 1
          fi
          export PATH="$CLANG_BIN:$PATH"

          if [ ! -f "$CLANG_BIN/ld.lld" ]; then
            echo "::error::ld.lld not found at $CLANG_BIN/ld.lld"
            exit 1
          fi

          echo "âœ“ Using ld.lld: $(which ld.lld)"

          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}

          # Apply defconfig modifications as a heredoc (much faster than many echo)
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_4K_PAGES=y
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_PAN=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_SCHED_MC=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_FAIR_GROUP_SCHED=y
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_COMPACTION=y
          CONFIG_MQ_IOSCHED_DEADLINE=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_TRANSPARENT_HUGEPAGE=y
          CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_SME=y
          CONFIG_ARM64_BTI=y
          CONFIG_SCHED_CORE=y
          CONFIG_PERF_EVENTS=y
          CONFIG_OPP=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_CUBIC=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          CONFIG_NET_SCH_CAKE=y
          CONFIG_DEFAULT_FQ=y
          CONFIG_DEFAULT_TCP_CONG="bbr"
          CONFIG_F2FS_FS=y
          CONFIG_F2FS_FS_XATTR=y
          CONFIG_F2FS_FS_POSIX_ACL=y
          CONFIG_F2FS_FS_SECURITY=y
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_DEBUG=n
          CONFIG_KSU_ALLOWLIST_WORKAROUND=n
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LTO_CLANG_THIN=y
          # CONFIG_LTO_CLANG_FULL is not set
          CONFIG_LOCALVERSION="-deepongi"
          EOF

          # Remove ABI exports for WiFi fix
          rm -vf android/abi_gki_protected_exports_* || true

          echo "âœ“ Generating kernel config..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld HOSTLD=ld.lld O=out gki_defconfig

      - name: Build Kernel
        id: build
        continue-on-error: true
        run: |
          START_TIME=$(date +%s)

          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64

          CLANG_BIN="${{ env.CLANG_BIN }}"
          export PATH="$CLANG_BIN:$PATH"
          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}

          echo "âœ“ Starting kernel build with $(nproc) cores..."

          make -j$(nproc) \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}" \
            CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
            CC="ccache clang" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            2>&1 | tee build.log

          END_TIME=$(date +%s)
          BUILD_DURATION=$((END_TIME - START_TIME))
          BUILD_DURATION_MIN=$((BUILD_DURATION / 60))
          BUILD_DURATION_SEC=$((BUILD_DURATION % 60))

          if [ -f out/arch/arm64/boot/Image.gz ]; then
            echo "âœ… Kernel built successfully in ${BUILD_DURATION_MIN}m ${BUILD_DURATION_SEC}s"
            echo "BUILD_TIME=$BUILD_DURATION" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_DURATION_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_DURATION_SEC" >> $GITHUB_ENV
            exit 0
          else
            echo "::error::Kernel build failed - Image.gz not found"
            echo "BUILD_TIME=$BUILD_DURATION" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_DURATION_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_DURATION_SEC" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log-failed-${{ github.run_number }}
          path: kernel/build.log
          retention-days: 7

      - name: Check Build Success
        if: steps.build.outcome == 'failure'
        run: |
          echo "::error::Kernel build failed! Check the uploaded build log artifact for details."
          exit 1

      - name: Prepare AnyKernel3
        run: |
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git

          cp ../kernel/out/arch/arm64/boot/Image.gz ./ || { echo "::error::Image.gz not found"; exit 1; }
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          echo "âœ“ AnyKernel3 prepared"

      - name: Package Kernel
        run: |
          cd AnyKernel3
          VERSION="$(cat ../kernel/out/.config | grep "Linux/arm64" | awk '{print $3}' || echo "6.1.145")"
          DATE="$(date +%Y%m%d_%H%M)"
          ZIP_NAME="GKI-KernelSU-SuSFS-${VERSION}-${DATE}.zip"

          # Use pigz for faster compression if installed
          if command -v pigz &> /dev/null; then
            tar cf - . | pigz -9 > "../${ZIP_NAME%.zip}.tar.gz"
            mv "../${ZIP_NAME%.zip}.tar.gz" "../$ZIP_NAME"
          else
            zip -r9 "../$ZIP_NAME" * -x .git README.md ./*placeholder
          fi
          cd ..
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

          SIZE=$(du -h "$ZIP_NAME" | cut -f1)
          echo "âœ… Kernel packaged: $ZIP_NAME ($SIZE)"

          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          echo "SHA256: $(cat ${ZIP_NAME}.sha256)"

      - name: Upload Kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel Build ${{ github.run_number }}
          body: |
            ## ðŸŽ‰ GKI Kernel Build #${{ github.run_number }}
            
            **Build Time:** ${{ env.BUILD_TIME_MIN }}m ${{ env.BUILD_TIME_SEC }}s
            **Kernel Version:** 6.1.145
            **Branch:** android14-6.1-2025-09
            **Commit:** ${{ github.sha }}
            
            ### Integrated Components
            - âœ… **KernelSU** (main branch)
            - âœ… **SuSFS** (gki-android14-6.1)
            - âœ… **Clang 22.0.0** (ZyCromerZ)
            - âœ… **LTO:** ThinLTO
            
            ### Features
            - ARM64 optimization (Cortex-X3/A715/A510)
            - BBR TCP congestion control
            - F2FS filesystem support
            - Enhanced thermal management
            - IP sets and netfilter support
            
            ### Installation
            1. Download the kernel ZIP below
            2. Verify SHA256 checksum
            3. Boot to recovery (TWRP/OrangeFox)
            4. Flash the ZIP
            5. Reboot and enjoy!
            
            ### SHA256
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
