name: Build GKI Kernel with KernelSU Variants

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
      enable_telegram:
        description: 'Enable Telegram notifications'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release with artifacts'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  MAKE_JOBS: 8

jobs:
  setup:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
      build_start_time: ${{ steps.timestamp.outputs.start_time }}
      create_release: ${{ steps.config.outputs.create_release }}
    steps:
      - name: Record Build Start Time
        id: timestamp
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "üïê Build started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "üéØ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          CREATE_RELEASE=true
          
          if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
            ENABLE_SUSFS=false
          fi
          if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
            FORCE_CLEAN=true
          fi
          if [ "${{ github.event.inputs.create_release }}" = "false" ]; then
            CREATE_RELEASE=false
          fi
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT
          echo "create_release=$CREATE_RELEASE" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}

    steps:
      - name: Checkout with Submodules
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Initialize and Update Submodules
        run: |
          echo "üì¶ Initializing submodules..."
          git submodule init
          
          echo "üì• Updating kernel submodule (GitHub)..."
          git submodule update --init --recursive kernel
          
          echo "üì• Updating susfs4ksu submodule (GitLab)..."
          git submodule update --init --recursive susfs4ksu
          
          echo "‚úÖ All submodules initialized"

      - name: Clean Kernel Directory Properly
        run: |
          echo "üßπ Properly cleaning kernel directory..."
          if [ -d "kernel" ]; then
            cd kernel
            # Remove any KernelSU and patches
            rm -rf KernelSU drivers/kernelsu
            # Hard reset to remove all changes
            git reset --hard HEAD
            git clean -fdx
            cd ..
          fi
          echo "‚úÖ Kernel directory fully reset"

      - name: Store Workflow Commit Info
        run: |
          WORKFLOW_COMMIT=$(git rev-parse HEAD)
          WORKFLOW_COMMIT_SHORT=$(git rev-parse --short HEAD)
          WORKFLOW_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          WORKFLOW_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "WORKFLOW_COMMIT=$WORKFLOW_COMMIT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_SHORT=$WORKFLOW_COMMIT_SHORT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_DATE=$WORKFLOW_COMMIT_DATE" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_MSG=$WORKFLOW_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üîñ Workflow commit: $WORKFLOW_COMMIT_SHORT - $WORKFLOW_COMMIT_MSG"

      - name: Verify Kernel Source
        run: |
          if [ -f "kernel/Makefile" ]; then
            VERSION=$(grep "^VERSION" kernel/Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" kernel/Makefile | cut -d' ' -f3)
            echo "‚úÖ Kernel version: $VERSION.$PATCHLEVEL"
          else
            echo "‚ùå Kernel not available"
            exit 1
          fi

      - name: Store Kernel Commit Info
        run: |
          cd kernel
          KERNEL_COMMIT=$(git rev-parse HEAD)
          KERNEL_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KERNEL_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KERNEL_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_SHORT=$KERNEL_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_DATE=$KERNEL_COMMIT_DATE" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_MSG=$KERNEL_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üîñ Kernel commit: $KERNEL_COMMIT_SHORT - $KERNEL_COMMIT_MSG"

      - name: Verify SuSFS Source
        run: |
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "‚úÖ SuSFS verified"
          else
            echo "‚ùå SuSFS not available"
            exit 1
          fi

      - name: Store SuSFS Commit Info
        run: |
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse HEAD)
          SUSFS_COMMIT_SHORT=$(git rev-parse --short HEAD)
          SUSFS_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          SUSFS_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_SHORT=$SUSFS_COMMIT_SHORT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_DATE=$SUSFS_COMMIT_DATE" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_MSG=$SUSFS_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üîñ SuSFS commit: $SUSFS_COMMIT_SHORT - $SUSFS_COMMIT_MSG"

      - name: Show CCACHE Status
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "üìÇ CCACHE directory: $CCACHE_DIR"
          echo "üìà CCACHE stats BEFORE build:"
          ccache -s | grep -E "(Cacheable calls|Hits|Misses|Hit rate|cache size)" || true

      - name: Setup KernelSU Variant
        run: |
          cd kernel

          # Remove any existing KernelSU
          rm -rf KernelSU drivers/kernelsu
          
          # Set variant-specific information
          case "${{ matrix.variant }}" in
            "tiann")
              echo "üì¶ Setting up Official KernelSU (tiann)..."
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              PATCH_DIR="KSU"
              ;;
            "kowsu")
              echo "üì¶ Setting up KowSU (KOWX712)..."
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              PATCH_DIR="KowSU"
              ;;
            "mksu")
              echo "üì¶ Setting up MKSU (5ec1cff)..."
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              PATCH_DIR="5ec1cff"
              ;;
          esac
          
          # Clone the KernelSU repository
          echo "üì• Cloning $KSU_REPO on branch $KSU_BRANCH..."
          git clone --depth=1 --branch=$KSU_BRANCH \
            https://github.com/$KSU_REPO.git KernelSU
          
          # Execute setup.sh from kernel source directory, passing current directory (.)
          echo "üöÄ Running setup.sh from kernel source..."
          if [ -f "KernelSU/kernel/setup.sh" ]; then
            chmod +x KernelSU/kernel/setup.sh
            ./KernelSU/kernel/setup.sh .
          else
            echo "‚ùå KernelSU/kernel/setup.sh not found!"
            echo "üìÅ Available files in KernelSU:"
            find KernelSU -name "*.sh" -type f
            exit 1
          fi
          
          echo "PATCH_DIR=$PATCH_DIR" >> $GITHUB_ENV
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          
          echo "‚úÖ KernelSU setup completed for ${{ matrix.variant }}"

      - name: Get KSU Version Info
        run: |
          cd kernel/KernelSU
          
          echo "üìä Unshallowing repository for accurate commit count..."
          # Unshallow the repository to get full history
          git fetch --unshallow --quiet || git fetch --depth=10000 --quiet || true
          
          echo "üî¢ Counting commits..."
          KSU_COUNT=$(git rev-list --count HEAD)
          KSU_VERSION=$((KSU_COUNT + 30000))
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_COUNT=$KSU_COUNT" >> $GITHUB_ENV
          echo "‚úÖ KernelSU version: r$KSU_VERSION (commits: $KSU_COUNT)"

      - name: Verify KernelSU Setup
        run: |
          cd kernel
          echo "üîç Verifying KernelSU setup..."
          
          # Check if KernelSU files were created
          if [ -d "drivers/kernelsu" ]; then
            echo "‚úÖ KernelSU drivers directory created"
          else
            echo "‚ùå KernelSU drivers directory not found"
            exit 1
          fi
          
          if [ -f ".config" ]; then
            echo "‚úÖ Kernel configuration exists"
            # Check if KSU is enabled in config
            if grep -q "CONFIG_KSU=y" .config || grep -q "CONFIG_KSU=m" .config; then
              echo "‚úÖ KernelSU configuration detected"
            else
              echo "‚ö†Ô∏è KernelSU not in config, may need manual enabling"
            fi
          fi

      - name: Store KernelSU Commit Info
        run: |
          cd kernel/KernelSU
          KSU_COMMIT=$(git rev-parse HEAD)
          KSU_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KSU_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KSU_COMMIT_MSG=$(git log -1 --format=%s)
          KSU_COMMIT_AUTHOR=$(git log -1 --format='%an')
          
          echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
          echo "KSU_COMMIT_SHORT=$KSU_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KSU_COMMIT_DATE=$KSU_COMMIT_DATE" >> $GITHUB_ENV
          echo "KSU_COMMIT_MSG=$KSU_COMMIT_MSG" >> $GITHUB_ENV
          echo "KSU_COMMIT_AUTHOR=$KSU_COMMIT_AUTHOR" >> $GITHUB_ENV
          
          echo "üîñ KernelSU commit: $KSU_COMMIT_SHORT - $KSU_COMMIT_MSG"

      - name: Generate Comprehensive Changelog - ${{ matrix.variant }}
        run: |
          mkdir -p changelogs
          CHANGELOG_FILE="changelogs/CHANGELOG-${{ matrix.variant }}.md"
          
          echo "üìã Generating comprehensive changelog for ${{ matrix.variant }}..."
          
          # ============================================
          # HEADER SECTION
          # ============================================
          cat > "$CHANGELOG_FILE" << 'HEADER_EOF'
          # üìã Comprehensive Build Changelog
          
          HEADER_EOF
          
          # Add variant info
          case "${{ matrix.variant }}" in
            "tiann")
              echo "**Variant:** Official KernelSU (tiann)" >> "$CHANGELOG_FILE"
              ;;
            "kowsu")
              echo "**Variant:** KowSU Fork (KOWX712)" >> "$CHANGELOG_FILE"
              ;;
            "mksu")
              echo "**Variant:** MKSU Fork (5ec1cff)" >> "$CHANGELOG_FILE"
              ;;
          esac
          
          cat >> "$CHANGELOG_FILE" << HEADER_INFO
          **Build Number:** #${{ github.run_number }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **KernelSU Version:** r${{ env.KSU_VERSION }}
          **SuSFS:** ${{ env.ENABLE_SUSFS == 'true' && 'Enabled' || 'Disabled' }}
          
          ---
          
          HEADER_INFO
          
          # ============================================
          # COMPONENT VERSIONS TABLE
          # ============================================
          cat >> "$CHANGELOG_FILE" << 'TABLE_HEADER'
          ## üìñ Component Versions
          
          | Component | Current Commit | Date | Summary |
          |-----------|---------------|------|---------|
          TABLE_HEADER
          
          echo "| **KernelSU (${{ matrix.variant }})** | \`${{ env.KSU_COMMIT_SHORT }}\` | ${{ env.KSU_COMMIT_DATE }} | ${{ env.KSU_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Kernel (android14-6.1-2025-09)** | \`${{ env.KERNEL_COMMIT_SHORT }}\` | ${{ env.KERNEL_COMMIT_DATE }} | ${{ env.KERNEL_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **SuSFS4KSU** | \`${{ env.SUSFS_COMMIT_SHORT }}\` | ${{ env.SUSFS_COMMIT_DATE }} | ${{ env.SUSFS_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Build Workflow** | \`${{ env.WORKFLOW_COMMIT_SHORT }}\` | ${{ env.WORKFLOW_COMMIT_DATE }} | ${{ env.WORKFLOW_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          # ============================================
          # CHECK FOR PREVIOUS BUILD
          # ============================================
          cd kernel/KernelSU
          PREVIOUS_TAG=$(git tag --list "${{ matrix.variant }}-build-*" --sort=-version:refname 2>/dev/null | head -n 1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # ============================================
            # INITIAL BUILD - Show recent commits
            # ============================================
            echo "## üéâ Initial Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "This is the first tracked build for the **${{ matrix.variant }}** variant. Below are the recent changes in each component:" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # KernelSU Recent Changes
            echo "### üîß KernelSU - ${{ matrix.variant }} (Last 10 commits)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/${{ env.KSU_REPO }}" >> "../../$CHANGELOG_FILE"
            echo "**Branch:** ${{ env.KSU_BRANCH }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Kernel Recent Changes
            cd ../../kernel
            echo "### üß¨ Kernel - android14-6.1-2025-09 (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/aosp-mirror/kernel_common" >> "../$CHANGELOG_FILE"
            echo "**Branch:** android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # SuSFS Recent Changes
            cd ../susfs4ksu
            echo "### üõ°Ô∏è SuSFS4KSU (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "../$CHANGELOG_FILE"
            echo "**Branch:** gki-android14-6.1-dev" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # Workflow Recent Changes
            cd ..
            echo "### ‚öôÔ∏è Build Workflow (Last 5 commits)" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Repository:** ${{ github.repository }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            git log -5 --pretty=format:"- **%h** - %s (%an, %ar)" -- .github/workflows/ >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            
            echo "---" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_This is the initial tracked build. Future builds will show detailed changes since the last build._" >> "$CHANGELOG_FILE"
            
          else
            # ============================================
            # SUBSEQUENT BUILD - Show changes since last build
            # ============================================
            echo "## üîÑ Changes Since Last Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Previous Build:** \`$PREVIOUS_TAG\`" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Get previous commit from last build metadata
            PREV_KSU_COMMIT=$(git rev-parse "$PREVIOUS_TAG" 2>/dev/null || echo "")
            
            if [ -n "$PREV_KSU_COMMIT" ]; then
              COMMIT_RANGE="${PREV_KSU_COMMIT}..HEAD"
              KSU_CHANGE_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
            else
              KSU_CHANGE_COUNT="unknown"
              COMMIT_RANGE=""
            fi
            
            # KernelSU Changes
            echo "### üîß KernelSU - ${{ matrix.variant }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            if [ -n "$COMMIT_RANGE" ] && [ "$KSU_CHANGE_COUNT" != "0" ]; then
              echo "**Changes:** $KSU_CHANGE_COUNT commit(s)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              git log $COMMIT_RANGE --pretty=format:"#### %h - %s%n%n**Author:** %an <%ae>  %n**Date:** %ad%n%n%b%n----%n" --date=format:'%Y-%m-%d %H:%M:%S' >> "../../$CHANGELOG_FILE"
            else
              echo "**Status:** No changes detected (or first build after tag migration)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              echo "_Current commit:_ \`${{ env.KSU_COMMIT_SHORT }}\` - ${{ env.KSU_COMMIT_MSG }}" >> "../../$CHANGELOG_FILE"
            fi
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Note: For kernel, SuSFS, and workflow - we'll show current state since we don't have previous tracking
            
            cd ../../kernel
            echo "### üß¨ Kernel - android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.KERNEL_COMMIT_SHORT }}\` - ${{ env.KERNEL_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: Kernel tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ../susfs4ksu
            echo "### üõ°Ô∏è SuSFS4KSU" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.SUSFS_COMMIT_SHORT }}\` - ${{ env.SUSFS_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: SuSFS tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ..
            echo "### ‚öôÔ∏è Build Workflow" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.WORKFLOW_COMMIT_SHORT }}\` - ${{ env.WORKFLOW_COMMIT_MSG }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_Note: Workflow tracking will be enhanced in future builds. Showing current commit._" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
          fi
          
          # ============================================
          # FOOTER SECTION - Links and References
          # ============================================
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "## üîó Component Links" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### KernelSU (${{ matrix.variant }})" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ env.KSU_REPO }}" >> "$CHANGELOG_FILE"
          echo "- **Branch:** ${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ env.KSU_REPO }}/commit/${{ env.KSU_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Full History:** https://github.com/${{ env.KSU_REPO }}/commits/${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Kernel" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/aosp-mirror/kernel_common" >> "$CHANGELOG_FILE"
          echo "- **Branch:** android14-6.1-2025-09" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/aosp-mirror/kernel_common/commit/${{ env.KERNEL_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### SuSFS4KSU" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "$CHANGELOG_FILE"
          echo "- **Branch:** gki-android14-6.1-dev" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Build Workflow" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ github.repository }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ github.repository }}/commit/${{ env.WORKFLOW_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "_Generated automatically by GitHub Actions on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> "$CHANGELOG_FILE"
          
          # Tag this build for future reference
          cd kernel/KernelSU
          git tag "${{ matrix.variant }}-build-${{ github.run_number }}" 2>/dev/null || true
          
          cd ../..
          
          # Display preview
          echo "üìã Changelog preview (first 50 lines):"
          head -n 50 "$CHANGELOG_FILE" || cat "$CHANGELOG_FILE"
          
          echo "CHANGELOG_FILE=$CHANGELOG_FILE" >> $GITHUB_ENV
          
          echo "‚úÖ Comprehensive changelog generated successfully!"

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "üì¶ Setting up SuSFS..."
          
          # Copy SuSFS files
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch - check for variant-specific first
          VARIANT_SUSFS_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_SUSFS_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_SUSFS_PATCH" ]; then
            echo "üìã Applying variant-specific SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_SUSFS_PATCH" || true
          else
            echo "üìã Applying default SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_SUSFS_PATCH" || true
          fi
          
          # Apply KernelSU-specific SuSFS patch
          cd KernelSU
          VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
          DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          if [ -f "$VARIANT_KSU_PATCH" ]; then
            echo "üìã Applying variant-specific KSU SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
          else
            echo "üìã Applying default KSU SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
          fi
          
          # Apply LKM spoof patch after SuSFS patch
          LKM_SPOOF_PATCH="../../.github/patches/${{ matrix.variant }}/20-KernelSU-Spoof-LKM-mode-to-suppress-manager-warning.patch"
          if [ -f "$LKM_SPOOF_PATCH" ]; then
            echo "üìã Applying LKM spoof patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$LKM_SPOOF_PATCH" || true
          else
            echo "‚ö†Ô∏è LKM spoof patch not found: $LKM_SPOOF_PATCH"
          fi
          cd ..

      - name: Apply Remote Patches
        run: |
          cd kernel
          
          # CLIDR fix (essential for all variants)
          echo "üìã Applying fix-clidr-uninitialized.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" \
            -o /tmp/fix-clidr.patch
          patch -p1 --forward < /tmp/fix-clidr.patch || true

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Base configuration
          # Note: We use printf to avoid the Heredoc indentation issue entirely
          printf '%s\n' \
            "CONFIG_ARM64_BTI=y" \
            "CONFIG_ARM64_CORTEX_A510=y" \
            "CONFIG_ARM64_CORTEX_A715=y" \
            "CONFIG_ARM64_CORTEX_X3=y" \
            "CONFIG_ARM64_PA_BITS=48" \
            "CONFIG_ARM64_PTR_AUTH=y" \
            "CONFIG_ARM64_SME=y" \
            "CONFIG_ARM64_SVE=y" \
            "CONFIG_ARM64_TAGGED_ADDR_ABI=y" \
            "CONFIG_ARM64_VA_BITS=48" \
            "CONFIG_ARM_PSCI_CPUIDLE=y" \
            "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" \
            "CONFIG_CMA=y" \
            "CONFIG_CMA_AREAS=7" \
            "CONFIG_CPUFREQ_DT=y" \
            "CONFIG_CPU_FREQ=y" \
            "CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y" \
            "CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y" \
            "CONFIG_CPU_IDLE=y" \
            "CONFIG_CPU_THERMAL=y" \
            "CONFIG_DEVFREQ_THERMAL=y" \
            "CONFIG_ENERGY_MODEL=y" \
            "CONFIG_HAVE_KPROBES=y" \
            "CONFIG_IP6_NF_MATCH_HL=y" \
            "CONFIG_IP6_NF_TARGET_HL=y" \
            "CONFIG_IP_NF_TARGET_TTL=y" \
            "CONFIG_IP_SET=y" \
            "CONFIG_IP_SET_BITMAP_IP=y" \
            "CONFIG_IP_SET_BITMAP_IPMAC=y" \
            "CONFIG_IP_SET_BITMAP_PORT=y" \
            "CONFIG_IP_SET_HASH_IP=y" \
            "CONFIG_IP_SET_HASH_IPPORT=y" \
            "CONFIG_IP_SET_HASH_IPPORTIP=y" \
            "CONFIG_IP_SET_HASH_IPPORTNET=y" \
            "CONFIG_IP_SET_HASH_NET=y" \
            "CONFIG_IP_SET_HASH_NETIFACE=y" \
            "CONFIG_IP_SET_HASH_NETNET=y" \
            "CONFIG_IP_SET_HASH_NETPORT=y" \
            "CONFIG_IP_SET_MAX=256" \
            "CONFIG_KPROBES=y" \
            "CONFIG_KPROBE_EVENTS=y" \
            "CONFIG_KSU=y" \
            "CONFIG_KSU_ALLOWLIST_WORKAROUND=n" \
            "CONFIG_KSU_DEBUG=y" \
            "CONFIG_KSU_KPROBES_HOOK=n" \
            "CONFIG_KSU_LSM_SECURITY_HOOKS=y" \
            "CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y" \
            "CONFIG_LOCALVERSION_AUTO=n" \
            "CONFIG_LTO=y" \
            "CONFIG_LTO_CLANG=y" \
            "CONFIG_LTO_CLANG_THIN=y" \
            "CONFIG_NET_SCH_CAKE=y" \
            "CONFIG_NET_SCH_FQ=y" \
            "CONFIG_NUMA_BALANCING=y" \
            "CONFIG_OPP=y" \
            "CONFIG_PERF_EVENTS=y" \
            "CONFIG_POWER_CAP=y" \
            "CONFIG_SCHED_CORE=y" \
            "CONFIG_SCHED_MC=y" \
            "CONFIG_TCP_CONG_ADVANCED=y" \
            "CONFIG_TCP_CONG_BBR=y" \
            "CONFIG_TCP_CONG_BIC=n" \
            "CONFIG_TCP_CONG_HTCP=n" \
            "CONFIG_TCP_CONG_WESTWOOD=n" \
            "CONFIG_THERMAL=y" \
            "CONFIG_THERMAL_EMULATION=y" \
            "CONFIG_THERMAL_GOV_FAIR_SHARE=y" \
            "CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y" \
            "CONFIG_THERMAL_GOV_STEP_WISE=y" \
            "CONFIG_THERMAL_WRITABLE_TRIPS=y" \
            "CONFIG_TMPFS_POSIX_ACL=y" \
            "CONFIG_TMPFS_XATTR=y" \
            "CONFIG_UCLAMP_TASK=y" \
            "CONFIG_UCLAMP_TASK_GROUP=y" >> out/.config
                      
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            printf '%s\n' \
              "CONFIG_KSU_SUSFS=y" \
              "CONFIG_KSU_SUSFS_SUS_PATH=y" \
              "CONFIG_KSU_SUSFS_SUS_MOUNT=y" \
              "CONFIG_KSU_SUSFS_SUS_KSTAT=y" \
              "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" \
              "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" \
              "CONFIG_KSU_SUSFS_ENABLE_LOG=y" \
              "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" \
              "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" \
              "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" \
              "CONFIG_KSU_SUSFS_SUS_MAP=y" >> out/.config
          fi
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig
      - name: Handle ABI File Changes
        run: |
          cd kernel
          
          # Remove ABI files as per KernelSU guide
          echo "üßπ Removing ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true
          
          # Clean kernel build to ensure everything rebuilds
          echo "üßπ Cleaning kernel build..."
          make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
          
          echo "‚úÖ Ready for fresh build with modified ABI files"

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          START_TIME=$SECONDS
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "üßπ Performing clean build..."
            make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
          fi
          
          echo "üóøÔ∏è Building kernel for ${{ matrix.variant }}..."
          echo "üìÇ Using CCACHE at: $CCACHE_DIR"
          make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out CC="ccache clang" 2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_MINS=$((BUILD_TIME / 60))
          BUILD_SECS=$((BUILD_TIME % 60))
          echo "BUILD_TIME=${BUILD_MINS}m ${BUILD_SECS}s" >> $GITHUB_ENV

      - name: Check CCACHE Performance
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "üìà CCACHE stats AFTER build:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Get full ccache stats
          ccache -s
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Extracting Performance Metrics..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Save ccache output to variable
          CCACHE_OUTPUT=$(ccache -s)
          
          # Extract cache size from the last line that mentions "cache size"
          FINAL_CACHE_SIZE=$(echo "$CCACHE_OUTPUT" | grep -i "cache size" | tail -1 | awk '{print $4, $5, $6, $7}' | sed 's/^ *//;s/ *$//')
          
          # Extract hit rate - format has TWO "Hits:" lines, we want the FIRST one
          HIT_RATE=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | grep -oE '\([0-9]+\.[0-9]+%\)' | tr -d '()')
          
          # If extraction failed, try alternative method
          if [ -z "$HIT_RATE" ] || [ "$HIT_RATE" = "" ]; then
            echo "‚ö†Ô∏è  Primary extraction failed, trying calculation method..."
            
            # Get hits and total from first "Hits:" line
            HITS=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | awk '{print $2}')
            TOTAL=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | awk '{print $4}')
            
            if [ -n "$HITS" ] && [ -n "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
              HIT_RATE=$(awk "BEGIN {printf \"%.2f%%\", ($HITS / $TOTAL) * 100}")
              echo "‚úÖ Calculated: $HIT_RATE"
            else
              HIT_RATE="N/A"
              echo "‚ùå Could not extract hit rate"
              echo "   HITS=$HITS, TOTAL=$TOTAL"
            fi
          else
            echo "‚úÖ Hit rate extracted: $HIT_RATE"
          fi
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Final Results:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üíæ Cache Size: $FINAL_CACHE_SIZE"
          echo "üéØ Hit Rate: $HIT_RATE"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Export to environment
          echo "FINAL_CACHE_SIZE=$FINAL_CACHE_SIZE" >> $GITHUB_ENV
          echo "CCACHE_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV

      - name: Package Kernel
        run: |
          # Get kernel version from Makefile
          echo "üìã Extracting kernel version..."
          cd kernel
          KERNEL_VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3).$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3).$(grep "^SUBLEVEL" Makefile | cut -d' ' -f3)
          cd ..
          echo "‚úÖ Kernel version: $KERNEL_VERSION"
          
          # Determine which AnyKernel3 branch to use based on variant
          case "${{ matrix.variant }}" in
            "tiann")
              AK3_BRANCH="KernelSU"
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "üì¶ Using AnyKernel3 branch: KernelSU (for tiann variant)"
              ;;
            "kowsu")
              AK3_BRANCH="KowSU" 
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "üì¶ Using AnyKernel3 branch: KowSU (for kowsu variant)"
              ;;
            "mksu")
              AK3_BRANCH="MKSU"
              AK3_REPO="deepongi-labs/AnyKernel3-p8a"
              echo "üì¶ Using AnyKernel3 branch: MKSU (for mksu variant)"
              ;;
          esac
          
          # Clone the appropriate AnyKernel3 branch for this variant
          echo "üì• Cloning AnyKernel3 from $AK3_REPO on branch $AK3_BRANCH..."
          git clone --depth=1 --branch=$AK3_BRANCH \
            https://github.com/$AK3_REPO AnyKernel3
          
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          
          # Use both kernel version and KSU version in ZIP name
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-${KERNEL_VERSION}-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS.zip"
          else
            ZIP_NAME="AK3-${KERNEL_VERSION}-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          # Get file size
          FILE_SIZE=$(du -h "$ZIP_NAME" | cut -f1)
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          
          echo "‚úÖ Packaged kernel: $ZIP_NAME ($FILE_SIZE)"
          echo "üìã Using AnyKernel3 branch: $AK3_BRANCH from $AK3_REPO"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
            ${{ env.CHANGELOG_FILE }}
          retention-days: 30

  create_release:
    needs: [setup, build]
    runs-on: [self-hosted, Linux, X64]
    if: needs.setup.outputs.create_release == 'true' && success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Build Duration
        run: |
          START_TIME="${{ needs.setup.outputs.build_start_time }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          DURATION_MINS=$((DURATION / 60))
          DURATION_SECS=$((DURATION % 60))
          echo "BUILD_DURATION=${DURATION_MINS}m ${DURATION_SECS}s" >> $GITHUB_ENV
          echo "üïê Total build duration: ${DURATION_MINS}m ${DURATION_SECS}s"

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          cd release-assets
          
          # Flatten directory structure
          find . -type f -exec mv {} . \; 2>/dev/null || true
          find . -type d -empty -delete
          
          ls -lh
          
          # Count variants built
          VARIANT_COUNT=$(ls -1 CHANGELOG-*.md 2>/dev/null | wc -l)
          echo "VARIANT_COUNT=$VARIANT_COUNT" >> $GITHUB_ENV
          
          # Get build date from any changelog (they're all from same run)
          if [ -f "CHANGELOG-tiann.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-tiann.md | head -1 | cut -d':' -f2- | xargs)
          elif [ -f "CHANGELOG-kowsu.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-kowsu.md | head -1 | cut -d':' -f2- | xargs)
          elif [ -f "CHANGELOG-mksu.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-mksu.md | head -1 | cut -d':' -f2- | xargs)
          else
            BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          fi
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          
          # Determine which variants were built
          VARIANTS_BUILT=""
          [ -f "CHANGELOG-tiann.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}tiann "
          [ -f "CHANGELOG-kowsu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}kowsu "
          [ -f "CHANGELOG-mksu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}mksu "
          echo "VARIANTS_BUILT=$VARIANTS_BUILT" >> $GITHUB_ENV
          
          # Extract CCACHE hit rate and cache size from first available build log
          if [ -f "build-tiann.log" ]; then
            BUILD_LOG="build-tiann.log"
          elif [ -f "build-kowsu.log" ]; then
            BUILD_LOG="build-kowsu.log"
          elif [ -f "build-mksu.log" ]; then
            BUILD_LOG="build-mksu.log"
          fi
          
          if [ -n "$BUILD_LOG" ]; then
            CCACHE_HIT_RATE=$(grep "üéØ Hit Rate:" "$BUILD_LOG" | tail -1 | cut -d':' -f2 | xargs || echo "N/A")
            CACHE_SIZE=$(grep "üíæ Cache Size:" "$BUILD_LOG" | tail -1 | cut -d':' -f2 | xargs || echo "N/A")
            echo "CCACHE_HIT_RATE=$CCACHE_HIT_RATE" >> $GITHUB_ENV
            echo "CACHE_SIZE=$CACHE_SIZE" >> $GITHUB_ENV
          fi

      - name: Generate Enhanced Release Notes
        run: |
          cd release-assets
          
          # Start building the release notes
          cat > RELEASE_NOTES.md << 'HEADER_EOF'
          # üöÄ Android 16 GKI Kernel Build #
          HEADER_EOF
          
          # Add build number
          echo "${{ github.run_number }}" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # Build info card
          cat >> RELEASE_NOTES.md << INFO_CARD
          <div align="center">
          
          | üèóÔ∏è Build Info | üìä Details |
          |--------------|-----------|
          | **Build Number** | #${{ github.run_number }} |
          | **Build Date** | ${{ env.BUILD_DATE }} |
          | **Build Duration** | ${{ env.BUILD_DURATION }} |
          | **Target Android** | Android 16 |
          | **Primary Device** | Google Pixel 8a |
          | **Compatible** | Pixel 8, 8 Pro |
          | **Variants Built** | ${{ env.VARIANT_COUNT }}/3 (${{ env.VARIANTS_BUILT }}) |
          | **SuSFS** | ${{ github.event.inputs.disable_susfs == 'true' && '‚ùå Disabled' || '‚úÖ Enabled' }} |
          | **CCACHE Hit Rate** | ${{ env.CCACHE_HIT_RATE }} |
          | **Cache Size** | ${{ env.CACHE_SIZE }} |
          
          </div>
          
          ---
          
          INFO_CARD
          
          # Add download section for each variant
          echo "## üì¶ Download Packages" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # Function to add variant section
          add_variant_section() {
            local variant=$1
            local variant_upper=$2
            local variant_name=$3
            
            if [ -f "CHANGELOG-${variant}.md" ]; then
              KSU_VERSION=$(grep "KernelSU Version:" "CHANGELOG-${variant}.md" | head -1 | cut -d':' -f2 | xargs)
              SUSFS_STATUS=$(grep "SuSFS:" "CHANGELOG-${variant}.md" | head -1 | cut -d':' -f2 | xargs)
              KSU_COMMIT=$(grep "| \*\*KernelSU" "CHANGELOG-${variant}.md" | head -1 | grep -oE '\`[a-f0-9]+\`' | tr -d '\`')
              KSU_COMMIT_MSG=$(grep "| \*\*KernelSU" "CHANGELOG-${variant}.md" | head -1 | cut -d'|' -f5 | xargs)
              
              ZIP_FILE=$(ls AK3-*-${variant_upper}-*.zip 2>/dev/null | head -1)
              if [ -n "$ZIP_FILE" ]; then
                FILE_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
                SHA256_FILE="${ZIP_FILE}.sha256"
                MD5_FILE="${ZIP_FILE}.md5"
                
                cat >> RELEASE_NOTES.md << VARIANT_SECTION
          ### üîß ${variant_name}
          **Version:** \`${KSU_VERSION}\` | **Updated:** Just now | **Size:** ${FILE_SIZE}
          
          <details>
          <summary>üì• <b>Download & Details</b></summary>
          
          | Component | Value |
          |-----------|-------|
          | **File** | \`${ZIP_FILE}\` |
          | **Size** | ${FILE_SIZE} |
          | **SHA256** | [View Checksum](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/${SHA256_FILE}) |
          | **MD5** | [View Checksum](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/${MD5_FILE}) |
          | **KernelSU Commit** | \`${KSU_COMMIT}\` - ${KSU_COMMIT_MSG} |
          | **SuSFS** | ${SUSFS_STATUS} |
          
          **üìã Downloads:**
          - üì¶ **[Download Kernel ZIP](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/${ZIP_FILE})**
          - üîê [SHA256](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/${SHA256_FILE})
          - üîë [MD5](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/${MD5_FILE})
          - üìÑ [Full Changelog](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/CHANGELOG-${variant}.md)
          
          </details>
          
          VARIANT_SECTION
              fi
            fi
          }
          
          # Add sections for each variant
          add_variant_section "tiann" "TIANN" "Official KernelSU (tiann)"
          add_variant_section "kowsu" "KOWSU" "KowSU Fork (kowsu)"
          add_variant_section "mksu" "MKSU" "MKSU Fork (mksu)"
          
          # Add comparison table
          cat >> RELEASE_NOTES.md << 'COMPARISON_EOF'
          ---
          
          ## üîç Variant Comparison
          
          | Feature | Official (tiann) | KowSU (kowsu) | MKSU (mksu) |
          |---------|------------------|---------------|-------------|
          | **Base Source** | Official | Fork | Fork |
          | **SuSFS** | ‚úÖ | ‚úÖ | ‚úÖ |
          | **LSM Hooks** | ‚úÖ | ‚úÖ | ‚úÖ |
          | **Custom Features** | Standard | Enhanced | Specialized |
          | **Update Frequency** | Daily | Weekly | As needed |
          | **Stability** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |
          | **Recommended For** | Daily driver | Power users | Compatibility |
          
          ---
          
          ## üì± Compatibility
          
          ### Devices
          - ‚úÖ **Google Pixel 8a** - Primary target, fully tested
          - ‚úÖ **Google Pixel 8** - Compatible (same Tensor G3)
          - ‚úÖ **Google Pixel 8 Pro** - Compatible (same Tensor G3)
          
          **Note:** All Pixel 8 series devices share the Tensor G3 chipset.
          
          ### Android Version
          - ‚úÖ **Android 16** - Target version
          
          ### Requirements
          - Unlocked bootloader
          - [Kernel Flasher v1.6](https://github.com/fatalcoder524/KernelFlasher/releases/tag/v1.6.0) (recommended) or custom recovery
          - Backup recommended
          
          ---
          
          ## üõ†Ô∏è Installation
          
          ### Method 1: Kernel Flasher (Recommended) ‚≠ê
          1. **Download & Install** [Kernel Flasher v1.6](https://github.com/fatalcoder524/KernelFlasher/releases/tag/v1.6.0) by fatalcoder524
          2. **Download** your preferred variant ZIP
          3. **Open** Kernel Flasher app
          4. **Select** the downloaded ZIP
          5. **Flash** and wait for completion
          6. **Reboot**
          
          **Why Kernel Flasher?**
          - ‚úÖ No recovery needed
          - ‚úÖ Flash from Android directly
          - ‚úÖ Easier and faster
          - ‚úÖ User-friendly interface
          
          ### Method 2: Custom Recovery (Alternative)
          1. **Download** your preferred variant ZIP
          2. **Boot** into recovery (TWRP/OrangeFox)
          3. **Flash** the ZIP
          4. **Reboot**
          
          ---
          
          ## ‚ÑπÔ∏è About This Kernel
          
          This is a **GKI (Generic Kernel Image)** kernel built for **Android 16** on **Google Pixel 8a**.
          
          **Device Compatibility:**
          - ‚úÖ **Pixel 8a** - Primary target
          - ‚úÖ **Pixel 8** - Compatible (same Tensor G3)
          - ‚úÖ **Pixel 8 Pro** - Compatible (same Tensor G3)
          
          **Why "android14" in the branch name?** The branch name `android14-6.1-2025-09` refers to Google's GKI kernel branch naming scheme, based on when the Pixel 8 series launched with Android 14. This is NOT the target Android version.
          
          **What this means:**
          - ‚úÖ This kernel is for Android 16
          - ‚úÖ Built from Google's GKI android14-6.1 branch
          - ‚úÖ Compatible with all Pixel 8 series devices
          
          **Chipset:** Google Tensor G3 | **Architecture:** ARM64
          
          ---
          
          ## üîó Resources
          
          - **Repository:** https://github.com/${{ github.repository }}
          - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - **Kernel Flasher:** https://github.com/fatalcoder524/KernelFlasher/releases/tag/v1.6.0
          - **Issues:** https://github.com/${{ github.repository }}/issues
          
          ---
          
          <div align="center">
          
          **Built with ‚ù§Ô∏è for the Pixel 8 series community**
          
          *All variants built from the same kernel base with variant-specific KernelSU implementations*
          
          </div>
          COMPARISON_EOF
          
          echo "‚úÖ Enhanced release notes generated"
          cat RELEASE_NOTES.md

      - name: Create Unified Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Android 16 Kernel Build #${{ github.run_number }}"
          body_path: release-assets/RELEASE_NOTES.md
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [setup, create_release]
    runs-on: [self-hosted, Linux, X64]
    if: always()
    steps:
      - name: Extract Variant Info
        if: always()
        run: |
          # Get variant info from setup output
          echo "VARIANTS_BUILT=${{ needs.setup.outputs.matrix }}" >> $GITHUB_ENV
          
          # Get release creation status
          echo "CREATE_RELEASE=${{ needs.setup.outputs.create_release }}" >> $GITHUB_ENV
          
          # Determine which variants were actually built
          BUILT_VARIANTS=""
          [[ "${{ needs.setup.outputs.matrix }}" == *"tiann"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}tiann "
          [[ "${{ needs.setup.outputs.matrix }}" == *"kowsu"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}kowsu "
          [[ "${{ needs.setup.outputs.matrix }}" == *"mksu"* ]] && BUILT_VARIANTS="${BUILT_VARIANTS}mksu "
          echo "BUILT_VARIANTS_LIST=$BUILT_VARIANTS" >> $GITHUB_ENV

      - name: Send Enhanced Success Notification
        if: ${{ needs.create_release.result == 'success' && github.event.inputs.enable_telegram == 'true' }}
        run: |
          # Determine release info
          if [ "${{ env.CREATE_RELEASE }}" = "true" ]; then
            RELEASE_INFO="üì¶ *Release:* [Build #${{ github.run_number }}](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})"
            DOWNLOAD_LINKS="‚Ä¢ [Download All Variants](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})"
          else
            RELEASE_INFO="üì¶ *Release:* Not created (disabled in workflow)"
            DOWNLOAD_LINKS="‚Ä¢ [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi
          
          # Get build duration if available
          BUILD_DURATION="${{ env.BUILD_DURATION || 'Unknown' }}"
          
          # Get variant-specific info
          VARIANT_COUNT=$(echo "${{ env.BUILT_VARIANTS_LIST }}" | wc -w)
          
          MESSAGE="üéä *Build #${{ github.run_number }} Completed Successfully!*

          üèóÔ∏è *Built Variants:* $VARIANT_COUNT/3 (${{ env.BUILT_VARIANTS_LIST }})
          ‚ö° *Build Duration:* $BUILD_DURATION
          üõ°Ô∏è *SuSFS:* ${{ github.event.inputs.disable_susfs == 'true' && '‚ùå Disabled' || '‚úÖ Enabled' }}
          $RELEASE_INFO

          üì• *Downloads:*
          $DOWNLOAD_LINKS

          üì± *Device:* Pixel 8a/8/8 Pro
          ü§ñ *Android:* 16 (GKI)

          üîç *Details:* [Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          *Built with ‚ù§Ô∏è using GitHub Actions*"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Send Failure Notification with Metrics
        if: ${{ (needs.create_release.result == 'failure' || needs.build.result == 'failure') && github.event.inputs.enable_telegram == 'true' }}
        run: |
          if [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_STAGE="Build"
          else
            FAILED_STAGE="Release"
          fi
          
          # Get build duration if available
          BUILD_DURATION="${{ env.BUILD_DURATION || 'Unknown' }}"
          
          MESSAGE="‚ùå *Build #${{ github.run_number }} Failed*

          ‚ö†Ô∏è *Failed Stage:* $FAILED_STAGE
          ‚è±Ô∏è *Build Duration:* $BUILD_DURATION
          üì¶ *Target Variants:* ${{ env.BUILT_VARIANTS_LIST }}
          üõ°Ô∏è *SuSFS:* ${{ github.event.inputs.disable_susfs == 'true' && '‚ùå Disabled' || '‚úÖ Enabled' }}

          üîó [View Detailed Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          üìã [Build Configuration](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/workflow)

          *Need help? Check the logs above for detailed error information.*"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Send Cancellation Notification
        if: ${{ (needs.create_release.result == 'cancelled' || needs.build.result == 'cancelled') && github.event.inputs.enable_telegram == 'true' }}
        run: |
          MESSAGE="‚ö†Ô∏è *Build #${{ github.run_number }} Cancelled*

          üì¶ *Target Variants:* ${{ env.BUILT_VARIANTS_LIST }}
          üõ°Ô∏è *SuSFS:* ${{ github.event.inputs.disable_susfs == 'true' && '‚ùå Disabled' || '‚úÖ Enabled' }}

          üîó [Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"