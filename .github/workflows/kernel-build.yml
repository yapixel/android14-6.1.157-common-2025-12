name: Build GKI Kernel with KernelSU Variants

on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean
      enable_telegram:
        description: 'Enable Telegram notifications'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  MAKE_JOBS: 8

jobs:
  setup:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
    steps:
      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸŽ¯ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          
          if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
            ENABLE_SUSFS=false
          fi
          if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
            FORCE_CLEAN=true
          fi
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}

    steps:
      - name: Checkout with Submodules
        uses: actions/checkout@v4
        with:
          submodules: false  # We'll handle submodules manually
          fetch-depth: 0

      - name: Initialize and Update Submodules
        run: |
          echo "ðŸ“¦ Initializing submodules..."
          git submodule init
          
          echo "ðŸ“¥ Updating kernel submodule (GitHub)..."
          git submodule update --init --recursive kernel
          
          echo "ðŸ“¥ Updating susfs4ksu submodule (GitLab)..."
          git submodule update --init --recursive susfs4ksu
          
          echo "âœ… All submodules initialized"

      - name: Store Workflow Commit Info
        run: |
          WORKFLOW_COMMIT=$(git rev-parse HEAD)
          WORKFLOW_COMMIT_SHORT=$(git rev-parse --short HEAD)
          WORKFLOW_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          WORKFLOW_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "WORKFLOW_COMMIT=$WORKFLOW_COMMIT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_SHORT=$WORKFLOW_COMMIT_SHORT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_DATE=$WORKFLOW_COMMIT_DATE" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_MSG=$WORKFLOW_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ“ Workflow commit: $WORKFLOW_COMMIT_SHORT - $WORKFLOW_COMMIT_MSG"

      - name: Verify Kernel Source
        run: |
          if [ -f "kernel/Makefile" ]; then
            VERSION=$(grep "^VERSION" kernel/Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" kernel/Makefile | cut -d' ' -f3)
            echo "âœ… Kernel version: $VERSION.$PATCHLEVEL"
          else
            echo "âŒ Kernel not available"
            exit 1
          fi

      - name: Store Kernel Commit Info
        run: |
          cd kernel
          KERNEL_COMMIT=$(git rev-parse HEAD)
          KERNEL_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KERNEL_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KERNEL_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_SHORT=$KERNEL_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_DATE=$KERNEL_COMMIT_DATE" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_MSG=$KERNEL_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ“ Kernel commit: $KERNEL_COMMIT_SHORT - $KERNEL_COMMIT_MSG"

      - name: Verify SuSFS Source
        run: |
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "âœ… SuSFS verified"
          else
            echo "âŒ SuSFS not available"
            exit 1
          fi

      - name: Store SuSFS Commit Info
        run: |
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse HEAD)
          SUSFS_COMMIT_SHORT=$(git rev-parse --short HEAD)
          SUSFS_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          SUSFS_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_SHORT=$SUSFS_COMMIT_SHORT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_DATE=$SUSFS_COMMIT_DATE" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_MSG=$SUSFS_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "ðŸ“ SuSFS commit: $SUSFS_COMMIT_SHORT - $SUSFS_COMMIT_MSG"

      - name: Show CCACHE Status
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "ðŸ“‚ CCACHE directory: $CCACHE_DIR"
          echo "ðŸ“ˆ CCACHE stats BEFORE build:"
          ccache -s | grep -E "(Cacheable calls|Hits|Misses|Hit rate|cache size)" || true

      - name: Clean ABI Exports
        run: |
          cd kernel
          echo "ðŸ§¹ Cleaning ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true

      - name: Setup KernelSU - ${{ matrix.variant }}
        run: |
          cd kernel
          
          # Remove any existing KernelSU
          rm -rf KernelSU drivers/kernelsu
          
          case "${{ matrix.variant }}" in
            "tiann")
              echo "ðŸ“¦ Setting up tiann/KernelSU (Official)..."
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              ;;
            "kowsu")
              echo "ðŸ“¦ Setting up KOWX712/KernelSU (KowSU)..."
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              ;;
            "mksu")
              echo "ðŸ“¦ Setting up 5ec1cff/KernelSU (MKSU)..."
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              ;;
          esac
          
          # Clone KernelSU
          git clone --depth=1 --branch=$KSU_BRANCH \
            "https://github.com/$KSU_REPO" KernelSU
          
          # Get accurate version by unshallowing
          cd KernelSU
          echo "ðŸ“Š Getting accurate commit count..."
          git fetch --unshallow 2>/dev/null || git fetch --depth=10000 2>/dev/null || true
          KSU_COUNT=$(git rev-list --count HEAD)
          KSU_VERSION=$((KSU_COUNT + 20000))
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          echo "âœ… KernelSU version: r$KSU_VERSION (commits: $KSU_COUNT) from $KSU_REPO"
          cd ..
          
          # Setup KernelSU in kernel tree
          ln -sf "$(pwd)/KernelSU/kernel" drivers/kernelsu
          
          # Verify symlink
          if [ -d "drivers/kernelsu" ] && [ -f "drivers/kernelsu/Kconfig" ]; then
            echo "âœ… KernelSU symlink created successfully"
          else
            echo "âŒ KernelSU symlink failed, trying copy instead..."
            rm -rf drivers/kernelsu
            cp -r KernelSU/kernel drivers/kernelsu
            if [ -f "drivers/kernelsu/Kconfig" ]; then
              echo "âœ… KernelSU copied successfully"
            else
              echo "âŒ KernelSU setup failed"
              exit 1
            fi
          fi
          
          # Add to Makefile if not present
          if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
          fi
          
          # Add to Kconfig if not present
          if ! grep -q "kernelsu" drivers/Kconfig; then
            sed -i '/endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
          fi

      - name: Store KernelSU Commit Info
        run: |
          cd kernel/KernelSU
          KSU_COMMIT=$(git rev-parse HEAD)
          KSU_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KSU_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KSU_COMMIT_MSG=$(git log -1 --format=%s)
          KSU_COMMIT_AUTHOR=$(git log -1 --format='%an')
          
          echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
          echo "KSU_COMMIT_SHORT=$KSU_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KSU_COMMIT_DATE=$KSU_COMMIT_DATE" >> $GITHUB_ENV
          echo "KSU_COMMIT_MSG=$KSU_COMMIT_MSG" >> $GITHUB_ENV
          echo "KSU_COMMIT_AUTHOR=$KSU_COMMIT_AUTHOR" >> $GITHUB_ENV
          
          echo "ðŸ“ KernelSU commit: $KSU_COMMIT_SHORT - $KSU_COMMIT_MSG"

      - name: Generate Comprehensive Changelog - ${{ matrix.variant }}
        run: |
          mkdir -p changelogs
          CHANGELOG_FILE="changelogs/CHANGELOG-${{ matrix.variant }}.md"
          
          echo "ðŸ“ Generating comprehensive changelog for ${{ matrix.variant }}..."
          
          # ============================================
          # HEADER SECTION
          # ============================================
          cat > "$CHANGELOG_FILE" << 'HEADER_EOF'
          # ðŸ“‹ Comprehensive Build Changelog
          
          HEADER_EOF
          
          # Add variant info
          case "${{ matrix.variant }}" in
            "tiann")
              echo "**Variant:** Official KernelSU (tiann)" >> "$CHANGELOG_FILE"
              ;;
            "kowsu")
              echo "**Variant:** KowSU Fork (KOWX712)" >> "$CHANGELOG_FILE"
              ;;
            "mksu")
              echo "**Variant:** MKSU Fork (5ec1cff)" >> "$CHANGELOG_FILE"
              ;;
          esac
          
          cat >> "$CHANGELOG_FILE" << HEADER_INFO
          **Build Number:** #${{ github.run_number }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **KernelSU Version:** r${{ env.KSU_VERSION }}
          **SuSFS:** ${{ env.ENABLE_SUSFS == 'true' && 'Enabled' || 'Disabled' }}
          
          ---
          
          HEADER_INFO
          
          # ============================================
          # COMPONENT VERSIONS TABLE
          # ============================================
          cat >> "$CHANGELOG_FILE" << 'TABLE_HEADER'
          ## ðŸ”– Component Versions
          
          | Component | Current Commit | Date | Summary |
          |-----------|---------------|------|---------|
          TABLE_HEADER
          
          echo "| **KernelSU (${{ matrix.variant }})** | \`${{ env.KSU_COMMIT_SHORT }}\` | ${{ env.KSU_COMMIT_DATE }} | ${{ env.KSU_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Kernel (android14-6.1-2025-09)** | \`${{ env.KERNEL_COMMIT_SHORT }}\` | ${{ env.KERNEL_COMMIT_DATE }} | ${{ env.KERNEL_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **SuSFS4KSU** | \`${{ env.SUSFS_COMMIT_SHORT }}\` | ${{ env.SUSFS_COMMIT_DATE }} | ${{ env.SUSFS_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Build Workflow** | \`${{ env.WORKFLOW_COMMIT_SHORT }}\` | ${{ env.WORKFLOW_COMMIT_DATE }} | ${{ env.WORKFLOW_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          # ============================================
          # CHECK FOR PREVIOUS BUILD
          # ============================================
          cd kernel/KernelSU
          PREVIOUS_TAG=$(git tag --list "${{ matrix.variant }}-build-*" --sort=-version:refname 2>/dev/null | head -n 1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # ============================================
            # INITIAL BUILD - Show recent commits
            # ============================================
            echo "## ðŸŽ‰ Initial Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "This is the first tracked build for the **${{ matrix.variant }}** variant. Below are the recent changes in each component:" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # KernelSU Recent Changes
            echo "### ðŸ”§ KernelSU - ${{ matrix.variant }} (Last 10 commits)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/${{ env.KSU_REPO }}" >> "../../$CHANGELOG_FILE"
            echo "**Branch:** ${{ env.KSU_BRANCH }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Kernel Recent Changes
            cd ../../kernel
            echo "### ðŸ§ Kernel - android14-6.1-2025-09 (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/aosp-mirror/kernel_common" >> "../$CHANGELOG_FILE"
            echo "**Branch:** android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # SuSFS Recent Changes
            cd ../susfs4ksu
            echo "### ðŸ›¡ï¸ SuSFS4KSU (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "../$CHANGELOG_FILE"
            echo "**Branch:** gki-android14-6.1-dev" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # Workflow Recent Changes
            cd ..
            echo "### âš™ï¸ Build Workflow (Last 5 commits)" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Repository:** ${{ github.repository }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            git log -5 --pretty=format:"- **%h** - %s (%an, %ar)" -- .github/workflows/ >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            
            echo "---" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_This is the initial tracked build. Future builds will show detailed changes since the last build._" >> "$CHANGELOG_FILE"
            
          else
            # ============================================
            # SUBSEQUENT BUILD - Show changes since last build
            # ============================================
            echo "## ðŸ”„ Changes Since Last Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Previous Build:** \`$PREVIOUS_TAG\`" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Get previous commit from last build metadata
            PREV_KSU_COMMIT=$(git rev-parse "$PREVIOUS_TAG" 2>/dev/null || echo "")
            
            if [ -n "$PREV_KSU_COMMIT" ]; then
              COMMIT_RANGE="${PREV_KSU_COMMIT}..HEAD"
              KSU_CHANGE_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
            else
              KSU_CHANGE_COUNT="unknown"
              COMMIT_RANGE=""
            fi
            
            # KernelSU Changes
            echo "### ðŸ”§ KernelSU - ${{ matrix.variant }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            if [ -n "$COMMIT_RANGE" ] && [ "$KSU_CHANGE_COUNT" != "0" ]; then
              echo "**Changes:** $KSU_CHANGE_COUNT commit(s)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              git log $COMMIT_RANGE --pretty=format:"#### %h - %s%n%n**Author:** %an <%ae>  %n**Date:** %ad%n%n%b%n----%n" --date=format:'%Y-%m-%d %H:%M:%S' >> "../../$CHANGELOG_FILE"
            else
              echo "**Status:** No changes detected (or first build after tag migration)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              echo "_Current commit:_ \`${{ env.KSU_COMMIT_SHORT }}\` - ${{ env.KSU_COMMIT_MSG }}" >> "../../$CHANGELOG_FILE"
            fi
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Note: For kernel, SuSFS, and workflow - we'll show current state since we don't have previous tracking
            
            cd ../../kernel
            echo "### ðŸ§ Kernel - android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.KERNEL_COMMIT_SHORT }}\` - ${{ env.KERNEL_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: Kernel tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ../susfs4ksu
            echo "### ðŸ›¡ï¸ SuSFS4KSU" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.SUSFS_COMMIT_SHORT }}\` - ${{ env.SUSFS_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: SuSFS tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ..
            echo "### âš™ï¸ Build Workflow" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.WORKFLOW_COMMIT_SHORT }}\` - ${{ env.WORKFLOW_COMMIT_MSG }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_Note: Workflow tracking will be enhanced in future builds. Showing current commit._" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
          fi
          
          # ============================================
          # FOOTER SECTION - Links and References
          # ============================================
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "## ðŸ”— Component Links" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### KernelSU (${{ matrix.variant }})" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ env.KSU_REPO }}" >> "$CHANGELOG_FILE"
          echo "- **Branch:** ${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ env.KSU_REPO }}/commit/${{ env.KSU_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Full History:** https://github.com/${{ env.KSU_REPO }}/commits/${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Kernel" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/aosp-mirror/kernel_common" >> "$CHANGELOG_FILE"
          echo "- **Branch:** android14-6.1-2025-09" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/aosp-mirror/kernel_common/commit/${{ env.KERNEL_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### SuSFS4KSU" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "$CHANGELOG_FILE"
          echo "- **Branch:** gki-android14-6.1-dev" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Build Workflow" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ github.repository }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ github.repository }}/commit/${{ env.WORKFLOW_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "_Generated automatically by GitHub Actions on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> "$CHANGELOG_FILE"
          
          # Tag this build for future reference
          cd kernel/KernelSU
          git tag "${{ matrix.variant }}-build-${{ github.run_number }}" 2>/dev/null || true
          
          cd ../..
          
          # Display preview
          echo "ðŸ“ Changelog preview (first 50 lines):"
          head -n 50 "$CHANGELOG_FILE" || cat "$CHANGELOG_FILE"
          
          echo "CHANGELOG_FILE=$CHANGELOG_FILE" >> $GITHUB_ENV
          
          echo "âœ… Comprehensive changelog generated successfully!"

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "ðŸ“¦ Setting up SuSFS..."
          
          # Clean any previously applied patches
          echo "ðŸ§¹ Cleaning kernel directory..."
          cd kernel
          git checkout -- .
          git clean -fd
          cd ..
          
          # Copy SuSFS files
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch - check for variant-specific first
          VARIANT_SUSFS_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_SUSFS_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_SUSFS_PATCH" ]; then
            echo "ðŸ“‹ Applying variant-specific SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_SUSFS_PATCH" || true
          else
            echo "ðŸ“‹ Applying default SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_SUSFS_PATCH" || true
          fi
          
          # Apply KernelSU-specific SuSFS patch
          cd KernelSU
          VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
          DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          if [ -f "$VARIANT_KSU_PATCH" ]; then
            echo "ðŸ“‹ Applying variant-specific KSU SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
          else
            echo "ðŸ“‹ Applying default KSU SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
          fi
          cd ..

      - name: Apply Remote Patches
        run: |
          cd kernel
          
          # CLIDR fix (essential for all variants)
          echo "ðŸ“‹ Applying fix-clidr-uninitialized.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" \
            -o /tmp/fix-clidr.patch
          patch -p1 --forward < /tmp/fix-clidr.patch || true

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Base configuration
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_NET_SCH_CAKE=y
          EOF
          
          # Variant-specific config
          case "${{ matrix.variant }}" in
            "tiann")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "kowsu")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "mksu")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
          esac
          
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            cat >> out/.config << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          fi
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          START_TIME=$SECONDS
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "ðŸ§¹ Performing clean build..."
            make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
          fi
          
          echo "ðŸ—ï¸ Building kernel for ${{ matrix.variant }}..."
          echo "ðŸ“‚ Using CCACHE at: $CCACHE_DIR"
          make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out CC="ccache clang" 2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_MINS=$((BUILD_TIME / 60))
          BUILD_SECS=$((BUILD_TIME % 60))
          echo "BUILD_TIME=${BUILD_MINS}m ${BUILD_SECS}s" >> $GITHUB_ENV

      - name: Check CCACHE Performance
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "ðŸ“ˆ CCACHE stats AFTER build:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Get full ccache stats
          ccache -s
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Extracting Performance Metrics..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Save ccache output to variable
          CCACHE_OUTPUT=$(ccache -s)
          
          # Extract cache size from the last line that mentions "cache size"
          FINAL_CACHE_SIZE=$(echo "$CCACHE_OUTPUT" | grep -i "cache size" | tail -1 | awk '{print $4, $5, $6, $7}' | sed 's/^ *//;s/ *$//')
          
          # Extract hit rate - your format has TWO "Hits:" lines, we want the FIRST one
          # Format: "  Hits:            70522 /  71006 (99.32%)"
          HIT_RATE=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | grep -oE '\([0-9]+\.[0-9]+%\)' | tr -d '()')
          
          # If extraction failed, try alternative method
          if [ -z "$HIT_RATE" ] || [ "$HIT_RATE" = "" ]; then
            echo "âš ï¸  Primary extraction failed, trying calculation method..."
            
            # Get hits and total from first "Hits:" line
            HITS=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | awk '{print $2}')
            TOTAL=$(echo "$CCACHE_OUTPUT" | grep -m1 "Hits:" | awk '{print $4}')
            
            if [ -n "$HITS" ] && [ -n "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
              HIT_RATE=$(awk "BEGIN {printf \"%.2f%%\", ($HITS / $TOTAL) * 100}")
              echo "âœ… Calculated: $HIT_RATE"
            else
              HIT_RATE="N/A"
              echo "âŒ Could not extract hit rate"
              echo "   HITS=$HITS, TOTAL=$TOTAL"
            fi
          else
            echo "âœ… Hit rate extracted: $HIT_RATE"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Final Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¾ Cache Size: $FINAL_CACHE_SIZE"
          echo "ðŸŽ¯ Hit Rate: $HIT_RATE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Export to environment
          echo "FINAL_CACHE_SIZE=$FINAL_CACHE_SIZE" >> $GITHUB_ENV
          echo "CCACHE_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV

      - name: Package Kernel
        run: |
          # Determine which AnyKernel3 branch to use based on variant
          case "${{ matrix.variant }}" in
            "tiann")
              AK3_BRANCH="KernelSU"
              echo "ðŸ“¦ Using AnyKernel3 branch: KernelSU (for tiann variant)"
              ;;
            "kowsu")
              AK3_BRANCH="KowSU"
              echo "ðŸ“¦ Using AnyKernel3 branch: KowSU (for kowsu variant)"
              ;;
            "mksu")
              AK3_BRANCH="MKSU"
              echo "ðŸ“¦ Using AnyKernel3 branch: MKSU (for mksu variant)"
              ;;
          esac
          
          # Clone the appropriate AnyKernel3 branch
          git clone --depth=1 --branch=$AK3_BRANCH \
            https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS.zip"
          else
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          
          echo "âœ… Packaged kernel: $ZIP_NAME"
          echo "ðŸ“‹ Using AnyKernel3 branch: $AK3_BRANCH"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
            ${{ env.CHANGELOG_FILE }}
          retention-days: 30

  create_release:
    needs: build
    runs-on: [self-hosted, Linux, X64]
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          cd release-assets
          
          # Flatten directory structure
          find . -type f -exec mv {} . \; 2>/dev/null || true
          find . -type d -empty -delete
          
          ls -lh
          
          # Count variants built
          VARIANT_COUNT=$(ls -1 CHANGELOG-*.md 2>/dev/null | wc -l)
          echo "VARIANT_COUNT=$VARIANT_COUNT" >> $GITHUB_ENV
          
          # Get build date from any changelog (they're all from same run)
          if [ -f "CHANGELOG-tiann.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-tiann.md | head -1 | cut -d':' -f2- | xargs)
          elif [ -f "CHANGELOG-kowsu.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-kowsu.md | head -1 | cut -d':' -f2- | xargs)
          elif [ -f "CHANGELOG-mksu.md" ]; then
            BUILD_DATE=$(grep "Build Date:" CHANGELOG-mksu.md | head -1 | cut -d':' -f2- | xargs)
          else
            BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          fi
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          
          # Determine which variants were built
          VARIANTS_BUILT=""
          [ -f "CHANGELOG-tiann.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}tiann "
          [ -f "CHANGELOG-kowsu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}kowsu "
          [ -f "CHANGELOG-mksu.md" ] && VARIANTS_BUILT="${VARIANTS_BUILT}mksu "
          echo "VARIANTS_BUILT=$VARIANTS_BUILT" >> $GITHUB_ENV

      - name: Generate Unified Release Notes
        run: |
          cd release-assets
          
          cat > RELEASE_NOTES.md << 'EOF'
          # ðŸš€ GKI Kernel Build #${{ github.run_number }}
          
          **Build Date:** ${{ env.BUILD_DATE }}
          **Variants:** ${{ env.VARIANTS_BUILT }}
          
          ---
          
          EOF
          
          # Add sections for each variant
          if [ -f "CHANGELOG-tiann.md" ]; then
            cat >> RELEASE_NOTES.md << 'TIANN_EOF'
          ## ðŸ”§ tiann - Official KernelSU
          
          TIANN_EOF
            
            # Extract version info
            KSU_VERSION=$(grep "KernelSU Version:" CHANGELOG-tiann.md | head -1 | cut -d':' -f2 | xargs)
            SUSFS_STATUS=$(grep "SuSFS:" CHANGELOG-tiann.md | head -1 | cut -d':' -f2 | xargs)
            KSU_COMMIT=$(grep "| \*\*KernelSU" CHANGELOG-tiann.md | head -1 | grep -oE '\`[a-f0-9]+\`' | tr -d '\`')
            
            cat >> RELEASE_NOTES.md << TIANN_INFO
          **KernelSU Version:** $KSU_VERSION  
          **SuSFS:** $SUSFS_STATUS  
          **Commit:** \`$KSU_COMMIT\`
          
          ðŸ“‹ **[Full Changelog](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/CHANGELOG-tiann.md)**
          
          **Download:**
          - Kernel: \`$(ls AK3-*-TIANN-*.zip | head -1)\`
          - Checksums: SHA256 | MD5
          
          ---
          
          TIANN_INFO
          fi
          
          if [ -f "CHANGELOG-kowsu.md" ]; then
            cat >> RELEASE_NOTES.md << 'KOWSU_EOF'
          ## ðŸ”§ kowsu - KowSU Fork
          
          KOWSU_EOF
            
            KSU_VERSION=$(grep "KernelSU Version:" CHANGELOG-kowsu.md | head -1 | cut -d':' -f2 | xargs)
            SUSFS_STATUS=$(grep "SuSFS:" CHANGELOG-kowsu.md | head -1 | cut -d':' -f2 | xargs)
            KSU_COMMIT=$(grep "| \*\*KernelSU" CHANGELOG-kowsu.md | head -1 | grep -oE '\`[a-f0-9]+\`' | tr -d '\`')
            
            cat >> RELEASE_NOTES.md << KOWSU_INFO
          **KernelSU Version:** $KSU_VERSION  
          **SuSFS:** $SUSFS_STATUS  
          **Commit:** \`$KSU_COMMIT\`
          
          ðŸ“‹ **[Full Changelog](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/CHANGELOG-kowsu.md)**
          
          **Download:**
          - Kernel: \`$(ls AK3-*-KOWSU-*.zip | head -1)\`
          - Checksums: SHA256 | MD5
          
          ---
          
          KOWSU_INFO
          fi
          
          if [ -f "CHANGELOG-mksu.md" ]; then
            cat >> RELEASE_NOTES.md << 'MKSU_EOF'
          ## ðŸ”§ mksu - MKSU Fork
          
          MKSU_EOF
            
            KSU_VERSION=$(grep "KernelSU Version:" CHANGELOG-mksu.md | head -1 | cut -d':' -f2 | xargs)
            SUSFS_STATUS=$(grep "SuSFS:" CHANGELOG-mksu.md | head -1 | cut -d':' -f2 | xargs)
            KSU_COMMIT=$(grep "| \*\*KernelSU" CHANGELOG-mksu.md | head -1 | grep -oE '\`[a-f0-9]+\`' | tr -d '\`')
            
            cat >> RELEASE_NOTES.md << MKSU_INFO
          **KernelSU Version:** $KSU_VERSION  
          **SuSFS:** $SUSFS_STATUS  
          **Commit:** \`$KSU_COMMIT\`
          
          ðŸ“‹ **[Full Changelog](https://github.com/${{ github.repository }}/releases/download/build-${{ github.run_number }}/CHANGELOG-mksu.md)**
          
          **Download:**
          - Kernel: \`$(ls AK3-*-MKSU-*.zip | head -1)\`
          - Checksums: SHA256 | MD5
          
          ---
          
          MKSU_INFO
          fi
          
          cat >> RELEASE_NOTES.md << 'FOOTER_EOF'
          
          ## ðŸ“¦ Installation Instructions
          
          1. Download the kernel ZIP for your preferred variant
          2. Verify checksums (optional but recommended)
          3. Flash the ZIP in custom recovery (TWRP/OrangeFox)
          4. Reboot and enjoy!
          
          ## ðŸ”— Resources
          
          - **Repository:** https://github.com/${{ github.repository }}
          - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          
          _All variants built from the same kernel base (android14-6.1-2025-09) with variant-specific KernelSU implementations._
          FOOTER_EOF
          
          echo "âœ… Unified release notes generated"
          cat RELEASE_NOTES.md

      - name: Create Unified Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Build #${{ github.run_number }} - All Variants"
          body_path: release-assets/RELEASE_NOTES.md
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [create_release]
    runs-on: [self-hosted, Linux, X64]
    if: always()
    steps:
      - name: Send Success Notification
        if: ${{ needs.create_release.result == 'success' && github.event.inputs.enable_telegram == 'true' }}
        run: |
          VARIANT_INPUT="${{ github.event.inputs.ksu_variant }}"
          if [ "$VARIANT_INPUT" = "all" ]; then
            VARIANTS="tiann, kowsu, mksu"
          else
            VARIANTS="$VARIANT_INPUT"
          fi
          
          MESSAGE="âœ… *Kernel Build #${{ github.run_number }} completed successfully!*
          
          ðŸ“¦ *Variants:* ${VARIANTS}
          â±ï¸ *Build Time:* Started at ${{ github.event.repository.updated_at }}
          ðŸ’¾ *SuSFS:* ${{ github.event.inputs.disable_susfs == 'true' && 'Disabled' || 'Enabled' }}
          
          ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/build-${{ github.run_number }})
          ðŸ“Š [View Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Send Failure Notification
        if: ${{ (needs.create_release.result == 'failure' || needs.build.result == 'failure') && github.event.inputs.enable_telegram == 'true' }}
        run: |
          VARIANT_INPUT="${{ github.event.inputs.ksu_variant }}"
          if [ "$VARIANT_INPUT" = "all" ]; then
            VARIANTS="tiann, kowsu, mksu"
          else
            VARIANTS="$VARIANT_INPUT"
          fi
          
          if [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_STAGE="Build"
          else
            FAILED_STAGE="Release Creation"
          fi
          
          MESSAGE="âŒ *Kernel Build #${{ github.run_number }} FAILED!*
          
          ðŸ“¦ *Variants:* ${VARIANTS}
          âš ï¸ *Failed Stage:* ${FAILED_STAGE}
          ðŸ’¾ *SuSFS:* ${{ github.event.inputs.disable_susfs == 'true' && 'Disabled' || 'Enabled' }}
          
          ðŸ”— [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          Please check the logs for details."
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Send Cancellation Notification
        if: ${{ (needs.create_release.result == 'cancelled' || needs.build.result == 'cancelled') && github.event.inputs.enable_telegram == 'true' }}
        run: |
          MESSAGE="âš ï¸ *Kernel Build #${{ github.run_number }} was cancelled*
          
          ðŸ”— [View Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
