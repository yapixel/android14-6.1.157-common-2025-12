name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Weekly builds on Sunday

env:
  # Use your local self-hosted toolchain paths
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  CCACHE_MAXSIZE: 50G
  CCACHE_NOHASHDIR: 1
  MAKE_JOBS: 8

jobs:
  build-previous:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      previous_build_time: ${{ steps.previous-time.outputs.previous_build_time }}
    steps:
      - name: Get Previous Build Time
        id: previous-time
        run: |
          # Try to get the last successful build time from workflow artifacts or API
          PREVIOUS_TIME="N/A"
          
          # Method 1: Check if we can access previous workflow data
          if [ -f "/mnt/ccache/last_build_time" ]; then
            PREVIOUS_TIME=$(cat /mnt/ccache/last_build_time 2>/dev/null || echo "N/A")
            echo "üìä Found previous build time: $PREVIOUS_TIME"
          else
            echo "‚ÑπÔ∏è No previous build time recorded, first build?"
          fi
          
          # Store current build start time for next run
          echo "$(date +%s)" > /mnt/ccache/current_build_start || true
          
          echo "previous_build_time=$PREVIOUS_TIME" >> $GITHUB_OUTPUT

  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90
    needs: build-previous

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Get SuSFS Version from GitLab
        id: susfs-version
        run: |
          echo "üîç Fetching SuSFS version from GitLab..."
          
          # Try multiple methods to get the version
          SUSFS_VERSION="unknown"
          
          # Method 1: Check if we have local susfs4ksu directory with version info
          if [ -d "susfs4ksu" ]; then
            echo "üìÅ Checking local susfs4ksu directory for version..."
            
            # Look for version in README, docs, or any version files
            if [ -f "susfs4ksu/README.md" ]; then
              VERSION_FROM_README=$(grep -i "version" susfs4ksu/README.md | head -1 | grep -Eo "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
              if [ -n "$VERSION_FROM_README" ]; then
                SUSFS_VERSION="$VERSION_FROM_README"
                echo "‚úÖ Found version in README: $SUSFS_VERSION"
              fi
            fi
            
            # Check for version in any docs files
            if [ "$SUSFS_VERSION" = "unknown" ] && [ -f "susfs4ksu/docs/CHANGELOG.md" ]; then
              VERSION_FROM_CHANGELOG=$(grep -i "version" susfs4ksu/docs/CHANGELOG.md | head -1 | grep -Eo "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
              if [ -n "$VERSION_FROM_CHANGELOG" ]; then
                SUSFS_VERSION="$VERSION_FROM_CHANGELOG"
                echo "‚úÖ Found version in CHANGELOG: $SUSFS_VERSION"
              fi
            fi
          fi
          
          # Method 2: Fetch from GitLab API
          if [ "$SUSFS_VERSION" = "unknown" ]; then
            echo "üåê Fetching from GitLab API..."
            GITLAB_URL="https://gitlab.com/api/v4/projects/simonpunk%2Fsusfs4ksu/repository/tags"
            
            # Try to get the latest tag
            if LATEST_TAG=$(curl -s "$GITLAB_URL" | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4); then
              if [ -n "$LATEST_TAG" ]; then
                SUSFS_VERSION="$LATEST_TAG"
                echo "‚úÖ Found latest tag from GitLab API: $SUSFS_VERSION"
              else
                echo "‚ö†Ô∏è No tags found via GitLab API"
              fi
            else
              echo "‚ö†Ô∏è Failed to fetch from GitLab API"
            fi
          fi
          
          # Method 3: Check the branch name or fallback
          if [ "$SUSFS_VERSION" = "unknown" ]; then
            echo "üîç Checking branch/repo structure for version hints..."
            # If we're using the gki-android14-6.1 branch, we can infer it's compatible with v2.0.0
            # Based on the current known version
            SUSFS_VERSION="2.0.0"
            echo "‚ÑπÔ∏è Using default version: $SUSFS_VERSION"
          fi
          
          # Clean up version string (remove 'v' prefix if present)
          SUSFS_VERSION=$(echo "$SUSFS_VERSION" | sed 's/^v//')
          
          echo "üéØ Final SuSFS Version: $SUSFS_VERSION"
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> $GITHUB_ENV
          echo "susfs_version=$SUSFS_VERSION" >> $GITHUB_OUTPUT

      - name: Clean Submodule Configuration
        run: |
          echo "üßπ Cleaning submodule configuration..."
          # Remove .gitmodules if it exists
          rm -f .gitmodules 2>/dev/null || true
          # Remove any submodule configs
          git config --remove-section submodule.kernel 2>/dev/null || true
          git config --remove-section submodule.susfs4ksu 2>/dev/null || true
          # Remove module directories
          rm -rf .git/modules/kernel 2>/dev/null || true
          rm -rf .git/modules/susfs4ksu 2>/dev/null || true
          echo "‚úÖ Submodule configuration cleaned"

      - name: Ensure Correct Kernel Source
        run: |
          echo "üîÑ Ensuring correct Android 14 6.1 2025-09 kernel source..."
          
          # Check if local kernel exists and is correct version
          if [ -d "kernel" ] && [ -f "kernel/Makefile" ]; then
            echo "üîç Checking existing kernel version..."
            cd kernel
            VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
            cd ..
            
            if [ "$VERSION" = "6" ] && [ "$PATCHLEVEL" = "1" ]; then
              echo "‚úÖ Local kernel is already correct version (6.1.x), skipping clone"
              exit 0
            else
              echo "‚ö†Ô∏è Local kernel is wrong version ($VERSION.$PATCHLEVEL), will replace"
            fi
          else
            echo "üì• No local kernel found or invalid, will clone"
          fi
          
          # Remove existing kernel directory if wrong version
          rm -rf kernel
          
          # Clone from AOSP mirror with the exact branch
          echo "üîç Cloning from AOSP mirror - android14-6.1-2025-09 branch..."
          if git clone --depth=1 --branch=android14-6.1-2025-09 https://github.com/aosp-mirror/kernel_common kernel; then
            echo "‚úÖ Successfully cloned android14-6.1-2025-09 branch from AOSP mirror"
          else
            echo "‚ùå CRITICAL: Failed to clone android14-6.1-2025-09 branch from AOSP mirror"
            echo "üí° Check if the branch exists: https://github.com/aosp-mirror/kernel_common/tree/android14-6.1-2025-09"
            exit 1
          fi
          
          # Remove .git to make it a regular directory
          rm -rf kernel/.git
          
          # Verify kernel version
          echo "üîç Verifying kernel version..."
          cd kernel
          if [ -f "Makefile" ]; then
            VERSION=$(grep "^VERSION" Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" Makefile | cut -d' ' -f3)
            SUBLEVEL=$(grep "^SUBLEVEL" Makefile | cut -d' ' -f3)
            echo "‚úÖ Kernel Version: $VERSION.$PATCHLEVEL.$SUBLEVEL"
            
            # Verify it's actually 6.1.x
            if [ "$VERSION" != "6" ] || [ "$PATCHLEVEL" != "1" ]; then
              echo "‚ùå WRONG KERNEL VERSION! Expected 6.1.x, got $VERSION.$PATCHLEVEL.$SUBLEVEL"
              exit 1
            else
              echo "üéØ Correct kernel version: Android 14 6.1.xxx"
            fi
          else
            echo "‚ùå Makefile not found - invalid kernel source"
            exit 1
          fi
          cd ..
          
          echo "üìä Kernel source verified and ready"

      - name: Verify susfs4ksu Directory
        run: |
          echo "üîç Verifying susfs4ksu directory..."
          if [ ! -d "susfs4ksu" ]; then
            echo "‚ùå susfs4ksu directory missing"
            exit 1
          fi
          # Remove any embedded git
          if [ -d "susfs4ksu/.git" ]; then
            rm -rf susfs4ksu/.git
            echo "‚úÖ Removed embedded git from susfs4ksu"
          fi
          echo "üìä susfs4ksu contents:"
          ls -la susfs4ksu/ | head -5
          echo "‚úÖ susfs4ksu directory ready"

      - name: Patch setlocalversion Script
        run: |
          cd kernel
          if [ ! -f "scripts/setlocalversion" ]; then
            echo "‚ùå scripts/setlocalversion not found"
            ls -la scripts/ | head -10
            exit 1
          fi
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion
          echo "‚úÖ setlocalversion patched to prevent dirty flag"

      - name: Integrate KernelSU & Generate Version
        run: |
          cd kernel
          
          echo "üîß Installing KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          
          cd KernelSU
          
          # Ensure we have full history for version calculation
          if [ "$(git rev-parse --is-shallow-repository)" = "true" ]; then
            echo "üì¶ Unshallowing KernelSU repository..."
            git fetch --unshallow
          fi
          
          # Count commits and calculate version
          KSU_COUNT=$(git rev-list --count HEAD)
          echo "KernelSU Commit Count: $KSU_COUNT"
          KSU_VERSION=$((KSU_COUNT + 20000))
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "‚úÖ Calculated KernelSU Version: r$KSU_VERSION"

      - name: Copy SuSFS Files to Kernel
        run: |
          echo "üìÅ Copying SuSFS files to kernel..."
          
          # Copy SuSFS source files
          if [ -f "susfs4ksu/kernel_patches/fs/susfs.c" ]; then
            cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
            echo "‚úÖ Copied susfs.c to kernel/fs/"
          else
            echo "‚ùå susfs.c not found"
            ls -la susfs4ksu/kernel_patches/fs/ 2>/dev/null || echo "fs directory not found"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
            echo "‚úÖ Copied susfs.h to kernel/include/linux/"
          else
            echo "‚ùå susfs.h not found"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs_def.h" ]; then
            cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
            echo "‚úÖ Copied susfs_def.h to kernel/include/linux/"
          else
            echo "‚ùå susfs_def.h not found"
            exit 1
          fi
          
          echo "‚úÖ All SuSFS files copied successfully"

      - name: Apply SuSFS Patches
        run: |
          echo "üîß Applying SuSFS patches..."
          
          # Apply main SuSFS integration patch
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch" ]; then
            echo "üìã Applying 50_add_susfs_in_gki-android14-6.1.patch"
            cd kernel
            if patch -p1 --forward --no-backup-if-mismatch < "../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"; then
              echo "‚úÖ Main SuSFS patch applied"
            else
              echo "‚ö†Ô∏è Main SuSFS patch may already be applied"
            fi
            cd ..
          else
            echo "‚ùå Main SuSFS patch not found"
            exit 1
          fi
          
          # Apply KernelSU SuSFS enablement patch
          if [ -f "susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" ] && [ -d "kernel/KernelSU" ]; then
            echo "üìã Applying 10_enable_susfs_for_ksu.patch to KernelSU"
            cd kernel/KernelSU
            patch -p1 --forward --no-backup-if-mismatch < "../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || echo "‚ö†Ô∏è KernelSU patch may already be applied"
            cd ../..
          fi
          
          # Download and apply the CLIDR fix patch from external source
          echo "üìã Downloading and applying fix-clidr-uninitialized.patch"
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" -o fix-clidr-uninitialized.patch
          if [ -f "fix-clidr-uninitialized.patch" ]; then
            if patch -p1 --forward --no-backup-if-mismatch < "fix-clidr-uninitialized.patch"; then
              echo "‚úÖ CLIDR fix patch applied successfully"
              rm fix-clidr-uninitialized.patch
            else
              echo "‚ö†Ô∏è CLIDR fix patch may already be applied"
              rm fix-clidr-uninitialized.patch
            fi
          else
            echo "‚ùå Failed to download CLIDR fix patch"
            exit 1
          fi
          
          # Download and apply the proc base fix patch (fourth patch)
          echo "üìã Downloading and applying fix_proc_base.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix_proc_base.patch" -o fix_proc_base.patch
          if [ -f "fix_proc_base.patch" ]; then
            if patch -p1 --forward --no-backup-if-mismatch < "fix_proc_base.patch"; then
              echo "‚úÖ proc base fix patch applied successfully"
              rm fix_proc_base.patch
            else
              echo "‚ö†Ô∏è proc base fix patch may already be applied"
              rm fix_proc_base.patch
            fi
          else
            echo "‚ùå Failed to download proc base fix patch"
            exit 1
          fi
          cd ..
          
          echo "üéâ All 4 patches applied in correct order"

      - name: Setup CCACHE Environment
        run: |
          echo "üîß Setting up CCACHE environment..."
          export PATH="/usr/lib/ccache:$PATH"
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache -z
          echo "üìä CCACHE configuration:"
          ccache -p
          echo "‚úÖ CCACHE environment configured"

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"

          echo "‚öôÔ∏è Generating kernel configuration..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          echo "üîß Applying custom configurations..."
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KSU_KPROBES_HOOK=n
          CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
          CONFIG_KSU_ALLOWLIST_WORKAROUND=n
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION="-deepongi+"
          CONFIG_NET_SCH_CAKE=y
          EOF

          rm -vf android/abi_gki_protected_exports_* || true
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "‚úÖ Kernel configured successfully"
          echo "üìã Key configurations:"
          grep -E "CONFIG_(KSU|SUSFS|LTO|LOCALVERSION)" out/.config

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export KBUILD_BUILD_TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          export KBUILD_BUILD_USER=github-actions
          export KBUILD_BUILD_HOST=github
          export CC="ccache clang"

          NPROC=$(nproc || echo 8)

          echo "üèóÔ∏è Building kernel using $NPROC cores..."
          echo "üìä CCACHE stats before build:"
          ccache -s

          START_TIME=$SECONDS

          make -j"$NPROC" \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}" \
            CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
            CC="$CC" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out 2>&1 | tee build.log

          BUILD_STATUS=${PIPESTATUS[0]}
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))

          echo "üìä CCACHE stats after build:"
          ccache -s

          if [ $BUILD_STATUS -eq 0 ] && [ -f out/arch/arm64/boot/Image ]; then
            echo "‚úÖ Kernel built successfully in ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
            
            # Store build time for next run
            echo "${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s" > /mnt/ccache/last_build_time || true
          else
            echo "‚ùå Kernel build failed after ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ github.run_number }}
          path: |
            kernel/build.log
            kernel/out/.config
          retention-days: 30

      - name: Extract CCACHE Hit Rate
        id: ccache-stats
        if: success()
        run: |
          echo "üìä Extracting CCACHE hit rate..."
          
          # Get ccache stats and save to file for debugging
          ccache -s > ccache_stats.txt
          echo "üìÑ CCACHE stats saved to ccache_stats.txt:"
          cat ccache_stats.txt
          
          # Multiple methods to extract hit rate - try each one
          HIT_RATE="N/A"
          
          # Method 1: Look for cache hit rate line
          if HIT_RATE=$(ccache -s | grep -i "cache hit" | grep -Eo "[0-9]+\.[0-9]+%"); then
            echo "‚úÖ Hit rate found via method 1: $HIT_RATE"
          # Method 2: Look for hit rate in different format
          elif HIT_RATE=$(ccache -s | grep -i "hit rate" | grep -Eo "[0-9]+\.[0-9]+%"); then
            echo "‚úÖ Hit rate found via method 2: $HIT_RATE"
          # Method 3: Look for percentage in cache hit section
          elif HIT_RATE=$(ccache -s | awk '/cache hit/ || /hit rate/ {for(i=1;i<=NF;i++) if($i ~ /%/) {print $i; exit}}'); then
            echo "‚úÖ Hit rate found via method 3: $HIT_RATE"
          # Method 4: Calculate manually from direct/primary/preprocessed stats
          else
            echo "‚ö†Ô∏è Using manual calculation method"
            # Extract cache hit/miss counts
            DIRECT_HITS=$(ccache -s | grep -i "direct cache hit" | grep -Eo "[0-9]+" | head -1)
            DIRECT_MISSES=$(ccache -s | grep -i "direct cache miss" | grep -Eo "[0-9]+" | head -1)
            PREPROCESSED_HITS=$(ccache -s | grep -i "preprocessed cache hit" | grep -Eo "[0-9]+" | head -1)
            PREPROCESSED_MISSES=$(ccache -s | grep -i "preprocessed cache miss" | grep -Eo "[0-9]+" | head -1)
            
            TOTAL_HITS=$((DIRECT_HITS + PREPROCESSED_HITS))
            TOTAL_MISSES=$((DIRECT_MISSES + PREPROCESSED_MISSES))
            TOTAL_REQUESTS=$((TOTAL_HITS + TOTAL_MISSES))
            
            if [ $TOTAL_REQUESTS -gt 0 ]; then
              HIT_RATE_PERCENT=$(echo "scale=2; $TOTAL_HITS * 100 / $TOTAL_REQUESTS" | bc)
              HIT_RATE="${HIT_RATE_PERCENT}%"
              echo "‚úÖ Hit rate calculated manually: $HIT_RATE"
            else
              HIT_RATE="0%"
              echo "‚ö†Ô∏è No cache requests, hit rate set to 0%"
            fi
          fi
          
          # Fallback if still not found
          if [ -z "$HIT_RATE" ] || [ "$HIT_RATE" = "N/A" ]; then
            HIT_RATE="Unknown"
            echo "‚ùå Could not determine CCACHE hit rate"
          fi
          
          echo "CCACHE_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV
          echo "üìä Final CCACHE hit rate: $HIT_RATE"

      - name: Extract Build Metadata
        if: success()
        run: |
          echo "üîß Extracting build metadata..."
          
          if [ $BUILD_TIME -lt 300 ]; then
            BUILD_SPEED="üöÄ Very Fast"
          elif [ $BUILD_TIME -lt 600 ]; then
            BUILD_SPEED="‚ö° Fast"
          elif [ $BUILD_TIME -lt 900 ]; then
            BUILD_SPEED="‚úÖ Normal"
          else
            BUILD_SPEED="üê¢ Slow"
          fi
          echo "BUILD_SPEED_STATUS=$BUILD_SPEED" >> $GITHUB_ENV
          
          echo "‚úÖ Build metadata extracted"

      - name: Get Changes Since Last Build
        id: changes
        if: success()
        run: |
          echo "üìù Gathering build changes information..."
          KSU_CHANGES="### üîß KernelSU Changes\n‚Ä¢ Built from latest main branch"
          LOCAL_CHANGES=$(git log --oneline --pretty=format:"‚Ä¢ %s" -n 3 2>/dev/null || echo "‚Ä¢ Local: Initial build")
          ALL_CHANGES="$KSU_CHANGES\n\n### üìù Repository Changes\n$LOCAL_CHANGES"
          ALL_CHANGES="${ALL_CHANGES//'%'/'%25'}"
          ALL_CHANGES="${ALL_CHANGES//$'\n'/'%0A'}"
          echo "CHANGES_SINCE_LAST_BUILD<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "‚úÖ Changes information gathered"

      - name: Prepare AnyKernel3
        if: success()
        run: |
          echo "üì¶ Preparing AnyKernel3..."
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github

          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          if [ -d "../susfs4ksu/ksu_module_susfs" ]; then
            echo "üì¶ Adding KSU SuSFS module..."
            mkdir -p modules
            cp -r ../susfs4ksu/ksu_module_susfs/* modules/
          fi

          cat > build.info << EOF
          build.date=$(date -u +%Y-%m-%d)
          build.time=$(date -u +%H:%M:%S)
          build.commit=${{ github.sha }}
          build.run=${{ github.run_number }}
          build.duration=${{ env.BUILD_TIME }}s
          build.ccache_hit_rate=${{ env.CCACHE_HIT_RATE }}
          build.susfs_version=${{ env.SUSFS_VERSION }}
          EOF

          echo "‚úÖ AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          ZIP_NAME="AK3-6.1.145-KSU-${TIMESTAMP}-r${{ env.KSU_VERSION }}-susfs${{ env.SUSFS_VERSION }}.zip"
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          echo "üì¶ Package created: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"

      - name: Upload Kernel Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            ccache_stats.txt
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU & SuSFS
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Performance
            - **Compilation Time:** ${{ env.BUILD_TIME_MIN }}m ${{ env.BUILD_TIME_SEC }}s (${{ env.BUILD_SPEED_STATUS }})
            - **Previous Build Time:** ${{ needs.build-previous.outputs.previous_build_time }}
            - **CCACHE Hit Rate:** ${{ env.CCACHE_HIT_RATE }}
            
            ### üîß Components Versions
            - **KernelSU Version:** r${{ env.KSU_VERSION }}
            - **SuSFS Version:** ${{ env.SUSFS_VERSION }}
            - **Kernel Base:** Android 14 6.1 GKI
            - **Toolchain:** Clang 22.0.0 + ARM GNU Toolchain 14.3
            
            ### üìà Changes Since Last Build
            ${{ steps.changes.outputs.CHANGES_SINCE_LAST_BUILD }}
            
            ### üõ†Ô∏è Build Configuration
            - **LTO:** ThinLTO enabled
            - **Optimization:** -O2 with performance tuning
            - **Architecture:** ARM64 with Cortex-X3/A715/A510 optimization
            - **Security:** KernelSU LSM hooks + SuSFS hiding
            - **Includes:** KSU SuSFS module for root hiding
            
            ### üì¶ Installation
            1. Download the ZIP file below
            2. Verify checksums (SHA256/MD5)
            3. Boot to custom recovery (TWRP/OrangeFox)
            4. Flash the ZIP file
            5. Reboot and enjoy!
            
            ### üîê File Verification
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```
            
            ### üìã Technical Details
            - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - **Commit:** ${{ github.sha }}
            - **Runner:** Self-hosted (${{ runner.os }})
            - **Workflow Run:** ${{ github.run_id }}
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}