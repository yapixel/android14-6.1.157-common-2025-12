name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev \
            libncurses5-dev git wget curl lz4 zstd python3 python3-pip cpio kmod pahole
          
      - name: Setup Custom Toolchain
        run: |
          set -e
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          
          echo "Checking for existing toolchains..."
          
          # Always ensure a fresh clang/ directory
          rm -rf clang
          mkdir -p clang
          
          # Download + extract Clang
          if [ -f "clang-toolchain.tar.gz" ]; then
            echo "Using cached clang-toolchain.tar.gz"
          else
            echo "Downloading Clang toolchain..."
            wget -q -O clang-toolchain.tar.gz "https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz"
          fi
          
          # Do NOT use --strip-components; layout may already have bin/ at root
          tar -xzf clang-toolchain.tar.gz -C clang
          
          # Download + extract ARM64 GCC if needed
          if [ ! -d "arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin" ]; then
            echo "Downloading ARM64 GCC toolchain..."
            wget -q -O gcc-arm64.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz"
            tar -xf gcc-arm64.tar.xz
          fi
          
          # Download + extract ARM32 GCC if needed
          if [ ! -d "arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin" ]; then
            echo "Downloading ARM32 GCC toolchain..."
            wget -q -O gcc-arm32.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz"
            tar -xf gcc-arm32.tar.xz
          fi
          
          echo "Locating Clang binary..."
          CLANG_BIN_PATH=$(find "$PWD/clang" -maxdepth 4 -type f -name clang | head -1)
          if [ -z "$CLANG_BIN_PATH" ]; then
            echo "::error:: clang binary not found inside extracted clang toolchain"
            find "$PWD/clang" -maxdepth 4 -type d -print
            exit 1
          fi
          CLANG_BIN_DIR=$(dirname "$CLANG_BIN_PATH")
          echo "Detected CLANG_BIN=$CLANG_BIN_DIR"
          echo "CLANG_BIN=$CLANG_BIN_DIR" >> $GITHUB_ENV
          
          # Validate ld.lld in same bin dir
          if [ ! -f "$CLANG_BIN_DIR/ld.lld" ]; then
            echo "::error:: ld.lld not found next to clang in $CLANG_BIN_DIR"
            ls -la "$CLANG_BIN_DIR"
            exit 1
          fi
          
          # Set GCC toolchain env vars
          ARM64_DIR=$(find . -maxdepth 1 -type d -name "*aarch64*" | head -1)
          if [ -z "$ARM64_DIR" ]; then
            echo "::error:: ARM64 toolchain directory not found"
            exit 1
          fi
          echo "ARM64_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM64_DIR}/bin/aarch64-none-linux-gnu-" >> $GITHUB_ENV
          
          ARM32_DIR=$(find . -maxdepth 1 -type d -name "*arm-none*" | head -1)
          if [ -z "$ARM32_DIR" ]; then
            echo "::error:: ARM32 toolchain directory not found"
            exit 1
          fi
          echo "ARM32_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM32_DIR}/bin/arm-none-eabi-" >> $GITHUB_ENV
          
          echo "âœ“ Clang version:"
          "$CLANG_BIN_DIR/clang" --version | head -5
          
          echo "âœ“ ARM64 GCC version:"
          "${{ github.workspace }}/toolchain/${ARM64_DIR}/bin/aarch64-none-linux-gnu-gcc" --version | head -1

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: kernel-build-${{ github.sha }}
          restore-keys: |
            kernel-build-

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 --branch=android14-6.1-2025-09 https://android.googlesource.com/kernel/common kernel
          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Integrate KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          echo "KernelSU integrated successfully"

      - name: Clone and Integrate SuSFS
        run: |
          git clone --depth=1 --branch=gki-android14-6.1 https://gitlab.com/simonpunk/susfs4ksu.git susfs
          cd kernel
          cp ${{ github.workspace }}/susfs/kernel_patches/fs/susfs.c fs/
          cp ${{ github.workspace }}/susfs/kernel_patches/include/linux/susfs.h include/linux/
          cp ${{ github.workspace }}/susfs/kernel_patches/include/linux/susfs_def.h include/linux/
          echo "SuSFS files copied successfully"

      - name: Apply Custom Patch 1 (Kernel Root)
        run: |
          cd kernel
          curl -L "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/fix-clidr-uninitialized.patch" -o patch_0.patch
          patch -p1 < patch_0.patch || echo "Patch 0 failed, continuing..."
          cd ${{ github.workspace }}/kernel

      - name: Apply Custom Patch 2 (KernelSU Folder)
        run: |
          cd kernel/KernelSU
          curl -L "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/10_enable_susfs_for_ksu.patch" -o patch_1.patch
          patch -p1 < patch_1.patch || echo "Patch 1 failed, continuing..."
          cd ${{ github.workspace }}/kernel

      - name: Apply Custom Patch 3 (Kernel Root)
        run: |
          cd kernel
          curl -L "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/50_add_susfs_in_gki-android14-6.1.patch" -o patch_2.patch
          patch -p1 < patch_2.patch || echo "Patch 2 failed, continuing..."
          cd ${{ github.workspace }}/kernel

      - name: Apply Custom Patch 4 (Kernel Root)
        run: |
          cd kernel
          curl -L "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/fix_proc_base.patch" -o patch_3.patch
          patch -p1 < patch_3.patch || echo "Patch 3 failed, continuing..."
          cd ${{ github.workspace }}/kernel

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          
          # Set Clang path FIRST and verify it works
          CLANG_BIN="${{ github.workspace }}/toolchain/clang/bin"
          if [ ! -d "$CLANG_BIN" ]; then
            echo "::error::Clang bin directory not found at $CLANG_BIN"
            exit 1
          fi
          export PATH="$CLANG_BIN:$PATH"
          
          # Verify ld.lld exists and is accessible
          if [ ! -f "$CLANG_BIN/ld.lld" ]; then
            echo "::error::ld.lld not found at $CLANG_BIN/ld.lld"
            ls -la "$CLANG_BIN/" | grep -i ld || echo "No ld files found"
            exit 1
          fi
          
          echo "âœ“ ld.lld found at: $(which ld.lld)"
          echo "âœ“ ld.lld version:"
          ld.lld --version
          
          # Set toolchain vars (don't add to PATH, just use CROSS_COMPILE)
          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}
          
          # Modify defconfig
          echo "CONFIG_ARM64_PA_BITS=48" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_4K_PAGES=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_TAGGED_ADDR_ABI=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_PAN=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_PTR_AUTH=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_SCHED_MC=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ENERGY_MODEL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_UCLAMP_TASK=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_UCLAMP_TASK_GROUP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPU_FREQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPUFREQ_DT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPU_IDLE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM_PSCI_CPUIDLE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CPU_THERMAL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_FAIR_GROUP_SCHED=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_CORTEX_X3=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_CORTEX_A715=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_CORTEX_A510=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_COMPACTION=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_MQ_IOSCHED_DEADLINE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IOSCHED_BFQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TRANSPARENT_HUGEPAGE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_VA_BITS=48" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_SVE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_SME=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ARM64_BTI=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_SCHED_CORE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_PERF_EVENTS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_OPP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEVFREQ_THERMAL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL_GOV_STEP_WISE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL_GOV_FAIR_SHARE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL_EMULATION=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_THERMAL_WRITABLE_TRIPS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_POWER_CAP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NUMA_BALANCING=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CMA=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CMA_AREAS=7" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_CUBIC=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ_CODEL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_CAKE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_FQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_XATTR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_POSIX_ACL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_SECURITY=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LOCALVERSION_AUTO=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_KPROBES_HOOK=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_DEBUG=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_ALLOWLIST_WORKAROUND=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_LSM_SECURITY_HOOKS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CCACHE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BIC=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_HTCP=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_MAX=256" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NET=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LTO_CLANG_THIN=y" >> arch/arm64/configs/gki_defconfig
          echo "# CONFIG_LTO_CLANG_FULL is not set" >> arch/arm64/configs/gki_defconfig
          
          echo "CONFIG_LOCALVERSION=\"-deepongi\"" >> arch/arm64/configs/gki_defconfig
          
          # Remove ABI exports for WiFi fix
          rm -vf android/abi_gki_protected_exports_* || true
          
          echo "âœ“ Starting gki_defconfig with ld.lld at: $(which ld.lld)"
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld HOSTLD=ld.lld O=out gki_defconfig

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          
          # Set Clang path FIRST
          CLANG_BIN="${{ github.workspace }}/toolchain/clang/bin"
          export PATH="$CLANG_BIN:$PATH"
          
          # Verify ld.lld
          if [ ! -f "$CLANG_BIN/ld.lld" ]; then
            echo "::error::ld.lld not found at $CLANG_BIN/ld.lld"
            exit 1
          fi
          
          echo "âœ“ ld.lld path: $(which ld.lld)"
          echo "âœ“ ld.lld version: $(ld.lld --version | head -1)"
          
          # Set toolchain vars
          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}
          
          make -j$(nproc) \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}" \
            CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
            CC="ccache clang" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            2>&1 | tee build.log
          
          if [ ! -f out/arch/arm64/boot/Image.gz ] && [ ! -f arch/arm64/boot/Image.gz ]; then
            echo "Kernel build failed!"
            exit 1
          fi
          
          echo "Kernel built successfully"

      - name: Prepare AnyKernel3
        run: |
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git
          
          if [ -f ../kernel/out/arch/arm64/boot/Image.gz ]; then
            cp ../kernel/out/arch/arm64/boot/Image.gz ./
          elif [ -f ../kernel/arch/arm64/boot/Image.gz ]; then
            cp ../kernel/arch/arm64/boot/Image.gz ./
          fi
          
          if [ -f ../kernel/out/arch/arm64/boot/dtbo.img ]; then
            cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          elif [ -f ../kernel/arch/arm64/boot/dtbo.img ]; then
            cp ../kernel/arch/arm64/boot/dtbo.img ./
          fi
          
          if [ -f ../kernel/out/arch/arm64/boot/dtb ]; then
            cp ../kernel/out/arch/arm64/boot/dtb ./
          elif [ -f ../kernel/arch/arm64/boot/dtb ]; then
            cp ../kernel/arch/arm64/boot/dtb ./
          fi

      - name: Package Kernel
        run: |
          cd AnyKernel3
          VERSION="$(cat ../kernel/include/config/kernel.release 2>/dev/null || echo "6.1.145")"
          DATE="$(date +%Y%m%d)"
          ZIP_NAME="GKI-KernelSU-SuSFS-$VERSION-$DATE.zip"
          
          zip -r9 "../$ZIP_NAME" * -x .git README.md ./*placeholder
          cd ..
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          
          echo "âœ… Kernel packaged: $ZIP_NAME"
          ls -lh "$ZIP_NAME"

      - name: Upload Kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP }}
          path: ${{ env.KERNEL_ZIP }}

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel Build ${{ github.run_number }}
          body: |
            ## ðŸŽ‰ GKI Kernel Build
            
            **Kernel Version:** 6.1.145
            **Branch:** android14-6.1-2025-09
            **KernelSU:** Integrated from https://github.com/tiann/KernelSU
            **SuSFS:** Integrated from https://gitlab.com/simonpunk/susfs4ksu.git
            **Toolchain:** Custom
            
            ### Features
            - âœ… KernelSU main
            - âœ… SuSFS gki-android14-6.1
            - âœ… LTO: ThinLTO
            - âœ… Custom defconfig modifications applied
            
            ### Installation
            1. Download the kernel ZIP
            2. Boot to recovery
            3. Flash the ZIP
            4. Reboot and enjoy!
          files: |
            ${{ env.KERNEL_ZIP }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
